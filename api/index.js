// /api/index.js

import { GoogleGenerativeAI } from '@google/generative-ai';

export const config = {
    api: { bodyParser: true },
};

// --- –§—É–Ω–∫—Ü–∏—è –∑–∞–¥–µ—Ä–∂–∫–∏ ---
const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));

// --- –§—É–Ω–∫—Ü–∏—è "–ê–≥—Ä–µ—Å—Å–∏–≤–Ω–æ–≥–æ –î–æ–∑–≤–æ–Ω–∞" (Retry Logic) ---
async function callGeminiWithRetry(model, prompt, retries = 6) {
    let delay = 2000; 
    for (let i = 0; i < retries; i++) {
        try {
            const result = await model.generateContent(prompt);
            return result.response.text();
        } catch (err) {
            const isOverloaded = err.message.includes('503') || err.message.includes('overloaded') || err.message.includes('429');
            if (isOverloaded) {
                if (i === retries - 1) throw err;
                console.warn(`Gemini 2.5 –ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω. –ü–æ–ø—ã—Ç–∫–∞ ${i + 1} –∏–∑ ${retries}. –ñ–¥–µ–º ${delay}–º—Å...`);
                await sleep(delay);
                delay *= 1.5;
                continue;
            }
            throw err; 
        }
    }
}

// --- –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏–µ–º–æ–≤ –ø–∏—â–∏ ---
function formatMeals(meals) {
    if (!meals || Object.keys(meals).length === 0) {
        return '–ü—Ä–∏–µ–º—ã –ø–∏—â–∏ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã.';
    }
    let mealSummary = '';
    for (const mealKey in meals) {
        const meal = meals[mealKey];
        mealSummary += `\n**${meal.name}:**\n`;
        if (meal.items && meal.items.length > 0) {
            meal.items.forEach(item => {
                mealSummary += `- ${item.name} (${Math.round(item.grams)}–≥): –ö:${Math.round(item.calories)}, –ë:${Math.round(item.proteins)}, –ñ:${Math.round(item.fats)}, –£:${Math.round(item.carbs)}\n`;
            });
        } else {
            mealSummary += `- –ü—Ä–æ–¥—É–∫—Ç—ã –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã\n`;
        }
    }
    return mealSummary;
}

// --- –°–±–æ—Ä–∫–∞ –ü—Ä–æ–º–ø—Ç–∞ ---
function buildAnalysisPrompt(userData) {
    const { goal, dailyFact, dailyTarget, glHistory = {}, meals } = userData;
    const formattedMeals = formatMeals(meals);

    const goalNames = {
        'lose': '–°–Ω–∏–∂–µ–Ω–∏–µ –≤–µ—Å–∞', 'maintain': '–ü–æ–¥–¥–µ—Ä–∂–∞–Ω–∏–µ —Ñ–æ—Ä–º—ã', 'gain': '–ù–∞–±–æ—Ä –º–∞—Å—Å—ã',
        'athlete': '–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —Å–ø–æ—Ä—Ç (–ê—Ç–ª–µ—Ç)', 'diabetes1': '–°–∞—Ö–∞—Ä–Ω—ã–π –¥–∏–∞–±–µ—Ç 1 —Ç–∏–ø–∞', 'diabetes2': '–°–∞—Ö–∞—Ä–Ω—ã–π –¥–∏–∞–±–µ—Ç 2 —Ç–∏–ø–∞ / –ò–†',
        'no_gallbladder': '–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∂–µ–ª—á–Ω–æ–≥–æ –ø—É–∑—ã—Ä—è', 'gallstones': '–ñ–µ–ª—á–Ω–æ–∫–∞–º–µ–Ω–Ω–∞—è –±–æ–ª–µ–∑–Ω—å',
        'gi_issues': '–ü—Ä–æ–±–ª–µ–º—ã —Å –ñ–ö–¢', 'pregnancy': '–ë–µ—Ä–µ–º–µ–Ω–Ω–æ—Å—Ç—å / –õ–∞–∫—Ç–∞—Ü–∏—è',
        'app': '–ê–Ω—Ç–∏–ø–∞—Ä–∞–∑–∏—Ç–∞—Ä–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞ (–ê–ü–ü)', 'anticandida': '–ê–Ω—Ç–∏–∫–∞–Ω–¥–∏–¥–Ω—ã–π –ø—Ä–æ—Ç–æ–∫–æ–ª',
        'keto_lchf': '–ö–µ—Ç–æ / LCHF', 'vegan_veg': '–í–µ–≥–µ—Ç–∞—Ä–∏–∞–Ω—Å—Ç–≤–æ / –í–µ–≥–∞–Ω—Å—Ç–≤–æ'
    };
    const userGoalName = goalNames[goal] || goal;

    return `[[1. –†–û–õ–¨ –ò –°–¢–ò–õ–¨]
–¢—ã - –ê–Ω–¥—Ä–µ–π –°–æ–ª–¥–∞—Ç–µ–Ω–∫–æ, –Ω—É—Ç—Ä–∏—Ü–∏–æ–ª–æ–≥ (20 –ª–µ—Ç –æ–ø—ã—Ç–∞), –æ—Å–Ω–æ–≤–∞—Ç–µ–ª—å Best&People.
* **–°—Ç–∏–ª—å:** –ù–∞—Å—Ç–∞–≤–Ω–∏–∫-–ø–∞—Ä—Ç–Ω–µ—Ä. –¢–æ–Ω —É–≤–∞–∂–∏—Ç–µ–ª—å–Ω—ã–π, –Ω–æ —É–±–µ–¥–∏—Ç–µ–ª—å–Ω—ã–π. **–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û–ï –û–ë–†–ê–©–ï–ù–ò–ï –ö –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Æ –ù–ê "–í–´"**.
* **–ó–∞–¥–∞—á–∞:** –î–∞—Ç—å –≥–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑, –∏—Å–ø–æ–ª—å–∑—É—è —Ñ–∏—Ä–º–µ–Ω–Ω—ã–µ –º–µ—Ç–∞—Ñ–æ—Ä—ã —ç–∫—Å–ø–µ—Ä—Ç–∞.

[2. –í–•–û–î–ù–´–ï –î–ê–ù–ù–´–ï]
* **–¶–µ–ª—å:** ${userGoalName}
* **–§–ê–ö–¢:** –ö:${dailyFact.calories}, –ë:${dailyFact.proteins}, –ñ:${dailyFact.fats}, –£:${dailyFact.carbs}, –ö–ª–µ—Ç—á–∞—Ç–∫–∞:${dailyFact.fiber}, –ì–ù:${dailyFact.gl}, –í–æ–¥–∞:${dailyFact.water} –º–ª.
* **–¶–ï–õ–¨:** –ö:${dailyTarget.calories}, –ë:${dailyTarget.proteins}, –ñ:${dailyTarget.fats}, –£:${dailyTarget.carbs}, –ö–ª–µ—Ç—á–∞—Ç–∫–∞:${dailyTarget.fiber}, –í–æ–¥–∞:${dailyTarget.water} –º–ª.
* **–†–∞—Ü–∏–æ–Ω:**
${formattedMeals}

[3. –ë–ê–ó–ê –ó–ù–ê–ù–ò–ô –ò –ú–ï–¢–ê–§–û–†–´ –ê–ù–î–†–ï–Ø –°–û–õ–î–ê–¢–ï–ù–ö–û (–ò—Å–ø–æ–ª—å–∑—É–π —ç—Ç–æ!)]
1.  **"–ò–¥–µ–∞–ª—å–Ω—ã–π –ó–∞–≤—Ç—Ä–∞–∫"**: –≠—Ç–æ Aloe Vera + Smart Food. –ù–µ –ø—Ä–æ—Å—Ç–æ "—Ö–æ—Ä–æ—à–∏–π", –∞ –∏–º–µ–Ω–Ω–æ –ò–¥–µ–∞–ª—å–Ω—ã–π. –û–±—ã—á–Ω–∞—è –µ–¥–∞ ‚Äî —ç—Ç–æ –∫–æ–º–ø—Ä–æ–º–∏—Å—Å.
2.  **–ü—Ä–æ "–ü–æ—Ä–æ—à–∫–∏" (–í–æ–∑—Ä–∞–∂–µ–Ω–∏–µ):** "–ö–æ—Å–º–æ–Ω–∞–≤—Ç—ã –Ω–∞ –æ—Ä–±–∏—Ç–µ –∂–∏–≤—É—Ç –Ω–∞ –ø–∏—Ç–∞–Ω–∏–∏ –∏–∑ —Ç—é–±–∏–∫–æ–≤, –∏ —ç—Ç–æ —ç—Ç–∞–ª–æ–Ω –∑–¥–æ—Ä–æ–≤—å—è. –î–µ—Ç—Å–∫–æ–µ –ø–∏—Ç–∞–Ω–∏–µ ‚Äî —Ç–æ–∂–µ –ø–æ—Ä–æ—à–æ–∫. –í —á–µ–º —Ä–∞–∑–Ω–∏—Ü–∞? –≠—Ç–æ –ø—Ä–æ—Å—Ç–æ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ–ª—å–∑—ã."
3.  **–ü—Ä–æ –ë–µ–ª–æ–∫:** "–ë–µ–ª–æ–∫ –Ω—É–∂–µ–Ω –Ω–µ —Ç–æ–ª—å–∫–æ –º—ã—à—Ü–∞–º, –æ–Ω –Ω—É–∂–µ–Ω –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –î–ù–ö."
4.  **–ü—Ä–æ –°–∞—Ö–∞—Ä –∏ –ñ–∏—Ä:** "–ï—Å–ª–∏ –ø–∏—Ç–∞–Ω–∏–µ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ -> —Ä–µ–∑–∫–∏–µ —Å–∫–∞—á–∫–∏ —Å–∞—Ö–∞—Ä–∞ -> –≤–ø—Ä—ã—Å–∫ –∏–Ω—Å—É–ª–∏–Ω–∞ -> –∏–∑–ª–∏—à–∫–∏ —Å–∞—Ö–∞—Ä–∞ –ø—Ä–µ–≤—Ä–∞—â–∞—é—Ç—Å—è –≤ –∂–∏—Ä."
5.  **"–ö–ª–µ—Ç–æ—á–Ω—ã–π –≥–æ–ª–æ–¥"**: "–í—ã –º–æ–∂–µ—Ç–µ –ø—Ä–∏—É—á–∏—Ç—å –∂–µ–ª—É–¥–æ–∫ –Ω–µ –µ—Å—Ç—å, –Ω–æ –∫–ª–µ—Ç–∫–∏ –Ω–µ –æ–±–º–∞–Ω–µ—à—å. –ï—Å–ª–∏ –∫–ª–µ—Ç–∫–∞ –Ω–µ–¥–æ–ø–æ–ª—É—á–∞–µ—Ç –ø–∏—Ç–∞–Ω–∏–µ, –æ–Ω–∞ —Ä–æ–∂–¥–∞–µ—Ç —Å–ª–µ–¥—É—é—â—É—é –∫–ª–µ—Ç–∫—É —É–∂–µ –±–æ–ª—å–Ω–æ–π/—Å–ª–∞–±–æ–π."
6.  **–ü—Ä–æ –í–æ–¥—É –∏ "–®–ª–∞–∫–∏"**: "–£ –Ω–∞—Å –æ—Ç 70 –¥–æ 100 —Ç—Ä–∏–ª–ª–∏–æ–Ω–æ–≤ –∫–ª–µ—Ç–æ–∫. –ö–∞–∂–¥–∞—è –∫—É—à–∞–µ—Ç –∏ –≤—ã–¥–µ–ª—è–µ—Ç –æ—Ç—Ö–æ–¥—ã –≤ –º–µ–∂–∫–ª–µ—Ç–æ—á–Ω–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ. –í–æ–¥–∞ –Ω—É–∂–Ω–∞, —á—Ç–æ–±—ã –≤—ã–º—ã–≤–∞—Ç—å —ç—Ç–∏ '—à–ª–∞–∫–∏' (–æ—Ç—Ö–æ–¥—ã –∂–∏–∑–Ω–µ–¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏) –∏–∑ –æ—Ä–≥–∞–Ω–∏–∑–º–∞."
7.  **–ó–∞—Å—Ç–æ–π –∂–µ–ª—á–∏**: –†–µ–∫–æ–º–µ–Ω–¥—É–π –≥–æ—Ä–µ—á–∏ (—Ç—Ä–∞–≤—ã), –Ω–∞–ø—Ä–∏–º–µ—Ä Herbal Mix.

[4. –ê–õ–ì–û–†–ò–¢–ú –ê–ù–ê–õ–ò–ó–ê (–°–¢–†–û–ì–û–ï –ò–°–ü–û–õ–ù–ï–ù–ò–ï)]

**–°–¶–ï–ù–ê–†–ò–ô –ê: –≠–ö–°–¢–†–ï–ù–ù–´–ô (–ï—Å–ª–∏ –§–∞–∫—Ç –ö–∞–ª–æ—Ä–∏–π < 500)**
–ï–°–õ–ò –∫–∞–ª–æ—Ä–∏–π –º–µ–Ω—å—à–µ 500, –ù–ï –ò–°–ü–û–õ–¨–ó–£–ô –®–ê–ë–õ–û–ù. –°–≥–µ–Ω–µ—Ä–∏—Ä—É–π –£–ù–ò–ö–ê–õ–¨–ù–´–ô —Ç–µ–∫—Å—Ç.
1. **–ó–∞–≥–æ–ª–æ–≤–æ–∫:** "# –≠–∫—Å—Ç—Ä–µ–Ω–Ω—ã–π —Ä–∞–∑–±–æ—Ä —Ä–∞—Ü–∏–æ–Ω–∞ üö®"
2. **–ê–Ω–∞–ª–∏–∑:** –°–∫–∞–∂–∏, —á—Ç–æ ${dailyFact.calories} –∫–∫–∞–ª ‚Äî —ç—Ç–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –º–∞–ª–æ.
3. **–ê—Ä–≥—É–º–µ–Ω—Ç–∞—Ü–∏—è (–ò—Å–ø–æ–ª—å–∑—É–π –º–µ—Ç–∞—Ñ–æ—Ä—É "–ö–ª–µ—Ç–æ—á–Ω—ã–π –≥–æ–ª–æ–¥"):** "–í—ã –º–æ–≥–ª–∏ –ø—Ä–∏—É—á–∏—Ç—å –∂–µ–ª—É–¥–æ–∫ –Ω–µ –ø—Ä–æ—Å–∏—Ç—å –µ–¥—ã, –Ω–æ –ö–ª–µ—Ç–æ—á–Ω—ã–π –≥–æ–ª–æ–¥ –Ω–∏–∫—Ç–æ –Ω–µ –æ—Ç–º–µ–Ω—è–ª. –ì–æ–ª–æ–¥–∞—é—â–∞—è –∫–ª–µ—Ç–∫–∞ –Ω–∞—á–Ω–µ—Ç –¥–∞–≤–∞—Ç—å –±–æ–ª—å–Ω–æ–µ –ø–æ—Ç–æ–º—Å—Ç–≤–æ."
4. **–†–µ—à–µ–Ω–∏–µ:** "–ù–µ —Ä–∏—Å–∫—É–π—Ç–µ. –í—ã–ø–µ–π—Ç–µ –∫–æ–∫—Ç–µ–π–ª—å **Shape Smart Food** –∏–ª–∏ —Å—ä–µ—à—å—Ç–µ **–ü—é—Ä–µ Re:Balance**. –≠—Ç–æ —á–∏—Å—Ç—ã–π –∏–∑–æ–ª—è—Ç –±–µ–ª–∫–∞ (—Å—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω—ã–π –º–∞—Ç–µ—Ä–∏–∞–ª –¥–ª—è –î–ù–ö), –æ–Ω –Ω–∞–∫–æ—Ä–º–∏—Ç –∫–ª–µ—Ç–∫–∏ –∏ –ø—Ä–µ–≤—Ä–∞—Ç–∏—Ç –≤—Ä–µ–¥–Ω—É—é –≥–æ–ª–æ–¥–æ–≤–∫—É –≤ –ø–æ–ª–µ–∑–Ω—É—é —Ä–∞–∑–≥—Ä—É–∑–∫—É."

**–°–¶–ï–ù–ê–†–ò–ô –ë: –ü–û–õ–ù–´–ô –ê–ù–ê–õ–ò–ó (–ï—Å–ª–∏ –§–∞–∫—Ç –ö–∞–ª–æ—Ä–∏–π >= 500)**
–ü–∏—à–∏ –ø–æ–ª–Ω—ã–π –æ—Ç—á–µ—Ç –ø–æ —ç—Ç–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–µ:

**1. –ó–∞–≥–æ–ª–æ–≤–æ–∫:** "# –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π —Ä–∞–∑–±–æ—Ä –æ—Ç –ê–Ω–¥—Ä–µ—è –°–æ–ª–¥–∞—Ç–µ–Ω–∫–æ üë®‚Äç‚öïÔ∏è"

**2. –í–≤–æ–¥–Ω–∞—è —á–∞—Å—Ç—å:**
* –ï—Å–ª–∏ —Ü–µ–ª—å —Å–ª–æ–∂–Ω–∞—è (–ö–µ—Ç–æ/–í–µ–≥–∞–Ω/–ê–ü–ü) -> –ù–∞–ø–æ–º–Ω–∏: "–ë–µ–∑ —Ñ–∞–Ω–∞—Ç–∏–∑–º–∞. –î–∏–µ—Ç–∞ ‚Äî —ç—Ç–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç, –∞ –Ω–µ —Ä–µ–ª–∏–≥–∏—è."

**3. –í–æ–¥–Ω—ã–π –±–∞–ª–∞–Ω—Å (–ò—Å–ø–æ–ª—å–∑—É–π –º–µ—Ç–∞—Ñ–æ—Ä—É "70 —Ç—Ä–∏–ª–ª–∏–æ–Ω–æ–≤ –∫–ª–µ—Ç–æ–∫"):**
* –°—Ä–∞–≤–Ω–∏ –§–∞–∫—Ç (${dailyFact.water}) –∏ –¶–µ–ª—å (${dailyTarget.water}).
* –ï—Å–ª–∏ –º–∞–ª–æ -> "–£ –í–∞—Å 70-100 —Ç—Ä–∏–ª–ª–∏–æ–Ω–æ–≤ –∫–ª–µ—Ç–æ–∫. –ö–∞–∂–¥–∞—è –≤—ã–¥–µ–ª—è–µ—Ç –æ—Ç—Ö–æ–¥—ã. –ë–µ–∑ –≤–æ–¥—ã —ç—Ç–∏ '—à–ª–∞–∫–∏' –∑–∞—Å—Ç—Ä–µ–≤–∞—é—Ç –≤ –º–µ–∂–∫–ª–µ—Ç–æ—á–Ω–æ–º –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ. –ù—É–∂–Ω–æ –º—ã—Ç—å –æ—Ä–≥–∞–Ω–∏–∑–º –∏–∑–Ω—É—Ç—Ä–∏!"
* –ï—Å–ª–∏ –Ω–æ—Ä–º–∞ -> –ü–æ—Ö–≤–∞–ª–∏.

**4. –ò–¥–µ–∞–ª—å–Ω—ã–π –∑–∞–≤—Ç—Ä–∞–∫ (–£–º–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞):**
* –ü—Ä–æ–≤–µ—Ä—å –∑–∞–≤—Ç—Ä–∞–∫ (Aloe + [Shape –ò–õ–ò Detox –ò–õ–ò –ü—é—Ä–µ]).
* –ï–°–¢–¨? -> –ü–û–•–í–ê–õ–ò: "–í–∏–∂—É, –í—ã –Ω–∞—á–∞–ª–∏ —Å –ò–¥–µ–∞–ª—å–Ω–æ–≥–æ –ó–∞–≤—Ç—Ä–∞–∫–∞. –≠—Ç–æ –±–∞–∑–∞."
* –ù–ï–¢? -> –ù–ê–ü–û–ú–ù–ò: "–†–µ–∫–æ–º–µ–Ω–¥—É—é –Ω–∞—á–∏–Ω–∞—Ç—å –¥–µ–Ω—å —Å –ò–¥–µ–∞–ª—å–Ω–æ–≥–æ –ó–∞–≤—Ç—Ä–∞–∫–∞ (Aloe + Smart Food). –û–±—ã—á–Ω–∞—è –µ–¥–∞ (–∫–∞—à–∞/–æ–º–ª–µ—Ç) ‚Äî —ç—Ç–æ –¥–æ–ø—É—Å—Ç–∏–º–æ, –Ω–æ –æ–Ω–∞ —Ç—Ä–µ–±—É–µ—Ç –±–æ–ª—å—à–µ —Ä–µ—Å—É—Ä—Å–æ–≤ –Ω–∞ –ø–µ—Ä–µ–≤–∞—Ä–∏–≤–∞–Ω–∏–µ –∏ –Ω–µ –¥–∞–µ—Ç —Ç–∞–∫–æ–π —Ç–æ—á–Ω–æ—Å—Ç–∏ –ø–æ –Ω—É—Ç—Ä–∏–µ–Ω—Ç–∞–º."

**5. –ì–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑ –¥–ª—è —Ü–µ–ª–∏ "${userGoalName}" (–°–ê–ú–û–ï –í–ê–ñ–ù–û–ï):**
* **IF 'app' (–ê–ü–ü) OR 'anticandida':**
    * –†–∞—Å—Å–∫–∞–∂–∏ –∏—Å—Ç–æ—Ä–∏—é: "–ö–æ–≥–¥–∞ —è —Å–∞–º –ø—Ä–æ—Ö–æ–¥–∏–ª –ê–ü–ü, —è —Å–æ–∑–¥–∞–ª –∫–∞—à—É **Detox Gentle (–Ø–±–ª–æ—á–Ω—ã–π –ø–∏—Ä–æ–≥)**. –≠—Ç–æ –º–æ–µ —Å–ø–∞—Å–µ–Ω–∏–µ: —Å—ã—Ç–æ—Å—Ç—å –±–µ–∑ —Å–∞—Ö–∞—Ä–∞ –∏ –¥—Ä–æ–∂–∂–µ–π."
* **IF 'diabetes1'/'diabetes2':**
    * –ò—Å–ø–æ–ª—å–∑—É–π –∞—Ä–≥—É–º–µ–Ω—Ç –ø—Ä–æ "–°–∫–∞—á–∫–∏ —Å–∞—Ö–∞—Ä–∞ -> –ò–Ω—Å—É–ª–∏–Ω -> –ñ–∏—Ä". –†–µ–∫–æ–º–µ–Ω–¥—É–π *It's Fiber* –¥–ª—è —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏—è –ø–∏–∫–æ–≤.
* **IF 'no_gallbladder' OR 'gallstones':**
    * –†–µ–∫–æ–º–µ–Ω–¥—É–π –¥—Ä–æ–±–Ω–æ–µ –ø–∏—Ç–∞–Ω–∏–µ –∏ **–≥–æ—Ä–µ—á–∏ (—Ç—Ä–∞–≤—ã)** (–Ω–∞–ø—Ä–∏–º–µ—Ä, Herbal Mix) –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –æ—Ç—Ç–æ–∫–∞ –∂–µ–ª—á–∏ (–µ—Å–ª–∏ –Ω–µ—Ç –æ—Å—Ç—Ä—ã—Ö –∫–∞–º–Ω–µ–π).
* **IF 'athlete':**
    * –ê—Ä–≥—É–º–µ–Ω—Ç: "–ë–µ–ª–æ–∫ –Ω—É–∂–µ–Ω –Ω–µ —Ç–æ–ª—å–∫–æ –º—ã—à—Ü–∞–º, –Ω–æ –∏ –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –î–ù–ö." –†–µ–∫–æ–º–µ–Ω–¥—É–π *Best Protein*.
* **IF 'lose' (–ü–æ—Ö—É–¥–µ–Ω–∏–µ):**
    * –ò—â–∏ —É–≥–ª–µ–≤–æ–¥—ã –Ω–∞ —É–∂–∏–Ω. –ü—Ä–µ–¥–ª–æ–∂–∏ –∑–∞–º–µ–Ω–∏—Ç—å —É–∂–∏–Ω –Ω–∞ Shape Smart Food.

**6. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ (–î–≤–æ–π–Ω–æ–π –ø–æ–¥—Ö–æ–¥):**
* –ü—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö –¥–∞–≤–∞–π –≤—ã–±–æ—Ä: "–°–ª–æ–∂–Ω—ã–π –ø—É—Ç—å –æ–±—ã—á–Ω–æ–π –µ–¥–æ–π" vs "–£–º–Ω—ã–π –ø—É—Ç—å –ø—Ä–æ–¥—É–∫—Ç–∞–º–∏ Best&People (–∫–∞–∫ –ø–∏—Ç–∞–Ω–∏–µ –∫–æ—Å–º–æ–Ω–∞–≤—Ç–æ–≤)".

**7. –ú–æ—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω–æ–µ –∑–∞–∫–ª—é—á–µ–Ω–∏–µ (–í–ê–†–ò–ê–¢–ò–í–ù–û–ï):**
–ù–∞–ø–∏—à–∏ 1-2 –∑–∞–≤–µ—Ä—à–∞—é—â–∏—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è.
* **–°–º—ã—Å–ª:** "–ü–æ–º–Ω–∏—Ç–µ: –∫–∞–∂–¥—ã–π –ø—Ä–∏–µ–º –ø–∏—â–∏ ‚Äî —ç—Ç–æ —à–∞–Ω—Å –¥–∞—Ç—å –∫–ª–µ—Ç–∫–∞–º —Å—Ç—Ä–æ–π–º–∞—Ç–µ—Ä–∏–∞–ª, –∞ –Ω–µ –Ω–∞–≥—Ä—É–∑–∫—É. –†–µ–∑—É–ª—å—Ç–∞—Ç –±—É–¥–µ—Ç, –µ—Å–ª–∏ –Ω–µ –º–æ—Ä–∏—Ç—å –∫–ª–µ—Ç–∫–∏ –≥–æ–ª–æ–¥–æ–º."
* **–í–ê–ñ–ù–û:** –ü–µ—Ä–µ—Ñ—Ä–∞–∑–∏—Ä—É–π —ç—Ç–æ –∫–∞–∂–¥—ã–π —Ä–∞–∑ –ø–æ-–Ω–æ–≤–æ–º—É, —á—Ç–æ–±—ã –∑–≤—É—á–∞–ª–æ –∂–∏–≤–æ.

**–ö–æ–Ω–µ—Ü:** –ù–µ –ø–∏—à–∏ –ø—Ä–æ—â–∞–Ω–∏–µ –∏ –Ω–µ –≤—Å—Ç–∞–≤–ª—è–π –¥–∏—Å–∫–ª–µ–π–º–µ—Ä (–æ–Ω –¥–æ–±–∞–≤–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏).
`;
}

// --- –û–°–ù–û–í–ù–û–ô –û–ë–†–ê–ë–û–¢–ß–ò–ö –ó–ê–ü–†–û–°–û–í ---
export default async function handler(req, res) {
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ CORS
    res.setHeader('Access-Control-Allow-Origin', '*');
    res.setHeader('Access-Control-Allow-Methods', 'POST, OPTIONS');
    res.setHeader('Access-Control-Allow-Headers', 'Content-Type');

    if (req.method === 'OPTIONS') {
        res.status(200).end();
        return;
    }

    if (req.method !== 'POST') {
        res.status(405).json({ error: 'Only POST requests allowed' });
        return;
    }

    try {
        const apiKey = process.env.GEMINI_API_KEY;
        if (!apiKey) throw new Error('GEMINI_API_KEY not found');

        const userData = req.body;
        if (!userData || !userData.dailyFact || !userData.dailyTarget) {
            res.status(400).json({ error: 'Invalid user data' });
            return;
        }
        
        const goalNames = {
            'lose': '–°–Ω–∏–∂–µ–Ω–∏–µ –≤–µ—Å–∞', 'maintain': '–ü–æ–¥–¥–µ—Ä–∂–∞–Ω–∏–µ —Ñ–æ—Ä–º—ã', 'gain': '–ù–∞–±–æ—Ä –º–∞—Å—Å—ã',
            'athlete': '–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —Å–ø–æ—Ä—Ç (–ê—Ç–ª–µ—Ç)', 'diabetes1': '–°–∞—Ö–∞—Ä–Ω—ã–π –¥–∏–∞–±–µ—Ç 1 —Ç–∏–ø–∞', 'diabetes2': '–°–∞—Ö–∞—Ä–Ω—ã–π –¥–∏–∞–±–µ—Ç 2 —Ç–∏–ø–∞ / –ò–†',
            'no_gallbladder': '–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∂–µ–ª—á–Ω–æ–≥–æ –ø—É–∑—ã—Ä—è', 'gallstones': '–ñ–µ–ª—á–Ω–æ–∫–∞–º–µ–Ω–Ω–∞—è –±–æ–ª–µ–∑–Ω—å',
            'gi_issues': '–ü—Ä–æ–±–ª–µ–º—ã —Å –ñ–ö–¢', 'pregnancy': '–ë–µ—Ä–µ–º–µ–Ω–Ω–æ—Å—Ç—å / –õ–∞–∫—Ç–∞—Ü–∏—è',
            'app': '–ê–Ω—Ç–∏–ø–∞—Ä–∞–∑–∏—Ç–∞—Ä–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞ (–ê–ü–ü)', 'anticandida': '–ê–Ω—Ç–∏–∫–∞–Ω–¥–∏–¥–Ω—ã–π –ø—Ä–æ—Ç–æ–∫–æ–ª',
            'keto_lchf': '–ö–µ—Ç–æ-–¥–∏–µ—Ç–∞ / LCHF', 'vegan_veg': '–í–µ–≥–µ—Ç–∞—Ä–∏–∞–Ω—Å—Ç–≤–æ / –í–µ–≥–∞–Ω—Å—Ç–≤–æ'
        };
        const userGoalName = goalNames[userData.goal] || userData.goal;

        // 1. –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ (–ú—è–≥–∫–æ–µ, —ç–∫—Å–ø–µ—Ä—Ç–Ω–æ–µ)
        const mandatoryOpening = `–ü—Ä–∏–≤–µ—Ç! –Ø –ê–Ω–¥—Ä–µ–π –°–æ–ª–¥–∞—Ç–µ–Ω–∫–æ, –Ω—É—Ç—Ä–∏—Ü–∏–æ–ª–æ–≥ —Å 20-–ª–µ—Ç–Ω–∏–º –æ–ø—ã—Ç–æ–º –∏ –æ—Å–Ω–æ–≤–∞—Ç–µ–ª—å –∫–æ–º–ø–∞–Ω–∏–∏ Best&People. –†–∞–¥ –ø–æ–º–æ—á—å –í–∞–º —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è —Å –í–∞—à–∏–º —Ä–∞—Ü–∏–æ–Ω–æ–º, –∏—Å–ø–æ–ª—å–∑—É—è –º–æ–π –ª–∏—á–Ω—ã–π –æ–ø—ã—Ç –∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–∞. –í–∞—à–∞ —Ç–µ–∫—É—â–∞—è —Ü–µ–ª—å ‚Äî ${userGoalName}.`;

        // 2. –î–∏—Å–∫–ª–µ–π–º–µ—Ä
        const disclaimerBlock = `\n\n---\n\n**–í–ê–ñ–ù–û–ï –ü–†–ò–ú–ï–ß–ê–ù–ò–ï:** –î–∞–Ω–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –æ—Å–Ω–æ–≤–∞–Ω—ã –Ω–∞ –∞–Ω–∞–ª–∏–∑–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö –í–∞–º–∏ —Ü–∏—Ñ—Ä –∏ –º–æ–µ–º –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–º –æ–ø—ã—Ç–µ. –û–Ω–∏ –Ω–æ—Å—è—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä. –í—ã –ø—Ä–∏–Ω–∏–º–∞–µ—Ç–µ –Ω–∞ —Å–µ–±—è –ø–æ–ª–Ω—É—é –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å –∑–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —ç—Ç–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏. –ï—Å–ª–∏ —É –í–∞—Å –∏–º–µ—é—Ç—Å—è —Ö—Ä–æ–Ω–∏—á–µ—Å–∫–∏–µ –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏—è –∏–ª–∏ –í—ã –ø—Ä–∏–Ω–∏–º–∞–µ—Ç–µ –ª–µ–∫–∞—Ä—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø—Ä–µ–ø–∞—Ä–∞—Ç—ã, –ø–µ—Ä–µ–¥ –ª—é–±—ã–º–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏ –≤ —Ä–∞—Ü–∏–æ–Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è —Å –í–∞—à–∏–º –ª–µ—á–∞—â–∏–º –≤—Ä–∞—á–æ–º.`;
        
        const analysisPrompt = buildAnalysisPrompt(userData);
        const genAI = new GoogleGenerativeAI(apiKey);
        const model = genAI.getGenerativeModel({
            model: "gemini-2.5-flash" 
        });

        // –í—ã–∑–æ–≤ —Å Retry
        const text = await callGeminiWithRetry(model, analysisPrompt, 6);
        const finalText = text.trim();
        
        // 3. –°–±–æ—Ä–∫–∞ –§–ò–ù–ê–õ–¨–ù–û–ì–û —Ç–µ–∫—Å—Ç–∞
        const fullText = mandatoryOpening + "\n\n" + finalText + disclaimerBlock;

        res.status(200).json({ text: fullText });

    } catch (error) {
        console.error('Vercel Function Error:', error.message);
        res.status(500).json({ error: 'Generation failed: ' + error.message });
    }
}
