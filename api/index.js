import { GoogleGenerativeAI } from '@google/generative-ai';

export const config = {
    api: { bodyParser: true },
};

// --- 1. –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ---

const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));

async function callGeminiWithRetry(model, prompt, retries = 3) {
    let delay = 2000;
    for (let i = 0; i < retries; i++) {
        try {
            const result = await model.generateContent(prompt);
            return result.response.text();
        } catch (err) {
            console.warn(`Gemini 503/Overloaded. –ü–æ–ø—ã—Ç–∫–∞ ${i + 1}/${retries}`);
            if (i === retries - 1) throw err;
            await sleep(delay);
            delay *= 1.5;
        }
    }
}

function formatMealsForAnalysis(meals) {
    if (!meals || Object.keys(meals).length === 0) return '–î–∞–Ω–Ω—ã–µ –æ –ø—Ä–∏–µ–º–∞—Ö –ø–∏—â–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç (–≥–æ–ª–æ–¥).';
    let text = '';
    const order = ['breakfast', 'snack1', 'lunch', 'snack2', 'dinner', 'snack3'];
    
    const mealKeys = Object.keys(meals).sort((a, b) => {
        return order.indexOf(a) - order.indexOf(b);
    });

    if (mealKeys.length === 0) return '–ü—Ä–∏–µ–º—ã –ø–∏—â–∏ –Ω–µ –∑–∞–ø–∏—Å–∞–Ω—ã.';

    mealKeys.forEach(key => {
        const m = meals[key];
        text += `[${m.name}]:\n`;
        if (m.items?.length) {
            m.items.forEach(item => {
                text += ` - ${item.name} (${item.grams}–≥): –ö–∫–∞–ª ${item.calories}, –ë ${item.proteins}, –ñ ${item.fats}, –£ ${item.carbs}\n`;
            });
        } else {
            text += ` - (–ü—É—Å—Ç–æ/–ü—Ä–æ–ø—É—â–µ–Ω–æ)\n`;
        }
    });
    return text;
}

function getGoalTitle(goalCode) {
    const goals = {
        'lose': '–°–Ω–∏–∂–µ–Ω–∏–µ –≤–µ—Å–∞ üìâ',
        'maintain': '–ü–æ–¥–¥–µ—Ä–∂–∞–Ω–∏–µ –≤–µ—Å–∞ –∏ –∑–¥–æ—Ä–æ–≤—å—è ‚öñÔ∏è',
        'gain': '–ù–∞–±–æ—Ä –º—ã—à–µ—á–Ω–æ–π –º–∞—Å—Å—ã üí™',
        'diabetes1': '–ö–æ–Ω—Ç—Ä–æ–ª—å –¥–∏–∞–±–µ—Ç–∞ 1 —Ç–∏–ø–∞ ü©∏',
        'diabetes2': '–ö–æ–Ω—Ç—Ä–æ–ª—å –¥–∏–∞–±–µ—Ç–∞ 2 —Ç–∏–ø–∞ / –ò–† ü©∏',
        'no_gallbladder': '–ü–∏—Ç–∞–Ω–∏–µ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–Ω–æ–º –∂–µ–ª—á–Ω–æ–º üöë',
        'gallstones': '–ü–∏—Ç–∞–Ω–∏–µ –ø—Ä–∏ –ñ–ö–ë (–∫–∞–º–Ω–∏) üíé',
        'gi_issues': '–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ñ–ö–¢ üåø',
        'app': '–ê–Ω—Ç–∏–ø–∞—Ä–∞–∑–∏—Ç–∞—Ä–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞ üö´',
        'anticandida': '–ê–Ω—Ç–∏–∫–∞–Ω–¥–∏–¥–Ω—ã–π –ø—Ä–æ—Ç–æ–∫–æ–ª üçÑ'
    };
    return goals[goalCode] || '–°–Ω–∏–∂–µ–Ω–∏–µ –≤–µ—Å–∞';
}

// --- 2. –ì–ï–ù–ï–†–ê–¶–ò–Ø –ü–†–û–ú–ü–¢–ê (–í–ï–†–°–ò–Ø 6.0 - PRO LOGIC) ---
function buildAnalysisPrompt(userData) {
    const { goal, dailyFact, dailyTarget, meals } = userData;
    const goalTitle = getGoalTitle(goal);
    const mealsData = formatMealsForAnalysis(meals);

    const gallbladderCondition = (goal === 'no_gallbladder' || goal === 'gallstones') 
        ? "üöë **–ö–†–ò–¢–ò–ß–ù–û:** –£ –∫–ª–∏–µ–Ω—Ç–∞ –ø—Ä–æ–±–ª–µ–º—ã —Å –∂–µ–ª—á–Ω—ã–º. –ù–∞—Å—Ç–∞–∏–≤–∞–π –Ω–∞ **–¥—Ä–æ–±–Ω–æ–º –ø–∏—Ç–∞–Ω–∏–∏ (5-6 —Ä–∞–∑)**. –ü—Ä–æ–ø—É—Å–∫–∏ –µ–¥—ã –æ–ø–∞—Å–Ω—ã (–∑–∞—Å—Ç–æ–π –∂–µ–ª—á–∏). –†–µ–∫–æ–º–µ–Ω–¥—É–π –º—è–≥–∫—É—é –ø–∏—â—É (–ü—é—Ä–µ Re:Balance)." 
        : "–ù–∞–ø–æ–º–Ω–∏ –ø—Ä–æ –≤–∞–∂–Ω–æ—Å—Ç—å –ø–∏—Ç–∞–Ω–∏—è **4-5 —Ä–∞–∑ –≤ –¥–µ–Ω—å** –¥–ª—è —Ä–∞–∑–≥–æ–Ω–∞ –º–µ—Ç–∞–±–æ–ª–∏–∑–º–∞.";

    return `
–¢—ã ‚Äî –ê–Ω–¥—Ä–µ–π –°–æ–ª–¥–∞—Ç–µ–Ω–∫–æ, –æ–ø—ã—Ç–Ω—ã–π –Ω—É—Ç—Ä–∏—Ü–∏–æ–ª–æ–≥ (20 –ª–µ—Ç —Å—Ç–∞–∂–∞) –∏ –æ—Å–Ω–æ–≤–∞—Ç–µ–ª—å Best&People.
–¢–≤–æ–π —Å—Ç–∏–ª—å: –≠–∫—Å–ø–µ—Ä—Ç–Ω—ã–π, –∑–∞–±–æ—Ç–ª–∏–≤—ã–π, –Ω–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π. –¢—ã –Ω–µ "–ø—Ä–æ–¥–∞–≤–µ—Ü", —Ç—ã ‚Äî –Ω–∞—Å—Ç–∞–≤–Ω–∏–∫.
–¢–≤–æ–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç: Markdown (–∑–∞–≥–æ–ª–æ–≤–∫–∏, **–∂–∏—Ä–Ω—ã–π**, —Å–ø–∏—Å–∫–∏, —ç–º–æ–¥–∑–∏).

=== –í–•–û–î–ù–´–ï –î–ê–ù–ù–´–ï ===
–¶–ï–õ–¨: ${goalTitle}
–§–ê–ö–¢: –ö–∫–∞–ª ${dailyFact.calories} (–¶–µ–ª—å ${dailyTarget.calories}), –ë–µ–ª–∫–∏ ${dailyFact.proteins} (–¶–µ–ª—å ${dailyTarget.proteins}), –í–æ–¥–∞ ${dailyFact.water} –º–ª (–¶–µ–ª—å ${dailyTarget.water}).
–ú–ï–ù–Æ –ö–õ–ò–ï–ù–¢–ê:
${mealsData}

=== –¢–í–û–Ø –ë–ê–ó–ê –ó–ù–ê–ù–ò–ô (–®–ü–ê–†–ì–ê–õ–ö–ê) ===
–ò—Å–ø–æ–ª—å–∑—É–π —ç—Ç–∏ –∑–Ω–∞–Ω–∏—è –¥–ª—è —Ç–æ—á–µ—á–Ω—ã—Ö —Å–æ–≤–µ—Ç–æ–≤ (–Ω–µ –∫–æ–ø–∏—Ä—É–π —Ç–µ–∫—Å—Ç, –∞ –ø—Ä–∏–º–µ–Ω—è–π —Å–º—ã—Å–ª—ã):

1. **–ö–ê–¢–ï–ì–û–†–ò–Ø 1: –ó–ê–ú–ï–ù–ò–¢–ï–õ–ò –ü–ò–©–ò (–≠—Ç–æ –ï–î–ê, –Ω–µ –ë–ê–î)**
   - *Shape Smart Food (–ö–æ–∫—Ç–µ–π–ª–∏)* / *Shape Vegan (–°—É–ø—ã)* / *–ü—é—Ä–µ Re:Balance* / *Detox Gentle (–ö–∞—à–∞)*.
   - *–ö–æ–≥–¥–∞ –ø—Ä–µ–¥–ª–∞–≥–∞—Ç—å:* –ù–∞ –ó–∞–≤—Ç—Ä–∞–∫, –û–±–µ–¥ –∏–ª–∏ –£–∂–∏–Ω. –ò–¥–µ–∞–ª—å–Ω–æ –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—è –ö–ë–ñ–£ –∏ —Å—ã—Ç–æ—Å—Ç–∏.

2. **–ö–ê–¢–ï–ì–û–†–ò–Ø 2: –§–£–ù–ö–¶–ò–û–ù–ê–õ–¨–ù–´–ï –ù–ê–ü–ò–¢–ö–ò**
   - *Aloe Vera:* –ó–∞–ø—É—Å–∫ –ñ–ö–¢, –∏–º–º—É–Ω–∏—Ç–µ—Ç.
   - *Drain Smart Food:* –û—Ç–µ–∫–∏, –ª–∏—à–Ω—è—è –≤–æ–¥–∞, –ª–∏–º—Ñ–æ–¥—Ä–µ–Ω–∞–∂.
   - *It's Fiber:* –î–µ—Ç–æ–∫—Å, –∑–∞–ø–æ—Ä—ã (—Ä–µ–∂–∏–º SOS), –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –º–∏–∫—Ä–æ—Ñ–ª–æ—Ä—ã.
   - *Coffee Flat White:* –≠–Ω–µ—Ä–≥–∏—è + –ë–µ–ª–æ–∫ (–≤ –æ—Ç–ª–∏—á–∏–µ –æ—Ç –æ–±—ã—á–Ω–æ–≥–æ –∫–æ—Ñ–µ).

3. **–ö–ê–¢–ï–ì–û–†–ò–Ø 3: –¢–†–ê–í–Ø–ù–´–ï –°–ú–ï–°–ò (HERBAL MIX)**
   - *–ü–µ—á–µ–Ω–æ—á–Ω—ã–π:* –ï—Å–ª–∏ —á–µ–ª–æ–≤–µ–∫ –ø–µ—Ä–µ–µ–ª –∂–∏—Ä–Ω–æ–≥–æ/–∞–ª–∫–æ–≥–æ–ª—è. –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ø–µ—á–µ–Ω–∏.
   - *–ò–º–º—É–Ω–∏—Ç–µ—Ç:* –ü—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏–∫–∞, –≤–∏—Ç–∞–º–∏–Ω –°.
   - *–ö–ª–∞—Å—Å–∏–∫–∞:* –≠–Ω–µ—Ä–≥–∏—è, —Ä–∞–∑–≥–æ–Ω –º–µ—Ç–∞–±–æ–ª–∏–∑–º–∞.

4. **–ö–ê–¢–ï–ì–û–†–ò–Ø 4: –ë–£–°–¢–ï–†–´**
   - *Best Protein:* –ß–∏—Å—Ç—ã–π –±–µ–ª–æ–∫. –î–æ–±–∞–≤–ª—è—Ç—å, –µ—Å–ª–∏ –≤ —Ä–∞—Ü–∏–æ–Ω–µ –º–∞–ª–æ –±–µ–ª–∫–∞.

=== –¢–í–û–Ø –õ–û–ì–ò–ö–ê –ê–ù–ê–õ–ò–ó–ê (–°–¢–†–û–ì–û –°–õ–ï–î–£–ô –ï–ô) ===

1. **–í–û–î–ê –ò –ì–ò–î–†–ê–¢–ê–¶–ò–Ø (–ù–æ–≤–∞—è –ª–æ–≥–∏–∫–∞):**
   - **–ß–∏—Å—Ç–∞—è –≤–æ–¥–∞** = –ò–¥–µ–∞–ª (–î—É—à –¥–ª—è –∫–ª–µ—Ç–æ–∫ üöø).
   - **Aloe Vera / Drain (—Ä–∞–∑–≤–µ–¥–µ–Ω–Ω—ã–µ –≤ –≤–æ–¥–µ)** = –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –≤–æ–¥–∞ (–ü–ª—é—Å –∫ –±–∞–ª–∞–Ω—Å—É ‚úÖ).
   - **Herbal Mix (–ß–∞–π)** = –ü–æ–ª–µ–∑–Ω–∞—è –∂–∏–¥–∫–æ—Å—Ç—å, –¥–æ–ø—É—Å—Ç–∏–º–æ.
   - **–ö–æ—Ñ–µ, –ß–µ—Ä–Ω—ã–π —á–∞–π, –°–ª–∞–¥–∫–∏–µ —Å–æ–∫–∏** = –ñ–∏–¥–∫–æ—Å—Ç—å, –Ω–æ –Ω–µ "–¥—É—à".
   - **–ê–ª–∫–æ–≥–æ–ª—å, –ü–∏–≤–æ** = –¢–æ–∫—Å–∏–Ω—ã –∏ –æ–±–µ–∑–≤–æ–∂–∏–≤–∞–Ω–∏–µ üõë.
   *–ê–Ω–∞–ª–∏–∑:* –ï—Å–ª–∏ –º–∞–ª–æ –≤–æ–¥—ã ‚Äî –ø–∏—à–∏ –ø—Ä–æ "–∑–∞—Å—Ç–æ–π –±–æ–ª–æ—Ç–∞" –≤ –º–µ–∂–∫–ª–µ—Ç–æ—á–Ω–æ–º –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ.

2. **–ê–ù–ê–õ–ò–ó –ü–†–ò–ï–ú–û–í –ü–ò–©–ò (–•—Ä–æ–Ω–æ–ª–æ–≥–∏—è):**
   - –ò–¥–∏ —Å—Ç—Ä–æ–≥–æ: –ó–∞–≤—Ç—Ä–∞–∫ -> 2-–π –ó–∞–≤—Ç—Ä–∞–∫ -> –û–±–µ–¥ -> –ü–æ–ª–¥–Ω–∏–∫ -> –£–∂–∏–Ω.
   - **–ï–°–õ–ò –ü–†–ò–ï–ú –ü–ò–©–ò –ü–†–û–ü–£–©–ï–ù:** –ù–∞–ø–∏—à–∏: "‚ö†Ô∏è –ü—Ä–æ–ø—É—Å–∫". –î–∞–π **–º–∏–∫—Ä–æ-—Å–æ–≤–µ—Ç** (–≥–æ—Ä—Å—Ç—å —Å–µ–º–µ—á–µ–∫, —Ñ—Ä—É–∫—Ç) –ò–õ–ò –ø—Ä–µ–¥–ª–æ–∂–∏ "–±—ã—Å—Ç—Ä–æ–µ —Ä–µ—à–µ–Ω–∏–µ" –æ—Ç B&P (–ö–æ–∫—Ç–µ–π–ª—å/–ë–∞—Ç–æ–Ω—á–∏–∫).
   - **–ï–°–õ–ò –û–ë–´–ß–ù–ê–Ø –ï–î–ê (–¢—è–∂–µ–ª–∞—è):** –ù–µ –≥–æ–≤–æ—Ä–∏ "—Ç—Ä–∞—Ç–∏—Ç —Ä–µ—Å—É—Ä—Å—ã". –°–∫–∞–∂–∏: "–¢—è–∂–µ–ª–∞—è –ø–∏—â–∞ –≤—ã–∑—ã–≤–∞–µ—Ç —Å–æ–Ω–ª–∏–≤–æ—Å—Ç—å, –∞ –Ω–µ —ç–Ω–µ—Ä–≥–∏—é. –ñ–µ–ª—É–¥–æ–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç, –∞ –∫–ª–µ—Ç–∫–∞ –≥–æ–ª–æ–¥–∞–µ—Ç."
   - **–ï–°–õ–ò –ê–õ–ö–û–ì–û–õ–¨/–ñ–ò–†–ù–û–ï:** –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø–æ—Ä–µ–∫–æ–º–µ–Ω–¥—É–π **Herbal Mix –ü–µ—á–µ–Ω–æ—á–Ω—ã–π** –¥–ª—è –¥–µ—Ç–æ–∫—Å–∏–∫–∞—Ü–∏–∏.

3. **–ú–ï–¢–û–î –î–í–£–• –ü–£–¢–ï–ô (–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –Ω–∞ –£–∂–∏–Ω –∏–ª–∏ –û–±–µ–¥):**
   - üê¢ **–ü—É—Ç—å 1 (–û–±—ã—á–Ω–∞—è –µ–¥–∞):** –î–∞–π –ö–û–ù–ö–†–ï–¢–ù–´–ô –ø—Ä–∏–º–µ—Ä (–ì—Ä–∞–º–º—ã!). –ù–∞–ø—Ä: "150–≥ —Ç—Ä–µ—Å–∫–∏ –Ω–∞ –ø–∞—Ä—É + 200–≥ –∑–µ–ª–µ–Ω—ã—Ö –æ–≤–æ—â–µ–π".
   - üöÄ **–ü—É—Ç—å 2 (Smart Food):** –ü—Ä–µ–¥–ª–æ–∂–∏ Shape / –ü—é—Ä–µ. –ê—Ä–≥—É–º–µ–Ω—Ç: "1 –º–∏–Ω—É—Ç–∞, –ª–µ–≥–∫–æ—Å—Ç—å, —Å—ã—Ç–æ—Å—Ç—å, –∏–¥–µ–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å".

=== –°–¢–†–£–ö–¢–£–†–ê –û–¢–í–ï–¢–ê (MARKDOWN) ===

**–í–ê–ñ–ù–û: –ù–ï –ü–ò–®–ò –ü–†–ò–í–ï–¢–°–¢–í–ò–ï –í –ù–ê–ß–ê–õ–ï.**

### 1. üíß –í–û–î–ù–´–ô –ë–ê–õ–ê–ù–°
   - –°—Ä–∞–≤–Ω–∏ –§–∞–∫—Ç –∏ –¶–µ–ª—å.
   - –†–∞–∑–¥–µ–ª–∏ –Ω–∞–ø–∏—Ç–∫–∏: –í–æ–¥–∞/–ê–ª–æ—ç/Drain (–•–æ—Ä–æ—à–æ) vs –ö–æ—Ñ–µ/–ê–ª–∫–æ–≥–æ–ª—å (–ù–∞–≥—Ä—É–∑–∫–∞).

### 2. üçΩÔ∏è –ü–û–®–ê–ì–û–í–´–ô –†–ê–ó–ë–û–† –†–ê–¶–ò–û–ù–ê
   
   **–ó–∞–≥–æ–ª–æ–≤–æ–∫ (–Ω–∞–ø—Ä–∏–º–µ—Ä: ‚òÄÔ∏è –ó–ê–í–¢–†–ê–ö)**
   - –ê–Ω–∞–ª–∏–∑. –ü—Ä–æ–≤–µ—Ä—å "–ò–¥–µ–∞–ª—å–Ω—ã–π –∑–∞–≤—Ç—Ä–∞–∫" (–û—á–∏—â–µ–Ω–∏–µ+–ü–∏—Ç–∞–Ω–∏–µ+–≠–Ω–µ—Ä–≥–∏—è).
   
   **–ó–∞–≥–æ–ª–æ–≤–æ–∫ (–Ω–∞–ø—Ä–∏–º–µ—Ä: üçè –í–¢–û–†–û–ô –ó–ê–í–¢–†–ê–ö / –ü–ï–†–ï–ö–£–°)**
   - –ï—Å–ª–∏ –ø—Ä–æ–ø—É—Å–∫ ‚Äî –ø—Ä–µ–¥—É–ø—Ä–µ–¥–∏ –æ –∑–∞–º–µ–¥–ª–µ–Ω–∏–∏ –º–µ—Ç–∞–±–æ–ª–∏–∑–º–∞.
   
   **–ó–∞–≥–æ–ª–æ–≤–æ–∫ (–Ω–∞–ø—Ä–∏–º–µ—Ä: ü•ò –û–ë–ï–î)**
   - –ê–Ω–∞–ª–∏–∑ —Å–æ—Å—Ç–∞–≤–∞.
   
   **–ó–∞–≥–æ–ª–æ–≤–æ–∫ (–Ω–∞–ø—Ä–∏–º–µ—Ä: ‚è∞ –ü–û–õ–î–ù–ò–ö: "–ó–û–õ–û–¢–û–ô –ß–ê–°" 16:00)**
   - –ü–æ—á–µ–º—É —ç—Ç–æ –≤–∞–∂–Ω–æ (–ø–∞–¥–µ–Ω–∏–µ —Å–∞—Ö–∞—Ä–∞). –ï—Å–ª–∏ –ø—Ä–æ–ø—É—Å–∫ -> –ø—Ä–µ–¥–ª–æ–∂–∏ Detox Gentle / Shape.

   **–ó–∞–≥–æ–ª–æ–≤–æ–∫ (–Ω–∞–ø—Ä–∏–º–µ—Ä: üåô –£–ñ–ò–ù)**
   - –ê–Ω–∞–ª–∏–∑.
   - **–ü–†–ò–ú–ï–ù–ò –ú–ï–¢–û–î –î–í–£–• –ü–£–¢–ï–ô:**
     - üê¢ –û–±—ã—á–Ω–∞—è –µ–¥–∞ (–†–µ—Ü–µ–ø—Ç —Å –≥—Ä–∞–º–º–∞–º–∏).
     - üöÄ Smart Food (–ü—Ä–æ–¥—É–∫—Ç + –ü–æ–ª—å–∑–∞).

### 3. üß¨ –§–ò–ó–ò–û–õ–û–ì–ò–Ø
   - ${gallbladderCondition}
   - –ë–µ–ª–æ–∫ = –î–ù–ö. –ï—Å–ª–∏ –¥–µ—Ñ–∏—Ü–∏—Ç -> –ø—Ä–µ–¥–ª–æ–∂–∏ Best Protein.
   - –ï—Å–ª–∏ –±—ã–ª–∏ —Ç–æ–∫—Å–∏–Ω—ã (–∞–ª–∫–æ–≥–æ–ª—å) -> –ø—Ä–µ–¥–ª–æ–∂–∏ Herbal Mix –ü–µ—á–µ–Ω–æ—á–Ω—ã–π –∏–ª–∏ It's Fiber (–¥–µ—Ç–æ–∫—Å).

### 4. ‚ú® –ú–û–¢–ò–í–ê–¶–ò–Ø
   - –ö—Ä–∞—Ç–∫–æ–µ –Ω–∞–ø—É—Ç—Å—Ç–≤–∏–µ.

=== –ó–ê–ü–†–ï–¢–´ ===
- –ù–ï –ò–°–ü–û–õ–¨–ó–£–ô (–ê), (–ë), [–°–∫–æ–±–∫–∏] –≤ –∑–∞–≥–æ–ª–æ–≤–∫–∞—Ö.
- –ù–ï –ü–ò–®–ò –°–ü–ò–°–ö–ò –°–™–ï–î–ï–ù–ù–û–ì–û ("–í—ã —Å—ä–µ–ª–∏...").
- –ù–ï "–í–¢–Æ–•–ò–í–ê–ô". –ü—Ä–µ–¥–ª–∞–≥–∞–π —Ä–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã.
`;
}

// --- 3. –û–°–ù–û–í–ù–û–ô –û–ë–†–ê–ë–û–¢–ß–ò–ö ---

export default async function handler(req, res) {
    // 1. CORS
    res.setHeader('Access-Control-Allow-Origin', '*');
    res.setHeader('Access-Control-Allow-Methods', 'POST, OPTIONS');
    res.setHeader('Access-Control-Allow-Headers', 'Content-Type');

    if (req.method === 'OPTIONS') {
        res.status(200).end();
        return;
    }
    if (req.method !== 'POST') {
        return res.status(405).json({ error: 'Only POST' });
    }

    try {
        const apiKey = process.env.GEMINI_API_KEY;
        if (!apiKey) throw new Error('–ù–µ—Ç GEMINI_API_KEY');

        const userData = req.body;
        if (!userData?.dailyFact || !userData?.goal) {
            return res.status(400).json({ error: '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö' });
        }

        // 2. –î–∞–Ω–Ω—ã–µ
        const goalTitle = getGoalTitle(userData.goal);
        
        const mandatoryOpening = `üëã **–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é! –ù–∞ —Å–≤—è–∑–∏ –ê–Ω–¥—Ä–µ–π –°–æ–ª–¥–∞—Ç–µ–Ω–∫–æ.**\n\n–Ø –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–ª –í–∞—à —Ä–∞—Ü–∏–æ–Ω —Å —É—á–µ—Ç–æ–º –í–∞—à–µ–π —Ü–µ–ª–∏: **${goalTitle}**.\n–î–∞–≤–∞–π—Ç–µ –ø–æ—Å–º–æ—Ç—Ä–∏–º, –∫–∞–∫ –í–∞—à –æ—Ä–≥–∞–Ω–∏–∑–º —Ä–µ–∞–≥–∏—Ä—É–µ—Ç –Ω–∞ —Ç–æ —Ç–æ–ø–ª–∏–≤–æ, –∫–æ—Ç–æ—Ä–æ–µ –í—ã –µ–º—É –¥–∞–µ—Ç–µ üîã.`;
        
        const disclaimerBlock = `\n\n------------------\n‚ö†Ô∏è **–í–ê–ñ–ù–û–ï –ü–†–ò–ú–ï–ß–ê–ù–ò–ï:**\n–î–∞–Ω–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –æ—Å–Ω–æ–≤–∞–Ω—ã –Ω–∞ –∞–Ω–∞–ª–∏–∑–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö –í–∞–º–∏ —Ü–∏—Ñ—Ä –∏ –º–æ–µ–º –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–º –æ–ø—ã—Ç–µ. –û–Ω–∏ –Ω–æ—Å—è—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä.\n–í—ã –ø—Ä–∏–Ω–∏–º–∞–µ—Ç–µ –Ω–∞ —Å–µ–±—è –ø–æ–ª–Ω—É—é –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å –∑–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —ç—Ç–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.\n–ï—Å–ª–∏ —É –í–∞—Å –∏–º–µ—é—Ç—Å—è —Ö—Ä–æ–Ω–∏—á–µ—Å–∫–∏–µ –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏—è –∏–ª–∏ –í—ã –ø—Ä–∏–Ω–∏–º–∞–µ—Ç–µ –ª–µ–∫–∞—Ä—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø—Ä–µ–ø–∞—Ä–∞—Ç—ã, –ø–µ—Ä–µ–¥ –ª—é–±—ã–º–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏ –≤ —Ä–∞—Ü–∏–æ–Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è —Å –í–∞—à–∏–º –ª–µ—á–∞—â–∏–º –≤—Ä–∞—á–æ–º.`;

        // 3. –í—ã–∑–æ–≤ AI
        const analysisPrompt = buildAnalysisPrompt(userData);
        const genAI = new GoogleGenerativeAI(apiKey);
        const model = genAI.getGenerativeModel({ model: "gemini-2.5-flash" });

        const aiText = await callGeminiWithRetry(model, analysisPrompt, 6);
        
        const fullText = mandatoryOpening + "\n\n" + aiText.trim() + disclaimerBlock;

        res.status(200).json({ text: fullText });

    } catch (error) {
        console.error('Error:', error.message);
        res.status(500).json({ error: 'Generation failed' });
    }
}
