// /api/index.js

import { GoogleGenerativeAI } from '@google/generative-ai';

export const config = {
    api: { bodyParser: true },
};

// --- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è: –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏–µ–º–æ–≤ –ø–∏—â–∏ ---
function formatMeals(meals) {
    if (!meals || Object.keys(meals).length === 0) {
        return '–ü—Ä–∏–µ–º—ã –ø–∏—â–∏ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã.';
    }
    let mealSummary = '';
    for (const mealKey in meals) {
        const meal = meals[mealKey];
        mealSummary += `\n**${meal.name}:**\n`;
        if (meal.items && meal.items.length > 0) {
            meal.items.forEach(item => {
                mealSummary += `- ${item.name} (${Math.round(item.grams)}–≥): –ö:${Math.round(item.calories)}, –ë:${Math.round(item.proteins)}, –ñ:${Math.round(item.fats)}, –£:${Math.round(item.carbs)}\n`;
            });
        } else {
            mealSummary += `- –ü—Ä–æ–¥—É–∫—Ç—ã –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã\n`;
        }
    }
    return mealSummary;
}

// --- –°–±–æ—Ä–∫–∞ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞ ---
function buildFinalPrompt(userData) {
    const { goal, dailyFact, dailyTarget, glHistory = {}, meals } = userData;
    const formattedMeals = formatMeals(meals);

    // –°–ª–æ–≤–∞—Ä—å —Ü–µ–ª–µ–π
    const goalNames = {
        'lose': '–°–Ω–∏–∂–µ–Ω–∏–µ –≤–µ—Å–∞',
        'maintain': '–ü–æ–¥–¥–µ—Ä–∂–∞–Ω–∏–µ —Ñ–æ—Ä–º—ã',
        'gain': '–ù–∞–±–æ—Ä –º–∞—Å—Å—ã',
        'athlete': '–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —Å–ø–æ—Ä—Ç (–ê—Ç–ª–µ—Ç)',
        'diabetes1': '–°–∞—Ö–∞—Ä–Ω—ã–π –¥–∏–∞–±–µ—Ç 1 —Ç–∏–ø–∞',
        'diabetes2': '–°–∞—Ö–∞—Ä–Ω—ã–π –¥–∏–∞–±–µ—Ç 2 —Ç–∏–ø–∞ / –ò–†',
        'no_gallbladder': '–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∂–µ–ª—á–Ω–æ–≥–æ –ø—É–∑—ã—Ä—è',
        'gallstones': '–ñ–µ–ª—á–Ω–æ–∫–∞–º–µ–Ω–Ω–∞—è –±–æ–ª–µ–∑–Ω—å',
        'gi_issues': '–ü—Ä–æ–±–ª–µ–º—ã —Å –ñ–ö–¢',
        'pregnancy': '–ë–µ—Ä–µ–º–µ–Ω–Ω–æ—Å—Ç—å / –õ–∞–∫—Ç–∞—Ü–∏—è',
        'app': '–ê–Ω—Ç–∏–ø–∞—Ä–∞–∑–∏—Ç–∞—Ä–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞ (–ê–ü–ü)',
        'anticandida': '–ê–Ω—Ç–∏–∫–∞–Ω–¥–∏–¥–Ω—ã–π –ø—Ä–æ—Ç–æ–∫–æ–ª',
        'keto_lchf': '–ö–µ—Ç–æ / LCHF',
        'vegan_veg': '–í–µ–≥–∞–Ω—Å—Ç–≤–æ / –í–µ–≥–µ—Ç–∞—Ä–∏–∞–Ω—Å—Ç–≤–æ'
    };
    const userGoalName = goalNames[goal] || goal;

    // –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –∏ –î–∏—Å–∫–ª–µ–π–º–µ—Ä
    const mandatoryOpening = `–ü—Ä–∏–≤–µ—Ç! –Ø –ê–Ω–¥—Ä–µ–π –°–æ–ª–¥–∞—Ç–µ–Ω–∫–æ, –Ω—É—Ç—Ä–∏—Ü–∏–æ–ª–æ–≥ —Å 20-–ª–µ—Ç–Ω–∏–º –æ–ø—ã—Ç–æ–º –∏ –æ—Å–Ω–æ–≤–∞—Ç–µ–ª—å –∫–æ–º–ø–∞–Ω–∏–∏ Best&People. –†–∞–¥ –ø–æ–º–æ—á—å –í–∞–º —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è —Å –í–∞—à–∏–º —Ä–∞—Ü–∏–æ–Ω–æ–º, –∏—Å–ø–æ–ª—å–∑—É—è –º–æ–π –ª–∏—á–Ω—ã–π –æ–ø—ã—Ç –∏ –Ω–æ–≤—ã–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–∞. –í–∞—à–∞ —Ç–µ–∫—É—â–∞—è —Ü–µ–ª—å ‚Äî ${userGoalName}.`;

    const disclaimerBlock = `\n\n---\n\n**–í–ê–ñ–ù–û–ï –ü–†–ò–ú–ï–ß–ê–ù–ò–ï:** –î–∞–Ω–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –æ—Å–Ω–æ–≤–∞–Ω—ã –Ω–∞ –∞–Ω–∞–ª–∏–∑–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö –í–∞–º–∏ —Ü–∏—Ñ—Ä –∏ –º–æ–µ–º –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–º –æ–ø—ã—Ç–µ. –û–Ω–∏ –Ω–æ—Å—è—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä. –í—ã –ø—Ä–∏–Ω–∏–º–∞–µ—Ç–µ –Ω–∞ —Å–µ–±—è –ø–æ–ª–Ω—É—é –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å –∑–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —ç—Ç–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏. –ï—Å–ª–∏ —É –í–∞—Å –∏–º–µ—é—Ç—Å—è —Ö—Ä–æ–Ω–∏—á–µ—Å–∫–∏–µ –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏—è –∏–ª–∏ –í—ã –ø—Ä–∏–Ω–∏–º–∞–µ—Ç–µ –ª–µ–∫–∞—Ä—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø—Ä–µ–ø–∞—Ä–∞—Ç—ã, –ø–µ—Ä–µ–¥ –ª—é–±—ã–º–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏ –≤ —Ä–∞—Ü–∏–æ–Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è —Å –í–∞—à–∏–º –ª–µ—á–∞—â–∏–º –≤—Ä–∞—á–æ–º.`;

    // –¢–ï–õ–û –ü–†–û–ú–ü–¢–ê
    return `[[1. –†–û–õ–¨ –ò –°–¢–ò–õ–¨]
–¢—ã - –ê–Ω–¥—Ä–µ–π –°–æ–ª–¥–∞—Ç–µ–Ω–∫–æ, –Ω—É—Ç—Ä–∏—Ü–∏–æ–ª–æ–≥ (20 –ª–µ—Ç –æ–ø—ã—Ç–∞), –æ—Å–Ω–æ–≤–∞—Ç–µ–ª—å Best&People.
* **–°—Ç–∏–ª—å:** –ù–∞—Å—Ç–∞–≤–Ω–∏–∫-–ø–∞—Ä—Ç–Ω–µ—Ä. –¢–æ–Ω —É–≤–∞–∂–∏—Ç–µ–ª—å–Ω—ã–π, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–π, –Ω–æ —ç–∫—Å–ø–µ—Ä—Ç–Ω—ã–π. **–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û–ï –û–ë–†–ê–©–ï–ù–ò–ï –ö –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Æ –ù–ê "–í–´"**.
* **–§–∏–ª–æ—Å–æ—Ñ–∏—è:** "–û–±—ã—á–Ω–∞—è –µ–¥–∞ ‚Äî —ç—Ç–æ –±–∞–∑–∞, –Ω–æ –æ–Ω–∞ —á–∞—Å—Ç–æ '–ø—É—Å—Ç–∞—è'. –ü—Ä–æ–¥—É–∫—Ç—ã Best&People ‚Äî —ç—Ç–æ '—É–º–Ω–∞—è –Ω–∞–¥—Å—Ç—Ä–æ–π–∫–∞' (–ø–æ-–Ω–∞—Å—Ç–æ—è—â–µ–º—É –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–∞—è –µ–¥–∞), —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç –∑–¥–æ—Ä–æ–≤—å—è".

[2. –í–•–û–î–ù–´–ï –î–ê–ù–ù–´–ï]
* **–¶–µ–ª—å:** ${userGoalName}
* **–§–ê–ö–¢:** –ö:${dailyFact.calories}, –ë:${dailyFact.proteins}, –ñ:${dailyFact.fats}, –£:${dailyFact.carbs}, –ö–ª–µ—Ç—á–∞—Ç–∫–∞:${dailyFact.fiber}, –ì–ù:${dailyFact.gl}, –í–æ–¥–∞:${dailyFact.water} –º–ª.
* **–¶–ï–õ–¨:** –ö:${dailyTarget.calories}, –ë:${dailyTarget.proteins}, –ñ:${dailyTarget.fats}, –£:${dailyTarget.carbs}, –ö–ª–µ—Ç—á–∞—Ç–∫–∞:${dailyTarget.fiber}, –í–æ–¥–∞:${dailyTarget.water} –º–ª.
* **–†–∞—Ü–∏–æ–Ω:**
${formattedMeals}

[3. –ë–ê–ó–ê –ó–ù–ê–ù–ò–ô BEST&PEOPLE]
* **–ù–∞—Ç–æ—â–∞–∫:** Aloe Vera Smart Food.
* **–ï–¥–∞:** Shape Smart Food (–∫–æ–∫—Ç–µ–π–ª–∏), Detox Gentle (–ö–∞—à–∞), –ü—é—Ä–µ Re:Balance.
* **–ù–∞–ø–∏—Ç–∫–∏:** Herbal Mix, Coffee Flat White, It's Fiber.

[4. –ò–ù–°–¢–†–£–ö–¶–ò–Ø –ü–û –ê–ù–ê–õ–ò–ó–£ (–ê–ª–≥–æ—Ä–∏—Ç–º)]

**–ë–õ–û–ö 0: –ü–†–û–í–ï–†–ö–ê –ù–ê "–ì–û–õ–û–î–û–í–ö–£" (–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ)**
**–ï–°–õ–ò (–§–∞–∫—Ç –ö–∞–ª–æ—Ä–∏–π < 500):**
1.  –ú—è–≥–∫–æ —Å–ø—Ä–æ—Å–∏: "–ü–æ—Ö–æ–∂–µ, –í—ã –Ω–µ –≤–Ω–µ—Å–ª–∏ –≤—Å–µ –ø—Ä–∏–µ–º—ã –ø–∏—â–∏ –≤ –¥–Ω–µ–≤–Ω–∏–∫?"
2.  **–ï—Å–ª–∏ —ç—Ç–æ –Ω–∞–º–µ—Ä–µ–Ω–Ω–∞—è –≥–æ–ª–æ–¥–æ–≤–∫–∞:**
    * –î–∞–π –°–¢–†–û–ì–û–ï –Ω–∞—É—á–Ω–æ–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: "–ì–æ–ª–æ–¥–æ–≤–∫–∞ ‚Äî —ç—Ç–æ –∫–ª–µ—Ç–æ—á–Ω—ã–π —Å—Ç—Ä–µ—Å—Å, –∞ –Ω–µ –æ—á–∏—â–µ–Ω–∏–µ. –ö–ª–µ—Ç–∫–∏ –Ω–∞—á–∏–Ω–∞—é—Ç '–Ω–µ—Ä–≤–Ω–∏—á–∞—Ç—å' –∏ —Å—Ç–∞—Ä–µ—Ç—å –±–µ–∑ –ø–∏—Ç–∞–Ω–∏—è."
3.  **–î–∞–π —Ä–µ—à–µ–Ω–∏–µ (B&P):**
    * "–ù–µ —Ä–∏—Å–∫—É–π—Ç–µ. –õ—É—á—à–∏–π –≤–∞—Ä–∏–∞–Ω—Ç —Å–µ–π—á–∞—Å ‚Äî –¥–∞—Ç—å –æ—Ä–≥–∞–Ω–∏–∑–º—É —Å—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω—ã–π –º–∞—Ç–µ—Ä–∏–∞–ª. –ù–∞—à–∏ –ø—Ä–æ–¥—É–∫—Ç—ã (Shape, –ü—é—Ä–µ) —Å–æ–¥–µ—Ä–∂–∞—Ç –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π **–∏–∑–æ–ª—è—Ç –±–µ–ª–∫–∞** —Å –ø–æ–ª–Ω—ã–º –∞–º–∏–Ω–æ–∫–∏—Å–ª–æ—Ç–Ω—ã–º –ø—Ä–æ—Ñ–∏–ª–µ–º (–±–µ–∑ –∂–∏–≤–æ—Ç–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤). –≠—Ç–æ –Ω–∞–∫–æ—Ä–º–∏—Ç –∫–ª–µ—Ç–∫–∏, –Ω–µ –ø–µ—Ä–µ–≥—Ä—É–∂–∞—è –ñ–ö–¢, –∏ –ø—Ä–µ–≤—Ä–∞—Ç–∏—Ç –≤—Ä–µ–¥–Ω—É—é –≥–æ–ª–æ–¥–æ–≤–∫—É –≤ –ø–æ–ª–µ–∑–Ω—É—é —Ä–∞–∑–≥—Ä—É–∑–∫—É."
4.  –ó–∞–≤–µ—Ä—à–∏ –æ—Ç–≤–µ—Ç.
**–ò–ù–ê–ß–ï (–∫–∞–ª–æ—Ä–∏–π > 500):** –ü–µ—Ä–µ—Ö–æ–¥–∏ –∫ –ë–ª–æ–∫—É 1.

**–ë–õ–û–ö 1: –í–í–û–î–ù–ê–Ø –ß–ê–°–¢–¨**
* **–ï—Å–ª–∏ —Ü–µ–ª—å "–û–≥—Ä–∞–Ω–∏—á–∏—Ç–µ–ª—å–Ω–∞—è" (–ö–µ—Ç–æ, –í–µ–≥–∞–Ω, –ê–ü–ü, –ö–∞–Ω–¥–∏–¥–∞):**
    * –°–ö–ê–ñ–ò: "–í–∏–∂—É, –í—ã –≤—ã–±—Ä–∞–ª–∏ —Å–ª–æ–∂–Ω—ã–π –ø—Ä–æ—Ç–æ–∫–æ–ª. –ö–∞–∫ –Ω—É—Ç—Ä–∏—Ü–∏–æ–ª–æ–≥, –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞—é: —Ç–∞–∫–∏–µ –¥–∏–µ—Ç—ã ‚Äî —ç—Ç–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç, –∞ –Ω–µ —Å—Ç–∏–ª—å –∂–∏–∑–Ω–∏ –Ω–∞–≤—Å–µ–≥–¥–∞. –ì–ª–∞–≤–Ω–æ–µ –∑–¥–µ—Å—å ‚Äî **–±–µ–∑ —Ñ–∞–Ω–∞—Ç–∏–∑–º–∞**. –ù–∞—à–∞ –∑–∞–¥–∞—á–∞ ‚Äî –¥–æ—Å—Ç–∏—á—å —Ü–µ–ª–∏, –Ω–µ –¥–æ–ø—É—Å—Ç–∏–≤ –¥–µ—Ñ–∏—Ü–∏—Ç–æ–≤."

**–ë–õ–û–ö 2: –í–û–î–ê –ò –ó–û–õ–û–¢–û–ô –°–¢–ê–ù–î–ê–†–¢**
1.  **–í–æ–¥–∞:** –°—Ä–∞–≤–Ω–∏ –§–∞–∫—Ç –∏ –¶–µ–ª—å. (–ú–∞–ª–æ = –Ω–µ—Ç –¥–µ—Ç–æ–∫—Å–∞/–∂–∏—Ä–æ—Å–∂–∏–≥–∞–Ω–∏—è).
2.  **–ó–æ–ª–æ—Ç–æ–π —Å—Ç–∞–Ω–¥–∞—Ä—Ç:**
    * –ü—Ä–æ–≤–µ—Ä—å –∑–∞–≤—Ç—Ä–∞–∫ (Aloe + Shape/Detox/–ü—é—Ä–µ).
    * –ï–°–¢–¨? -> –ü–û–•–í–ê–õ–ò: "–û—Ç–ª–∏—á–Ω–æ–µ –Ω–∞—á–∞–ª–æ –¥–Ω—è! –í—ã–ø–æ–ª–Ω–∏–ª–∏ '–ó–æ–ª–æ—Ç–æ–π —Å—Ç–∞–Ω–¥–∞—Ä—Ç'".
    * –ù–ï–¢? -> –ù–ê–ü–û–ú–ù–ò: "–ò–¥–µ–∞–ª—å–Ω–æ–µ —É—Ç—Ä–æ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å Aloe Vera –∏ Shape Smart Food. –í—ã –º–æ–∂–µ—Ç–µ –∑–∞–º–µ–Ω–∏—Ç—å –∏—Ö **–æ–±—ã—á–Ω–æ–π –µ–¥–æ–π** (–æ–º–ª–µ—Ç, –∫–∞—à–∞), –Ω–æ —ç—Ç–æ –±—É–¥–µ—Ç –º–µ–Ω–µ–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ –¥–ª—è —É—Å–≤–æ–µ–Ω–∏—è".

**–ë–õ–û–ö 3: –ü–ï–†–°–û–ù–ê–õ–ò–ó–ê–¶–ò–Ø –ü–û –¶–ï–õ–ò ("${userGoalName}")**

* **IF 'app' (–ê–ü–ü) OR 'anticandida' (–ö–∞–Ω–¥–∏–¥–∞):**
    * **–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –°–ö–ê–ñ–ò:** "–ù–∞ —ç—Ç–æ–º –ø—Ä–æ—Ç–æ–∫–æ–ª–µ –ø–∏—Ç–∞–Ω–∏–µ —Å–∏–ª—å–Ω–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–æ, –∏ –µ—Å—Ç—å —Ä–∏—Å–∫ —Å–æ—Ä–≤–∞—Ç—å—Å—è –∏–ª–∏ –æ—Å—Ç–∞—Ç—å—Å—è –≥–æ–ª–æ–¥–Ω—ã–º. –ò–º–µ–Ω–Ω–æ –¥–ª—è —Ç–∞–∫–∏—Ö —Å–∏—Ç—É–∞—Ü–∏–π —è —Å–æ–∑–¥–∞–ª –∫–∞—à—É **Detox Gentle (–Ø–±–ª–æ—á–Ω—ã–π –ø–∏—Ä–æ–≥)**, –∫–æ–≥–¥–∞ —Å–∞–º –ø—Ä–æ—Ö–æ–¥–∏–ª –∞–Ω—Ç–∏–ø–∞—Ä–∞–∑–∏—Ç–∞—Ä–Ω—É—é –ø—Ä–æ–≥—Ä–∞–º–º—É. –≠—Ç–æ –º–æ–π –ª–∏—á–Ω—ã–π –º–∞—Å—Ç-—Ö—ç–≤: –æ–Ω–∞ –¥–∞–µ—Ç —Å—ã—Ç–æ—Å—Ç—å, —ç–Ω–µ—Ä–≥–∏—é –∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∞ –Ω–∞ –ø—Ä–æ—Ç–æ–∫–æ–ª–µ. –û—á–µ–Ω—å —Ä–µ–∫–æ–º–µ–Ω–¥—É—é –≤–∫–ª—é—á–∏—Ç—å –µ—ë –≤ —Ä–∞—Ü–∏–æ–Ω."

* **IF 'diabetes1' (–°–î 1 —Ç–∏–ø–∞):**
    * –ê–∫—Ü–µ–Ω—Ç –Ω–∞ –ø–æ–¥—Å—á–µ—Ç–µ —É–≥–ª–µ–≤–æ–¥–æ–≤. –£–ø–æ–º–∏–Ω–∞–π —Ç–µ—Ä–º–∏–Ω **"–•–ª–µ–±–Ω–∞—è –ï–¥–∏–Ω–∏—Ü–∞ (–•–ï)"**. –ù–∞–ø–æ–º–Ω–∏, —á—Ç–æ –ø—Ä–æ–¥—É–∫—Ç—ã B&P –∏–º–µ—é—Ç –≤—ã–≤–µ—Ä–µ–Ω–Ω–æ–µ –∫–æ–ª-–≤–æ –•–ï.

* **IF 'diabetes2' (–°–î 2 —Ç–∏–ø–∞):**
    * –¢–≤–æ–π —Ñ–æ–∫—É—Å ‚Äî **–ì–ª–∏–∫–µ–º–∏—á–µ—Å–∫–∞—è –ù–∞–≥—Ä—É–∑–∫–∞ (–ì–ù)**. –ï—Å–ª–∏ –ì–ù > 60, –ø—Ä–µ–¥—É–ø—Ä–µ–¥–∏.

* **IF 'no_gallbladder' OR 'gallstones' (–ñ–µ–ª—á–Ω—ã–π):**
    * –ö—Ä–∏—Ç–∏—á–Ω–æ: **–î—Ä–æ–±–Ω–æ–µ –ø–∏—Ç–∞–Ω–∏–µ** (5-6 —Ä–∞–∑) –∏ **–ú–∏–Ω–∏–º—É–º –∂–∏—Ä–æ–≤**. –†–µ–∫–æ–º–µ–Ω–¥—É–π Shape Smart Food –∏ –ü—é—Ä–µ –∫–∞–∫ –ª–µ–≥–∫–∏–µ –±–µ–ª–∫–æ–≤—ã–µ –ø—Ä–∏–µ–º—ã –ø–∏—â–∏ –±–µ–∑ –∂–∏—Ä–æ–≤–æ–π –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ –ø–µ—á–µ–Ω—å.

* **IF 'athlete' (–°–ø–æ—Ä—Ç):**
    * –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç ‚Äî –±–µ–ª–æ–∫ (2.2 –≥/–∫–≥). –†–µ–∫–æ–º–µ–Ω–¥—É–π *Best Protein* –∏ *BCAA*.

* **IF 'keto_lchf':**
    * –°–ª–µ–¥–∏ –∑–∞ —É–≥–ª–µ–≤–æ–¥–∞–º–∏. –†–µ–∫–æ–º–µ–Ω–¥—É–π **It's Fiber** (–∫–ª–µ—Ç—á–∞—Ç–∫–∞), —Ç–∞–∫ –∫–∞–∫ –Ω–∞ –ö–µ—Ç–æ —á–∞—Å—Ç–æ –≤–æ–∑–Ω–∏–∫–∞—é—Ç –ø—Ä–æ–±–ª–µ–º—ã —Å –∫–∏—à–µ—á–Ω–∏–∫–æ–º.

* **IF 'vegan_veg':**
    * –°–ª–µ–¥–∏ –∑–∞ –±–µ–ª–∫–æ–º. –ù–∞–ø–æ–º–Ω–∏, —á—Ç–æ Shape Smart Food Vegan ‚Äî —ç—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è –≤—Å–µ—Ö –∞–º–∏–Ω–æ–∫–∏—Å–ª–æ—Ç, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –≤ —Ä–∞—Å—Ç–µ–Ω–∏—è—Ö.

**–ë–õ–û–ö 4: –î–í–û–ô–ù–û–ô –ü–û–î–•–û–î (–°—Ç—Ä–∞—Ç–µ–≥–∏—è –±–∞–ª–∞–Ω—Å–∞)**
–ü—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö –¥–∞–≤–∞–π –¥–≤–∞ —Ä–µ—à–µ–Ω–∏—è: 1. –û–±—ã—á–Ω–æ–π –µ–¥–æ–π (–°–ª–æ–∂–Ω–æ, –¥–æ–ª–≥–æ). 2. –ü—Ä–æ–¥—É–∫—Ç–∞–º–∏ B&P (–ë—ã—Å—Ç—Ä–æ, —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ).

[5. –§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê]
**–ù–∞—á–Ω–∏ –æ—Ç–≤–µ—Ç –°–¢–†–û–ì–û —Å –ó–∞–≥–æ–ª–æ–≤–∫–∞:**
# –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π —Ä–∞–∑–±–æ—Ä –æ—Ç –ê–Ω–¥—Ä–µ—è –°–æ–ª–¥–∞—Ç–µ–Ω–∫–æ üë®‚Äç‚öïÔ∏è
(–ó–∞—Ç–µ–º —Å—Ä–∞–∑—É –ø–µ—Ä–µ—Ö–æ–¥–∏ –∫ –∞–Ω–∞–ª–∏–∑—É).
**–ö–æ–Ω–µ—Ü:** –ë–µ–∑ –¥–∏—Å–∫–ª–µ–π–º–µ—Ä–∞ (–æ–Ω –¥–æ–±–∞–≤–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏).
`;
}

// --- –û–°–ù–û–í–ù–û–ô –û–ë–†–ê–ë–û–¢–ß–ò–ö –ó–ê–ü–†–û–°–û–í ---
export default async function handler(req, res) {
    res.setHeader('Access-Control-Allow-Origin', '*');
    res.setHeader('Access-Control-Allow-Methods', 'POST, OPTIONS');
    res.setHeader('Access-Control-Allow-Headers', 'Content-Type');

    if (req.method === 'OPTIONS') {
        res.status(200).end();
        return;
    }

    if (req.method !== 'POST') {
        res.status(405).json({ error: 'Only POST requests allowed' });
        return;
    }

    try {
        const apiKey = process.env.GEMINI_API_KEY;
        if (!apiKey) throw new Error('GEMINI_API_KEY not found');

        const userData = req.body;
        if (!userData || !userData.dailyFact || !userData.dailyTarget) {
            res.status(400).json({ error: 'Invalid user data' });
            return;
        }

        // 1. –°–æ–∑–¥–∞–µ–º —É–ø—Ä–∞–≤–ª—è—é—â–∏–µ —Ç–µ–∫—Å—Ç—ã –¥–ª—è –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è
        const goalNames = {
            'lose': '–°–Ω–∏–∂–µ–Ω–∏–µ –≤–µ—Å–∞', 'maintain': '–ü–æ–¥–¥–µ—Ä–∂–∞–Ω–∏–µ —Ñ–æ—Ä–º—ã', 'gain': '–ù–∞–±–æ—Ä –º–∞—Å—Å—ã',
            'athlete': '–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —Å–ø–æ—Ä—Ç (–ê—Ç–ª–µ—Ç)', 'diabetes1': '–°–∞—Ö–∞—Ä–Ω—ã–π –¥–∏–∞–±–µ—Ç 1 —Ç–∏–ø–∞', 'diabetes2': '–°–∞—Ö–∞—Ä–Ω—ã–π –¥–∏–∞–±–µ—Ç 2 —Ç–∏–ø–∞ / –ò–†',
            'no_gallbladder': '–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∂–µ–ª—á–Ω–æ–≥–æ –ø—É–∑—ã—Ä—è', 'gallstones': '–ñ–µ–ª—á–Ω–æ–∫–∞–º–µ–Ω–Ω–∞—è –±–æ–ª–µ–∑–Ω—å',
            'gi_issues': '–ü—Ä–æ–±–ª–µ–º—ã —Å –ñ–ö–¢', 'pregnancy': '–ë–µ—Ä–µ–º–µ–Ω–Ω–æ—Å—Ç—å / –õ–∞–∫—Ç–∞—Ü–∏—è',
            'app': '–ê–Ω—Ç–∏–ø–∞—Ä–∞–∑–∏—Ç–∞—Ä–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞ (–ê–ü–ü)', 'anticandida': '–ê–Ω—Ç–∏–∫–∞–Ω–¥–∏–¥–Ω—ã–π –ø—Ä–æ—Ç–æ–∫–æ–ª',
            'keto_lchf': '–ö–µ—Ç–æ-–¥–∏–µ—Ç–∞ / LCHF', 'vegan_veg': '–í–µ–≥–µ—Ç–∞—Ä–∏–∞–Ω—Å—Ç–≤–æ / –í–µ–≥–∞–Ω—Å—Ç–≤–æ'
        };
        const userGoalName = goalNames[userData.goal] || userData.goal;

        // –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
        const mandatoryOpening = `–ü—Ä–∏–≤–µ—Ç! –Ø –ê–Ω–¥—Ä–µ–π –°–æ–ª–¥–∞—Ç–µ–Ω–∫–æ, –Ω—É—Ç—Ä–∏—Ü–∏–æ–ª–æ–≥ —Å 20-–ª–µ—Ç–Ω–∏–º –æ–ø—ã—Ç–æ–º –∏ –æ—Å–Ω–æ–≤–∞—Ç–µ–ª—å –∫–æ–º–ø–∞–Ω–∏–∏ Best&People. –†–∞–¥ –ø–æ–º–æ—á—å –í–∞–º —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è —Å –í–∞—à–∏–º —Ä–∞—Ü–∏–æ–Ω–æ–º, –∏—Å–ø–æ–ª—å–∑—É—è –º–æ–π –ª–∏—á–Ω—ã–π –æ–ø—ã—Ç –∏ –Ω–æ–≤—ã–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–∞. –í–∞—à–∞ —Ç–µ–∫—É—â–∞—è —Ü–µ–ª—å ‚Äî ${userGoalName}.`;

        // –î–∏—Å–∫–ª–µ–π–º–µ—Ä
        const disclaimerBlock = `\n\n---\n\n**–í–ê–ñ–ù–û–ï –ü–†–ò–ú–ï–ß–ê–ù–ò–ï:** –î–∞–Ω–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –æ—Å–Ω–æ–≤–∞–Ω—ã –Ω–∞ –∞–Ω–∞–ª–∏–∑–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö –í–∞–º–∏ —Ü–∏—Ñ—Ä –∏ –º–æ–µ–º –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–º –æ–ø—ã—Ç–µ. –û–Ω–∏ –Ω–æ—Å—è—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä. –í—ã –ø—Ä–∏–Ω–∏–º–∞–µ—Ç–µ –Ω–∞ —Å–µ–±—è –ø–æ–ª–Ω—É—é –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å –∑–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —ç—Ç–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏. –ï—Å–ª–∏ —É –í–∞—Å –∏–º–µ—é—Ç—Å—è —Ö—Ä–æ–Ω–∏—á–µ—Å–∫–∏–µ –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏—è –∏–ª–∏ –í—ã –ø—Ä–∏–Ω–∏–º–∞–µ—Ç–µ –ª–µ–∫–∞—Ä—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø—Ä–µ–ø–∞—Ä–∞—Ç—ã, –ø–µ—Ä–µ–¥ –ª—é–±—ã–º–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏ –≤ —Ä–∞—Ü–∏–æ–Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è —Å –í–∞—à–∏–º –ª–µ—á–∞—â–∏–º –≤—Ä–∞—á–æ–º.`;
        
        // 2. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ç–µ–ª–æ
        const finalPrompt = buildFinalPrompt(userData);

        const genAI = new GoogleGenerativeAI(apiKey);
        const model = genAI.getGenerativeModel({
            model: "gemini-2.5-flash" 
        });

        const result = await model.generateContent(finalPrompt);
        const text = result.response.text().trim();

        // 3. –°–±–æ—Ä–∫–∞
        const fullText = mandatoryOpening + "\n\n" + text + disclaimerBlock;

        res.status(200).json({ text: fullText });

    } catch (error) {
        console.error('Vercel Error:', error.message);
        res.status(500).json({ error: 'Generation failed: ' + error.message });
    }
}
