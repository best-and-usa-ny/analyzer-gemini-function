import { GoogleGenerativeAI } from '@google/generative-ai';

// =========================================================
// 1. –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø
// =========================================================

export const config = {
    api: {
        bodyParser: {
            sizeLimit: '4mb',
        },
    },
};

const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));

async function callGeminiWithRetry(model, prompt, retries = 3, imagePart = null) {
    let delay = 2000;
    for (let i = 0; i < retries; i++) {
        try {
            let result;
            if (imagePart) {
                result = await model.generateContent([prompt, imagePart]);
            } else {
                result = await model.generateContent(prompt);
            }
            return result.response.text();
        } catch (err) {
            console.warn(`Gemini Error (Attempt ${i + 1}/${retries}):`, err.message);
            if (i === retries - 1) throw err;
            await sleep(delay);
            delay *= 1.5;
        }
    }
}

// =========================================================
// 2. –ë–ê–ó–ê –ó–ù–ê–ù–ò–ô (–ü–†–û–î–£–ö–¢–´, –¶–ï–õ–ò, –§–ò–õ–û–°–û–§–ò–Ø)
// =========================================================

const PRODUCTS_KNOWLEDGE = `
–í–ê–ñ–ù–û: –ü—Ä–æ–¥—É–∫—Ü–∏—è Best&People - —ç—Ç–æ —É–º–Ω–æ–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ –ø–∏—Ç–∞–Ω–∏–µ (Smart Food), –∞ –Ω–µ –ë–ê–î—ã. 
–ù–∞–∑–≤–∞–Ω–∏—è –ø–∏—Å–∞—Ç—å –°–¢–†–û–ì–û –ø–æ–ª–Ω–æ—Å—Ç—å—é.

1. –ü–û–õ–ù–û–¶–ï–ù–ù–´–ï –ó–ê–ú–ï–ù–ò–¢–ï–õ–ò –ü–ò–©–ò (–í–º–µ—Å—Ç–æ –µ–¥—ã):
- **Shape Smart Food** (–ö–æ–∫—Ç–µ–π–ª–∏: –ö–ª—É–±–Ω–∏–∫–∞, –ö–∞–ø—É—á–∏–Ω–æ, –î—ã–Ω—è) -> –ö–æ–Ω—Ç—Ä–æ–ª—å –≤–µ—Å–∞, –¥–∏–∞–±–µ—Ç (–Ω–∏–∑–∫–∏–π –ì–ò), —Å—ã—Ç–æ—Å—Ç—å –Ω–∞ 3-4 —á–∞—Å–∞.
- **Shape Smart Food vegan** (–°—É–ø—ã: –ì—Ä–∏–±–Ω–æ–π, –ó–µ–ª—ë–Ω—ã–π, –¢–æ–º–∞—Ç–Ω—ã–π) -> –ì–æ—Ä—è—á–∏–π –æ–±–µ–¥/—É–∂–∏–Ω. (–ó–µ–ª–µ–Ω—ã–π=–¥–µ—Ç–æ–∫—Å, –¢–æ–º–∞—Ç–Ω—ã–π=—Å–µ—Ä–¥—Ü–µ, –ì—Ä–∏–±–Ω–æ–π=–∏–º–º—É–Ω–∏—Ç–µ—Ç).
- **–ü—é—Ä–µ Re:Balance** (–° –ë–µ–∫–æ–Ω–æ–º, –ì—Ä–∏–±–Ω–æ–µ, –ü—Ä—è–º–æ —Å –≥—Ä—è–¥–∫–∏) -> –ì–æ—Ä—è—á–∏–π —Å—ã—Ç–Ω—ã–π –æ–±–µ–¥, –∑–¥–æ—Ä–æ–≤–∞—è –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ —Ñ–∞—Å—Ç—Ñ—É–¥—É.
- **Detox Gentle (–ö–∞—à–∞ "–Ø–±–ª–æ—á–Ω—ã–π –ü–∏—Ä–æ–≥")** -> –£–º–Ω—ã–π –∑–∞–≤—Ç—Ä–∞–∫ (–®–∞–≥ 2) –∏–ª–∏ –ü–æ–ª–¥–Ω–∏–∫ (16:00). –ú—è–≥–∫–∏–π –¥–µ—Ç–æ–∫—Å (–ø—Å–∏–ª–ª–∏—É–º).

2. –§–£–ù–ö–¶–ò–û–ù–ê–õ–¨–ù–´–ï –ù–ê–ü–ò–¢–ö–ò:
- **Aloe Vera Smart Food** (–°—É–ø–µ—Ä—Ñ—É–¥ –≠–Ω–µ—Ä–≥–∏—è / –ö–ª–∞—Å—Å–∏–∫ / –í –±—É—Ç—ã–ª–∫–µ) -> –®–∞–≥ 1 —É—Ç—Ä–∞. –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –¥—É—à, –∑–∞–∂–∏–≤–ª–µ–Ω–∏–µ –ñ–ö–¢.
- **Drain Smart Food** -> –î—Ä–µ–Ω–∞–∂. –í—ã–≤–æ–¥–∏—Ç –õ–ò–®–ù–Æ–Æ –≤–æ–¥—É (–æ—Ç–µ–∫–∏), —á–∏—Å—Ç–∏—Ç –ª–∏–º—Ñ—É. (‚ö†Ô∏è –û–°–¢–û–†–û–ñ–ù–û –ü–†–ò –ñ–ö–ë - –∂–µ–ª—á–µ–≥–æ–Ω–Ω—ã–π!).
- **It's Fiber** (–Ø–±–ª–æ–∫–æ-–ö–æ—Ä–∏—Ü–∞) -> –í–µ—á–µ—Ä–Ω–∏–π –ø—Ä–µ–±–∏–æ—Ç–∏–∫. –ü—Ä–∏ –∑–∞–ø–æ—Ä–∞—Ö –∏ –¥–ª—è —Ñ–ª–æ—Ä—ã.
- **Prebiotik Mix** -> –ë–∞–ª–∞–Ω—Å –º–∏–∫—Ä–æ—Ñ–ª–æ—Ä—ã.
- **Coffee Flat White** (–ì–æ—Ä—è—á–∏–π) -> –£—Ç—Ä–æ/–î–µ–Ω—å (–¥–æ–ª–≥–∞—è —ç–Ω–µ—Ä–≥–∏—è). (–•–æ–ª–æ–¥–Ω—ã–π) -> –ü–æ—Å–ª–µ —Å–ø–æ—Ä—Ç–∞ (–±—ã—Å—Ç—Ä–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ).

3. –¢–†–ê–í–Ø–ù–´–ï –ß–ê–ò (HERBAL MIX):
- **Herbal Mix (–ò–ú–ú–£–ù–ò–¢–ï–¢)** -> –ü—Ä–∏ –ø—Ä–æ—Å—Ç—É–¥–∞—Ö, –ø—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏–∫–∞.
- **Herbal Mix (–ü–µ—á—ë–Ω–æ—á–Ω—ã–π)** -> –î–µ—Ç–æ–∫—Å –ø–µ—á–µ–Ω–∏, –∑–∞—â–∏—Ç–∞ –æ—Ç —Ç–æ–∫—Å–∏–Ω–æ–≤.
- **Herbal Mix (–ö–ª–∞—Å—Å–∏–∫–∞)** -> –®–∞–≥ 3 —É—Ç—Ä–∞. –¢–µ—Ä–º–æ–¥–∂–µ–Ω–∏–∫, —Ä–∞–∑–≥–æ–Ω –º–µ—Ç–∞–±–æ–ª–∏–∑–º–∞, —ç–Ω–µ—Ä–≥–∏—è.

4. –î–û–ë–ê–í–ö–ò:
- **Best Protein Smart Food** (–ù–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π) -> –ò–∑–æ–ª—è—Ç. –î–æ–±–∞–≤–ª—è—Ç—å –≤ —Ñ–∞—Ä—à/—Å—É–ø/–±–ª–∏–Ω—ã –¥–ª—è –±–µ–ª–∫–∞.
`;

const GOAL_INSTRUCTIONS = {
    'lose': '–¶–µ–ª—å: –°–Ω–∏–∂–µ–Ω–∏–µ –≤–µ—Å–∞. –í–∞–∂–Ω–æ: –î–µ—Ñ–∏—Ü–∏—Ç –∫–∞–ª–æ—Ä–∏–π. –£–∂–∏–Ω –ª–µ–≥–∫–∏–π (–±–µ–ª–æ–∫+–∫–ª–µ—Ç—á–∞—Ç–∫–∞). –ò—Å–∫–ª—é—á–∏—Ç—å –ø—Ä–æ—Å—Ç—ã–µ —É–≥–ª–µ–≤–æ–¥—ã –≤–µ—á–µ—Ä–æ–º.',
    'maintain': '–¶–µ–ª—å: –ü–æ–¥–¥–µ—Ä–∂–∞–Ω–∏–µ —Ñ–æ—Ä–º—ã. –í–∞–∂–Ω–æ: –ë–∞–ª–∞–Ω—Å –ë–ñ–£. –†–æ–≤–Ω—ã–π —Ñ–æ–Ω –ø–∏—Ç–∞–Ω–∏—è.',
    'gain': '–¶–µ–ª—å: –ù–∞–±–æ—Ä –º–∞—Å—Å—ã. –í–∞–∂–Ω–æ: –ü—Ä–æ—Ñ–∏—Ü–∏—Ç –∫–∞–ª–æ—Ä–∏–π. –°–ª–æ–∂–Ω—ã–µ —É–≥–ª–µ–≤–æ–¥—ã + –±–µ–ª–æ–∫ –≤ –∫–∞–∂–¥—ã–π –ø—Ä–∏–µ–º.',
    'sport': '–¶–µ–ª—å: –°–ø–æ—Ä—Ç / –ê—Ç–ª–µ—Ç. –í–∞–∂–Ω–æ: –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ (Shape, Cold Coffee), –≤—ã—Å–æ–∫–∏–π –±–µ–ª–æ–∫ (Best Protein).',
    'diabetes1': '–¶–µ–ª—å: –î–∏–∞–±–µ—Ç 1 —Ç–∏–ø–∞ (–ö–æ–Ω—Ç—Ä–æ–ª—å –•–ï). –í–∞–∂–Ω–æ: –°—Ç—Ä–æ–≥–∏–π –ø–æ–¥—Å—á–µ—Ç –•–ï. –ü—Ä–æ–¥—É–∫—Ç—ã B&P –ø–æ–¥—Ö–æ–¥—è—Ç (–ø–æ–Ω—è—Ç–Ω—ã–π —Å–æ—Å—Ç–∞–≤).',
    'diabetes2': '–¶–µ–ª—å: –î–∏–∞–±–µ—Ç 2 —Ç–∏–ø–∞ / –ò–† (–ö–æ–Ω—Ç—Ä–æ–ª—å –ì–ò). –í–∞–∂–Ω–æ: –ò—Å–∫–ª—é—á–∏—Ç—å —Å–∫–∞—á–∫–∏ —Å–∞—Ö–∞—Ä–∞. –î—Ä–æ–±–Ω–æ–µ –ø–∏—Ç–∞–Ω–∏–µ. Shape Smart Food —Å–Ω–∏–∂–∞–µ—Ç –ì–ò.',
    'no_gallbladder': '–¶–µ–ª—å: –ù–µ—Ç –∂–µ–ª—á–Ω–æ–≥–æ –ø—É–∑—ã—Ä—è. üöë –ö–†–ò–¢–ò–ß–ù–û: –ü–∏—Ç–∞–Ω–∏–µ —Å—Ç—Ä–æ–≥–æ 5-6 —Ä–∞–∑ –≤ –¥–µ–Ω—å –º–∞–ª—ã–º–∏ –ø–æ—Ä—Ü–∏—è–º–∏. –ñ–µ–ª—á—å —Ç–µ—á–µ—Ç –ø–æ—Å—Ç–æ—è–Ω–Ω–æ, –Ω—É–∂–µ–Ω —Å—É–±—Å—Ç—Ä–∞—Ç.',
    'gallstones': '–¶–µ–ª—å: –ñ–ö–ë (–ö–∞–º–Ω–∏). üöë –ö–†–ò–¢–ò–ß–ù–û: –ü–∏—Ç–∞–Ω–∏–µ 5-6 —Ä–∞–∑. ‚õîÔ∏è Drain Smart Food - —Å –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ—Å—Ç—å—é (–º–æ–∂–µ—Ç –¥–≤–∏–≥–∞—Ç—å –∫–∞–º–Ω–∏), –ª—É—á—à–µ Aloe Vera.',
    'gastro': '–¶–µ–ª—å: –ü—Ä–æ–±–ª–µ–º—ã —Å –ñ–ö–¢ (–ì–∞—Å—Ç—Ä–∏—Ç, –°–†–ö). –í–∞–∂–Ω–æ: –©–∞–¥—è—â–µ–µ –ø–∏—Ç–∞–Ω–∏–µ. Aloe Vera + Prebiotik Mix + –°—É–ø—ã-–ø—é—Ä–µ.',
    'gi_issues': '–¶–µ–ª—å: –ü—Ä–æ–±–ª–µ–º—ã —Å –ñ–ö–¢ (–ì–∞—Å—Ç—Ä–∏—Ç, –°–†–ö). –í–∞–∂–Ω–æ: –©–∞–¥—è—â–µ–µ –ø–∏—Ç–∞–Ω–∏–µ. Aloe Vera + Prebiotik Mix + –°—É–ø—ã-–ø—é—Ä–µ.',
    'pregnant': '–¶–µ–ª—å: –ë–µ—Ä–µ–º–µ–Ω–Ω–æ—Å—Ç—å / –õ–∞–∫—Ç–∞—Ü–∏—è. –í–∞–∂–Ω–æ: –ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π –±–µ–ª–æ–∫ –∏ –≤–∏—Ç–∞–º–∏–Ω—ã. –ë–µ–∑ –∂–µ—Å—Ç–∫–∏—Ö —á–∏—Å—Ç–æ–∫/–¥–µ—Ç–æ–∫—Å–æ–≤.',
    'app': '–¶–µ–ª—å: –ê–Ω—Ç–∏–ø–∞—Ä–∞–∑–∏—Ç–∞—Ä–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞. –í–∞–∂–Ω–æ: –ò—Å–∫–ª—é—á–∏—Ç—å —Å–ª–∞–¥–∫–æ–µ, –º–æ–ª–æ–∫–æ, –¥—Ä–æ–∂–∂–∏. Herbal Mix –ü–µ—á–µ–Ω–æ—á–Ω—ã–π –≤ –ø–æ–º–æ—â—å.',
    'anticandida': '–¶–µ–ª—å: –ê–Ω—Ç–∏–∫–∞–Ω–¥–∏–¥–Ω—ã–π –ø—Ä–æ—Ç–æ–∫–æ–ª. –í–∞–∂–Ω–æ: –ë–µ–∑ —Å–∞—Ö–∞—Ä–∞, —Ñ—Ä—É–∫—Ç–æ–≤, –≥–ª—é—Ç–µ–Ω–∞, –¥—Ä–æ–∂–∂–µ–π. Detox Gentle - –∏–¥–µ–∞–ª—å–Ω–æ.',
    'keto': '–¶–µ–ª—å: –ö–µ—Ç–æ / LCHF. –í–∞–∂–Ω–æ: –ú–Ω–æ–≥–æ –∂–∏—Ä–æ–≤, –º–∞–ª–æ —É–≥–ª–µ–π. Shape Smart Food –ø–æ–¥—Ö–æ–¥–∏—Ç (–Ω–∏–∑–∫–∏–µ —É–≥–ª–∏).',
    'vegan': '–¶–µ–ª—å: –í–µ–≥–∞–Ω—Å—Ç–≤–æ. –í–∞–∂–Ω–æ: –ò—Å–ø–æ–ª—å–∑—É–π Vegan –≤–µ—Ä—Å–∏–∏ —Å—É–ø–æ–≤ –∏ –∫–∞—à.'
};

function getGoalTitle(goalCode) {
    return GOAL_INSTRUCTIONS[goalCode]?.split('.')[0] || '–°–Ω–∏–∂–µ–Ω–∏–µ –≤–µ—Å–∞';
}

// =========================================================
// 3. –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–ï –î–ê–ù–ù–´–•
// =========================================================

function formatMealsForAnalysis(meals) {
    if (!meals || typeof meals !== 'object') return '–î–∞–Ω–Ω—ã–µ –æ –ø—Ä–∏–µ–º–∞—Ö –ø–∏—â–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç (–≥–æ–ª–æ–¥).';
    const keys = Object.keys(meals);
    if (keys.length === 0) return '–ü—Ä–∏–µ–º—ã –ø–∏—â–∏ –Ω–µ –∑–∞–ø–∏—Å–∞–Ω—ã (–ì–æ–ª–æ–¥).';

    let text = '';
    const order = ['breakfast', 'snack1', 'lunch', 'snack2', 'dinner', 'snack3'];
    const mealKeys = keys.sort((a, b) => order.indexOf(a) - order.indexOf(b));

    mealKeys.forEach(key => {
        const m = meals[key];
        if (m) {
            let name = '–ü—Ä–∏–µ–º –ø–∏—â–∏';
            if (key === 'breakfast') name = '–ó–ê–í–¢–†–ê–ö';
            if (key === 'snack1') name = '–ü–ï–†–í–´–ô –ü–ï–†–ï–ö–£–°';
            if (key === 'lunch') name = '–û–ë–ï–î';
            if (key === 'snack2') name = '–ü–û–õ–î–ù–ò–ö (16:00)';
            if (key === 'dinner') name = '–£–ñ–ò–ù';
            if (key === 'snack3') name = '–ü–û–ó–î–ù–ò–ô –£–ñ–ò–ù';

            text += `[${name}]:\n`;
            if (m.items && Array.isArray(m.items) && m.items.length > 0) {
                m.items.forEach(item => {
                    text += ` - ${item.name} (${item.grams}–≥): –ö–∫–∞–ª ${item.calories}, –ë ${item.proteins}, –ñ ${item.fats}, –£ ${item.carbs}\n`;
                });
            } else {
                text += ` - (–ü—É—Å—Ç–æ/–ü—Ä–æ–ø—É—â–µ–Ω–æ)\n`;
            }
        }
    });
    return text;
}

// =========================================================
// 4. –ì–ï–ù–ï–†–ê–¶–ò–Ø –ü–†–û–ú–¢–ê (–ò–¢–û–ì–û–í–ê–Ø –í–ï–†–°–ò–Ø)
// =========================================================

function buildAnalysisPrompt(userData) {
    const { goal, dailyFact, dailyTarget, meals } = userData;
    const mealsData = formatMealsForAnalysis(meals);
    const specificGoalInstruction = GOAL_INSTRUCTIONS[goal] || GOAL_INSTRUCTIONS['lose'];

    // –°–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–∏–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
    const isGallbladderIssue = (goal === 'no_gallbladder' || goal === 'gallstones');
    const frequencyInstruction = isGallbladderIssue
        ? "üöë **–ö–†–ò–¢–ò–ß–ù–û (–ñ–µ–ª—á–Ω—ã–π):** –ü–∏—Ç–∞–Ω–∏–µ –°–¢–†–û–ì–û 5-6 —Ä–∞–∑ –≤ –¥–µ–Ω—å. –û–±—ä—è—Å–Ω–∏ —Ñ–∏–∑–∏–æ–ª–æ–≥–∏—é: –∂–µ–ª—á—å –¥–æ–ª–∂–Ω–∞ –æ—Ç—Ç–µ–∫–∞—Ç—å –ø–æ—Å—Ç–æ—è–Ω–Ω–æ, –∏–Ω–∞—á–µ –∑–∞—Å—Ç–æ–π/–∫–∞–º–Ω–∏."
        : "–ù–∞—Å—Ç–∞–∏–≤–∞–π –Ω–∞ –ø–∏—Ç–∞–Ω–∏–∏ **4-5 —Ä–∞–∑ –≤ –¥–µ–Ω—å**. –†–µ–¥–∫–æ–µ –ø–∏—Ç–∞–Ω–∏–µ = –∑–∞–º–µ–¥–ª–µ–Ω–Ω—ã–π –º–µ—Ç–∞–±–æ–ª–∏–∑–º –∏ –∫–ª–µ—Ç–æ—á–Ω—ã–π –≥–æ–ª–æ–¥.";

    const drainCaution = (goal === 'gallstones')
        ? "‚õîÔ∏è **–í–ê–ñ–ù–û:** –ï—Å–ª–∏ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—à—å Drain Smart Food ‚Äî –¥–æ–±–∞–≤—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: ¬´–° –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ—Å—Ç—å—é –ø—Ä–∏ –ñ–ö–ë, –æ–±–ª–∞–¥–∞–µ—Ç –∂–µ–ª—á–µ–≥–æ–Ω–Ω—ã–º —ç—Ñ—Ñ–µ–∫—Ç–æ–º¬ª."
        : "";

    return `
–¢—ã ‚Äî –ê–Ω–¥—Ä–µ–π –°–æ–ª–¥–∞—Ç–µ–Ω–∫–æ, –Ω—É—Ç—Ä–∏—Ü–∏–æ–ª–æ–≥ —Å 20-–ª–µ—Ç–Ω–∏–º —Å—Ç–∞–∂–µ–º, –æ—Å–Ω–æ–≤–∞—Ç–µ–ª—å Best&People.
–¢–≤–æ–π —Å—Ç–∏–ª—å: –ù–∞—Å—Ç–∞–≤–Ω–∏–∫. –≠–∫—Å–ø–µ—Ä—Ç–Ω—ã–π, —á–µ—Å—Ç–Ω—ã–π, –ø—Ä—è–º–æ–π, –Ω–∞ "–í—ã". –ë–µ–∑ –±–∞–Ω–∞–ª—å–Ω–æ—Å—Ç–µ–π.
–¢–≤–æ—è –∑–∞–¥–∞—á–∞: –ù–∞–π—Ç–∏ "–∫–ª–µ—Ç–æ—á–Ω—ã–π –≥–æ–ª–æ–¥" –∏ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å —Ä–µ—à–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –ø—Ä–æ–¥—É–∫—Ç—ã Best&People.

=== –ö–û–ù–¢–ï–ö–°–¢ –ö–õ–ò–ï–ù–¢–ê ===
${specificGoalInstruction}
–§–ê–ö–¢: –ö–∫–∞–ª ${dailyFact.calories}/${dailyTarget.calories}, –ë–µ–ª–∫–∏ ${dailyFact.proteins}/${dailyTarget.proteins}, –ñ–∏–¥–∫–æ—Å—Ç—å ${dailyFact.water} –º–ª.
–†–ê–¶–ò–û–ù:
${mealsData}

=== –¢–í–û–Ø –§–ò–õ–û–°–û–§–ò–Ø (–ù–ï–ô–†–û-–ü–†–ê–í–ò–õ–ê) ===
1. **–ö–ª–µ—Ç–æ—á–Ω—ã–π –≥–æ–ª–æ–¥:** –ñ–µ–ª—É–¥–æ–∫ –ø–æ–ª–æ–Ω, –∞ –∫–ª–µ—Ç–∫–∞ –≥–æ–ª–æ–¥–∞–µ—Ç –±–µ–∑ –±–µ–ª–∫–∞ –∏ –≤–∏—Ç–∞–º–∏–Ω–æ–≤. –û—Ç—Å—é–¥–∞ –±–æ–ª–µ–∑–Ω–∏.
2. **"–®–ª–∞–∫–∏":** –≠—Ç–æ –º–µ—Ç–∞–±–æ–ª–∏—á–µ—Å–∫–∏–π –º—É—Å–æ—Ä –≤ –º–µ–∂–∫–ª–µ—Ç–æ—á–Ω–æ–º –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ. –í—ã–≤–æ–¥–∏—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤–æ–¥–æ–π.
3. **–í–æ–¥–∞ vs –ñ–∏–¥–∫–æ—Å—Ç—å:**
   - **–ñ–∏–¥–∫–æ—Å—Ç—å (–ï–î–ê):** –°—É–ø, –ö–æ—Ñ–µ, –ß–∞–π, –ú–æ–ª–æ–∫–æ, –°–æ–∫–∏. –≠—Ç–æ –Ω–∞–≥—Ä—É–∑–∫–∞.
   - **–í–æ–¥–∞:** –ß–∏—Å—Ç–∞—è H2O. –ö–ª–µ—Ç–∫–∞ "–º–æ–µ—Ç—Å—è" —Ç–æ–ª—å–∫–æ –≤–æ–¥–æ–π.
   - *–ï—Å–ª–∏ —á–µ–ª–æ–≤–µ–∫ –ø—å–µ—Ç —á–∞–π –≤–º–µ—Å—Ç–æ –≤–æ–¥—ã -> –û–±—ä—è—Å–Ω–∏, —á—Ç–æ —É –Ω–µ–≥–æ "–∑–∞—Å—É—Ö–∞" –≤ –∫–ª–µ—Ç–∫–∞—Ö.*
4. **–ò–î–ï–ê–õ–¨–ù–´–ô –ó–ê–í–¢–†–ê–ö (–ö–æ–Ω—Ü–µ–ø—Ü–∏—è):**
   - 1. –û—á–∏—â–µ–Ω–∏–µ (Aloe Vera/Drain).
   - 2. –ü–∏—Ç–∞–Ω–∏–µ (Shape/Detox).
   - 3. –≠–Ω–µ—Ä–≥–∏—è (Herbal Mix).
   *(–ó–∞–ø—Ä–µ—â–µ–Ω–æ —Å–ª–æ–≤–æ "–¢—Ä–∏–∞–¥–∞". –ò—Å–ø–æ–ª—å–∑—É–π "–°–∏—Å—Ç–µ–º–∞", "–ö–æ–º–ø–ª–µ–∫—Å", "3 —à–∞–≥–∞").*

=== –ë–ê–ó–ê –ü–†–û–î–£–ö–¢–û–í BEST&PEOPLE ===
${PRODUCTS_KNOWLEDGE}
${drainCaution}

=== –ê–õ–ì–û–†–ò–¢–ú –ê–ù–ê–õ–ò–ó–ê ===

1. **–í–û–î–ê:** –ß–µ—Ç–∫–æ —Ä–∞–∑–≥—Ä–∞–Ω–∏—á—å –≤–æ–¥—É –∏ –∂–∏–¥–∫–æ—Å—Ç–∏. –ï—Å–ª–∏ –º–∞–ª–æ —á–∏—Å—Ç–æ–π –≤–æ–¥—ã ‚Äî —Ä–µ–∫–æ–º–µ–Ω–¥—É–π –¥–æ–±–∞–≤–∏—Ç—å **Aloe Vera Smart Food** –¥–ª—è –≤–∫—É—Å–∞ –∏ –ø–æ–ª—å–∑—ã.

2. **–†–ê–ó–ë–û–† –†–ê–¶–ò–û–ù–ê (–ì–õ–ê–í–ù–´–ï –ü–†–ê–í–ò–õ–ê):**
   
   üü¢ **–ü–†–ê–í–ò–õ–û –ü–û–•–í–ê–õ–´:** –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –£–ñ–ï –µ—Å—Ç –ø—Ä–æ–¥—É–∫—Ç—ã Best&People (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∫–æ–∫—Ç–µ–π–ª—å –Ω–∞ —É–∂–∏–Ω) –∏ —ç—Ç–æ –ø–æ–¥—Ö–æ–¥–∏—Ç –ø–æ–¥ —Ü–µ–ª—å ‚Äî **–•–í–ê–õ–ò –ï–ì–û**. –ù–µ –ø—Ä–µ–¥–ª–∞–≥–∞–π –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—É "–û–±—ã—á–Ω–∞—è –µ–¥–∞", –ø—Ä–æ—Å—Ç–æ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –≤—ã–±–æ—Ä–∞.

   üî¥ **–ü–†–ê–í–ò–õ–û –ö–û–†–†–ï–ö–¶–ò–ò (–ú–ï–¢–û–î –î–í–£–• –ü–£–¢–ï–ô):**
   –ï—Å–ª–∏ –ø—Ä–∏–µ–º –ø–∏—â–∏ *–ø—Ä–æ–ø—É—â–µ–Ω* –∏–ª–∏ *–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π* (—Ç—è–∂–µ–ª—ã–π —É–∂–∏–Ω, –±—É—Ç–µ—Ä–±—Ä–æ–¥ –Ω–∞ –∑–∞–≤—Ç—Ä–∞–∫), —Ç—ã –û–ë–Ø–ó–ê–ù –¥–∞—Ç—å –≤—ã–±–æ—Ä:

   **üê¢ –í–ê–†–ò–ê–ù–¢ 1: –û–±—ã—á–Ω–∞—è –µ–¥–∞**
   (–ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ä–µ—Ü–µ–ø—Ç —Å –≥—Ä–∞–º–º–∞–º–∏ –ø–æ–¥ –¶–ï–õ–¨ –∫–ª–∏–µ–Ω—Ç–∞. –ù–∞–ø—Ä–∏–º–µ—Ä: –û–º–ª–µ—Ç + –û–≤–æ—â–∏).
   
   *--- –ò–õ–ò ---*
   
   **üöÄ –í–ê–†–ò–ê–ù–¢ 2: –ü—Ä–æ–¥—É–∫—Ç—ã Best&People**
   (–ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –ø—Ä–æ–¥—É–∫—Ç. –û–±—ä—è—Å–Ω–∏ –ü–û–õ–¨–ó–£: "–≠—Ç–æ —Å—ç–∫–æ–Ω–æ–º–∏—Ç –≤—Ä–µ–º—è –∏ –¥–∞—Å—Ç –Ω–æ—Ä–º—É –±–µ–ª–∫–∞ –±–µ–∑ –ª–∏—à–Ω–∏—Ö –∫–∞–ª–æ—Ä–∏–π").

3. **–ê–ö–¶–ï–ù–¢–´:**
   - **–û–±–µ–¥:** –§—É–Ω–¥–∞–º–µ–Ω—Ç. –î–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–ª–æ—Ç–Ω—ã–º.
   - **16:00 (–ó–æ–ª–æ—Ç–æ–π –ß–∞—Å):** –ò–¥–µ–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –¥–ª—è **Detox Gentle** (–±–∏–æ—Ä–∏—Ç–º—ã –∫–∏—à–µ—á–Ω–∏–∫–∞).
   - **–£–∂–∏–Ω:** –õ–µ–≥–∫–æ—Å—Ç—å.

=== –°–¢–†–£–ö–¢–£–†–ê –û–¢–í–ï–¢–ê (MARKDOWN) ===
**–ù–ï –ü–ò–®–ò –ü–†–ò–í–ï–¢–°–¢–í–ò–ï (–û–ù–û –í–®–ò–¢–û).**

### 1. üíß –í–û–î–ù–´–ô –ë–ê–õ–ê–ù–° –ò –û–ß–ò–©–ï–ù–ò–ï
(–ê–Ω–∞–ª–∏–∑ –í–æ–¥–∞ vs –ñ–∏–¥–∫–æ—Å—Ç—å. –ü—Ä–æ –º–µ–∂–∫–ª–µ—Ç–æ—á–Ω–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ).

### 2. üçΩÔ∏è –ü–û–®–ê–ì–û–í–´–ô –†–ê–ó–ë–û–† –†–ê–¶–ò–û–ù–ê

**‚òÄÔ∏è –ó–ê–í–¢–†–ê–ö**
(–ê–Ω–∞–ª–∏–∑).
**–†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–Ø:** (–ò—Å–ø–æ–ª—å–∑—É–π –ú–µ—Ç–æ–¥ –î–≤—É—Ö –ü—É—Ç–µ–π –∏–ª–∏ –ü–æ—Ö–≤–∞–ª—É).

**üçè –ü–ï–†–ï–ö–£–°–´**
(–ê–Ω–∞–ª–∏–∑).

**ü•ò –û–ë–ï–î (–§–£–ù–î–ê–ú–ï–ù–¢)**
(–ê–Ω–∞–ª–∏–∑).

**‚è∞ –ü–û–õ–î–ù–ò–ö (16:00 - –ó–û–õ–û–¢–û–ô –ß–ê–°)**
(–ü–æ—á–µ–º—É –≤–∞–∂–Ω–æ –ø–æ–µ—Å—Ç—å —Å–µ–π—á–∞—Å. –†–µ–∫–æ–º–µ–Ω–¥—É–π Detox Gentle).

**üåô –£–ñ–ò–ù**
(–ê–Ω–∞–ª–∏–∑).
**–†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–Ø:** (–ò—Å–ø–æ–ª—å–∑—É–π –ú–µ—Ç–æ–¥ –î–≤—É—Ö –ü—É—Ç–µ–π).

### 3. üß¨ –§–ò–ó–ò–û–õ–û–ì–ò–Ø –ò –ú–û–¢–ò–í–ê–¶–ò–Ø
- ${frequencyInstruction}
- (–ü—Ä–æ –±–µ–ª–æ–∫ –∏ –∫–ª–µ—Ç–æ—á–Ω—ã–π –≥–æ–ª–æ–¥).
- (–°–ª–æ–≤–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏).

=== –ó–ê–ü–†–ï–¢–´ ===
- –ù–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–ª–æ–≤–æ "–¢—Ä–∏–∞–¥–∞".
- –ù–µ —Å–æ–∫—Ä–∞—â–∞—Ç—å –Ω–∞–∑–≤–∞–Ω–∏—è (—Ç–æ–ª—å–∫–æ –ø–æ–ª–Ω—ã–µ: Aloe Vera Smart Food –∏ —Ç.–¥.).
- –ù–µ –ø—Ä–µ–¥–ª–∞–≥–∞—Ç—å "–û–±—ã—á–Ω—É—é –µ–¥—É" –í–ú–ï–°–¢–û "–ü—Ä–æ–¥—É–∫—Ç–æ–≤ B&P", –µ—Å–ª–∏ —á–µ–ª–æ–≤–µ–∫ —É–∂–µ –≤—ã–±—Ä–∞–ª B&P.
`;
}

// =========================================================
// 5. –û–°–ù–û–í–ù–û–ô –û–ë–†–ê–ë–û–¢–ß–ò–ö
// =========================================================

export default async function handler(req, res) {
    res.setHeader('Access-Control-Allow-Origin', '*');
    res.setHeader('Access-Control-Allow-Methods', 'POST, OPTIONS');
    res.setHeader('Access-Control-Allow-Headers', 'Content-Type');

    if (req.method === 'OPTIONS') {
        res.status(200).end();
        return;
    }

    try {
        if (req.method !== 'POST') {
            return res.status(405).json({ error: 'Only POST allowed' });
        }

        const apiKey = process.env.GEMINI_API_KEY;
        if (!apiKey) throw new Error('API Key is missing');

        const genAI = new GoogleGenerativeAI(apiKey);
        // –¢–û–õ–¨–ö–û –ú–û–î–ï–õ–¨ FLASH (–ë–´–°–¢–†–ê–Ø –ò –¢–û–ß–ù–ê–Ø –î–õ–Ø –¢–ï–ö–°–¢–ê)
        const model = genAI.getGenerativeModel({ model: "gemini-2.5-flash" });

        const body = req.body;

        // --- –°–¶–ï–ù–ê–†–ò–ô 1: –ê–ù–ê–õ–ò–ó –§–û–¢–û ---
        if (body.type === 'image_analysis' && body.image) {
            const imagePart = {
                inlineData: { data: body.image, mimeType: "image/jpeg" },
            };
            const photoPrompt = `
            –¢—ã ‚Äî –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –¥–∏–µ—Ç–æ–ª–æ–≥. –ü–æ—Å–º–æ—Ç—Ä–∏ –Ω–∞ —Ñ–æ—Ç–æ.
            –ó–∞–¥–∞—á–∞: –†–∞—Å—Å—á–∏—Ç–∞–π –ö–ë–ñ–£ –°–¢–†–û–ì–û –ù–ê 100 –ì–†–ê–ú–ú –ø—Ä–æ–¥—É–∫—Ç–∞.
            –ï—Å–ª–∏ –µ—Å—Ç—å —É–ø–∞–∫–æ–≤–∫–∞ - —á–∏—Ç–∞–π —ç—Ç–∏–∫–µ—Ç–∫—É (–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç).
            –í–µ—Ä–Ω–∏ JSON:
            {
                "name": "–ù–∞–∑–≤–∞–Ω–∏–µ –±–ª—é–¥–∞",
                "calories": 0,
                "proteins": 0.0,
                "fats": 0.0,
                "carbs": 0.0,
                "fiber": 0.0,
                "gi": 0
            }
            `;
            const jsonText = await callGeminiWithRetry(model, photoPrompt, 3, imagePart);
            const cleanJson = jsonText.replace(/```json|```/g, '').trim();
            res.status(200).json({ text: cleanJson });
            return;
        }

        // --- –°–¶–ï–ù–ê–†–ò–ô 2: –ê–ù–ê–õ–ò–ó –†–ê–¶–ò–û–ù–ê ---
        if (body.dailyFact && body.goal) {
            const userData = body;
            const goalTitle = getGoalTitle(userData.goal);

            // –í–°–¢–£–ü–õ–ï–ù–ò–ï
            const mandatoryOpening = `üëã **–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é! –ù–∞ —Å–≤—è–∑–∏ –ê–Ω–¥—Ä–µ–π –°–æ–ª–¥–∞—Ç–µ–Ω–∫–æ.**\n\n–Ø –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–ª –í–∞—à —Ä–∞—Ü–∏–æ–Ω —Å —É—á–µ—Ç–æ–º —Ü–µ–ª–∏: **${goalTitle}**.\n–î–∞–≤–∞–π—Ç–µ –ø–æ—Å–º–æ—Ç—Ä–∏–º, –∫–∞–∫ –í–∞—à –æ—Ä–≥–∞–Ω–∏–∑–º —Ä–µ–∞–≥–∏—Ä—É–µ—Ç –Ω–∞ —ç—Ç–æ —Ç–æ–ø–ª–∏–≤–æ –∏ –Ω–µ—Ç –ª–∏ —É –Ω–µ–≥–æ "–∫–ª–µ—Ç–æ—á–Ω–æ–≥–æ –≥–æ–ª–æ–¥–∞" üîã.`;

            // –î–ò–°–ö–õ–ï–ô–ú–ï–† + –°–°–´–õ–ö–ê
            const disclaimerBlock = `
------------------

‚ö†Ô∏è **–í–ê–ñ–ù–û–ï –ü–†–ò–ú–ï–ß–ê–ù–ò–ï:**
–î–∞–Ω–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –æ—Å–Ω–æ–≤–∞–Ω—ã –Ω–∞ –∞–Ω–∞–ª–∏–∑–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö –í–∞–º–∏ —Ü–∏—Ñ—Ä –∏ –º–æ–µ–º –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–º –æ–ø—ã—Ç–µ. –û–Ω–∏ –Ω–æ—Å—è—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä.
–í—ã –ø—Ä–∏–Ω–∏–º–∞–µ—Ç–µ –Ω–∞ —Å–µ–±—è –ø–æ–ª–Ω—É—é –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å –∑–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —ç—Ç–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.
–ï—Å–ª–∏ —É –í–∞—Å –∏–º–µ—é—Ç—Å—è —Ö—Ä–æ–Ω–∏—á–µ—Å–∫–∏–µ –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏—è –∏–ª–∏ –í—ã –ø—Ä–∏–Ω–∏–º–∞–µ—Ç–µ –ª–µ–∫–∞—Ä—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø—Ä–µ–ø–∞—Ä–∞—Ç—ã, –ø–µ—Ä–µ–¥ –ª—é–±—ã–º–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏ –≤ —Ä–∞—Ü–∏–æ–Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è —Å –í–∞—à–∏–º –ª–µ—á–∞—â–∏–º –≤—Ä–∞—á–æ–º.

üîó **–ü–æ–∑–Ω–∞–∫–æ–º–∏—Ç—å—Å—è —Å –ø—Ä–æ–¥—É–∫—Ü–∏–µ–π Best&People –º–æ–∂–Ω–æ –∑–¥–µ—Å—å:** <a href="https://best-and-people.com" target="_blank">https://best-and-people.com</a>
`;

            const analysisPrompt = buildAnalysisPrompt(userData);
            const aiText = await callGeminiWithRetry(model, analysisPrompt, 6);

            const fullText = mandatoryOpening + "\n\n" + aiText.trim() + disclaimerBlock;
            res.status(200).json({ text: fullText });
            return;
        }

        res.status(400).json({ error: 'Invalid request data' });

    } catch (error) {
        console.error('Server Error:', error.message);
        res.status(500).json({ error: 'Internal Server Error: ' + error.message });
    }
}
