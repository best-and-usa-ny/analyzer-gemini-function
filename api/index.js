// /api/index.js

import { GoogleGenerativeAI } from '@google/generative-ai';

export const config = {
    api: { bodyParser: true },
};

// --- УТИЛИТА: Экспоненциальная задержка (Retry Logic) ---
// Используем устойчивую логику повторных попыток для обработки ошибок 429/503
const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));

async function callGeminiWithRetry(model, prompt, retries = 3) {
    let delay = 2000;
    for (let i = 0; i < retries; i++) {
        try {
            const result = await model.generateContent(prompt);
            return result.response.text();
        } catch (err) {
            if (i === retries - 1) throw err;
            // Повторяем только при временных ошибках сервера или перегрузке
            if (err.message.includes('503') |

| err.message.includes('429') |
| err.message.includes('overloaded')) {
                console.warn(`Gemini 2.5 Flash перегружен. Попытка ${i + 1} из ${retries}...`);
                await sleep(delay);
                delay = Math.min(delay * 1.5, 10000); // Cap delay at 10s
            } else {
                throw err; // Фатальная ошибка (например, неверный ключ)
            }
        }
    }
}

// --- УТИЛИТА: Форматирование приемов пищи ---
// Этот текст видит ТОЛЬКО нейросеть для анализа. Пользователю он не выводится.
function formatMealsForPrompt(meals) {
    if (!meals |

| Object.keys(meals).length === 0) return 'Приемы пищи не записаны (клиент голодал).';
    let mealSummary = '';
    for (const mealKey in meals) {
        const meal = meals[mealKey];
        mealSummary += `\n[Прием: ${meal.name}]\n`;
        if (meal.items && meal.items.length > 0) {
            meal.items.forEach(item => {
                mealSummary += ` - ${item.name}: ${item.grams}г (Ккал:${item.calories}, Б:${item.proteins}, Ж:${item.fats}, У:${item.carbs})\n`;
            });
        } else {
            mealSummary += ` - (Пусто/Пропуск)\n`;
        }
    }
    return mealSummary;
}

// --- СТРАТЕГИЧЕСКИЙ БЛОК: Цели и Физиология ---
// Определяет "линзу", через которую ИИ смотрит на рацион
function getGoalInfo(goalCode) {
    const goals = {
        'lose': { 
            title: 'Снижение веса', 
            strategy: 'Главный враг — инсулиновые пики вечером. Пропуск полдника (16:00) ведет к срыву. Задача: дефицит калорий без голода клеток. Ужин должен быть легким (Shape/Пюре). "Не кормить паразитов" сахаром.'
        },
        'maintain': { 
            title: 'Поддержание формы', 
            strategy: 'Баланс БЖУ. Задача: удержать вес, заменяя "пустые" калории на функциональные. Клеточный голод недопустим.' 
        },
        'gain': { 
            title: 'Набор мышечной массы', 
            strategy: 'Профицит калорий и белка. Питание каждые 3 часа. Белок = строительный материал для ДНК. B&P продукты идут ДОПОЛНИТЕЛЬНО к обычной еде.' 
        },
        'diabetes1': { 
            title: 'Контроль диабета 1 типа', 
            strategy: 'Строгий контроль Хлебных Единиц (ХЕ). Никаких быстрых углеводов. Акцент на клетчатку (It\'s Fiber) для сглаживания сахарной кривой.' 
        },
        'diabetes2': { 
            title: 'Контроль диабета 2 типа / ИР', 
            strategy: 'Низкая Гликемическая Нагрузка. Убираем скачки сахара. Дробное питание. Shape Smart Food идеально гасит аппетит и не поднимает инсулин.' 
        },
        'no_gallbladder': { 
            title: 'Питание без желчного пузыря', 
            strategy: 'КРИТИЧНО: Дробное питание (5-6 раз). Желчь течет постоянно, голод = химический ожог кишечника. Еда должна быть теплой. Голодать нельзя!' 
        },
        'gallstones': { 
            title: 'Питание при ЖКБ', 
            strategy: 'Регулярный отток желчи. Не делать больших перерывов (>4 часов). Жиры нужны, но качественные. Травы/горечи (Herbal Mix) обязательны для оттока.' 
        },
        'gi_issues': { 
            title: 'Здоровье ЖКТ', 
            strategy: 'Щадящее питание. Aloe Vera — база для заживления слизистой. Исключить грубую пищу и раздражители.' 
        },
        'app': { 
            title: 'Антипаразитарная программа', 
            strategy: 'ЖЕСТКИЙ ЗАПРЕТ: Сахар, Молоко, Дрожжи, Глютен, Сладкие фрукты. Иначе кормим паразитов. Фокус на выведение токсинов (Drain).' 
        },
        'anticandida': { 
            title: 'Антикандидный протокол', 
            strategy: 'Аналогично АПП. Грибки (Кандида) любят сладкое и мучное. Акцент на детокс (Drain, Aloe, Herbal) и защелачивание.' 
        },
        'vegan_veg': { 
            title: 'Веганство', 
            strategy: 'Растительный белок. Внимание к аминокислотному профилю. Shape Vegan обязателен для восполнения дефицитов.' 
        }
    };
    return goals[goalCode] |

| goals['lose'];
}

// --- БАЗА ЗНАНИЙ ПРОДУКТОВ (Источник истины) ---
// Содержит точные КБЖУ и инструкции по приготовлению из 
function getProductKnowledgeBase() {
    return `
   
    Используй эти данные для рекомендаций. Обрати внимание на температуры!

    1. **Aloe Vera Smart Food (Классик / Энергия)**
       - *Суть:* "Душ" для клеток, запуск ЖКТ, очищение межклеточного пространства.
       - *Приготовление:* 1 ч.л. (4.5г) + 100-150мл теплой воды (50-70°C). Пить натощак. (Кипяток убивает пользу!).
    
    2. **Shape Smart Food (Коктейли: Клубника, Капучино, Дыня, Шоколад)**
       - *Суть:* Полноценная еда (замена приема). Изолят белка (ДНК клеток), витамины, фосфолипиды.
       - *Приготовление:* 2 ст.л. (25г) + 250мл воды/молока. Взбить в шейкере.
    
    3. **Shape Smart Food Vegan (Супы: Грибной, Зеленый, Томатный)**
       - *Суть:* Горячий обед/ужин без лактозы. Белок + клетчатка.
       - *Приготовление:* 25г + 200мл горячей воды.
    
    4. **Пюре Re:Balance (С Беконом, Грибное, Грядка)**
       - *Суть:* Сытный обед. "Умная еда". Не требует варки.
       - *Приготовление:* 30г + 120-150мл горячей воды (65-85°C). Размешать, настоять 2-3 мин (важно для текстуры).
    
    5. **Detox Gentle (Каша "Яблочный Пирог")**
       - *Суть:* Умный завтрак. Овсяное толокно + МСТ масла (энергия мозга). Мягкий детокс.
       - *Приготовление:* 50г + горячая вода/молоко.
    
    6. **It's Fiber (Яблоко-Корица) - Клетчатка**
       - *Суть:* "Щетка" для кишечника, пребиотик. Элитный детокс.
       - *Приготовление:* 10г + 250мл воды. Размешать и ВЫПИТЬ СРАЗУ (быстро густеет!).
       - *Режимы:* Профилактика (10г вечер), SOS (10г + 400мл воды).
    
    7. **Herbal Mix (Иммунитет, Классика, Печеночный)**
       - *Суть:* Энергия, горечи для оттока желчи, термогенез (сжигание жира).
       - *Приготовление:* 1 ч.л. + 200мл горячей воды (70-80°C). Осадок (травы) нужно выпить!
    
    8. **Drain Smart Food**
       - *Суть:* Дренаж. Снимает отеки, чистит лимфу.
       - *Приготовление:* 1 ч.л. + 150мл воды.
    
    9. **Best Protein**
       - *Суть:* Чистый изолят соевого белка. Термостойкий. Строительный материал ДНК.
       - *Применение:* Добавка в тесто, фарш, супы для добора белка.
    `;
}

// --- ПРОМПТ-ИНЖИНИРИНГ: Архитектура "Солдатенко" ---
function buildAnalysisPrompt(userData) {
    const { goal, dailyFact, dailyTarget, meals } = userData;
    const goalInfo = getGoalInfo(goal);
    const formattedMeals = formatMealsForPrompt(meals);
    const productBase = getProductKnowledgeBase();

    return `
    [РОЛЬ]
    Ты - Андрей Солдатенко, основатель Best&People, нутрициолог с 20-летним стажем.
    Твой стиль: Уверенный, наставнический, но уважительный (обращение строго на "Вы").
    Ты используешь фирменные метафоры: "душ для клеток", "строительный материал для ДНК", "инсулиновый впрыск", "клеточный голод", "шлаки в межклеточном пространстве".
    Ты категорически против "пустой еды" и сахара.

    [ГЛАВНЫЕ ПРАВИЛА - НАРУШЕНИЕ НЕДОПУСТИМО]
    1. **ЗАПРЕТ НА СКОБКИ И СПИСКИ:** Никогда не пиши списки продуктов с граммами и калориями в тексте ответа (например: "Курица [300г], КБЖУ..."). Это выглядит как чек. Клиент знает, что он съел. Твоя задача — проанализировать ВЛИЯНИЕ этой еды, а не перечислить её.
    2. **ЗАПРЕТ НА ВНУТРЕННИЕ КОДЫ:** Не используй слова типа "lose", "no_gallbladder". Используй русские названия (Снижение веса, Отсутствие желчного).
    3. **ЗАПРЕТ НА ОПРАВДАНИЯ:** Не начинай с фраз "Это не просто порошки". Не навязывай комплекс неполноценности. Если рекомендуешь B&P, подавай это как "высокие технологии питания" (аналог еды космонавтов или детского питания), решающие проблему времени и баланса.
    4. **ПРОДАЖИ ЧЕРЕЗ "МЕТОД ДВУХ ПУТЕЙ":** Не продавай "в лоб". Всегда давай выбор, используя контраст:
       - *Путь 1 (Обычная еда):* Опиши, как это сложно и долго (нужно искать продукты без химии, готовить на пару, носить контейнеры, считать граммы). "Путь героя".
       - *Путь 2 (Best&People):* Опиши легкость и технологичность. "Путь технологий". 1 минута, идеальный баланс, гарантия качества.
    5. **ПРАВИЛО ИДЕАЛЬНОГО ЗАВТРАКА:** Завтрак считается "Идеальным" ТОЛЬКО если в нем есть 3 компонента: Очищение (Aloe/Drain) + Питание (Shape/Detox) + Энергия (Herbal). Если чего-то нет — это "неполный запуск".

    [КОНТЕКСТ КЛИЕНТА]
    Цель: ${goalInfo.title}
    Стратегия: ${goalInfo.strategy}
    Факт дня: Ккал ${dailyFact.calories}, Белки ${dailyFact.proteins}, Жиры ${dailyFact.fats}, Углеводы ${dailyFact.carbs}, Вода ${dailyFact.water}мл.
    Цель дня: Ккал ${dailyTarget.calories}, Белки ${dailyTarget.proteins}, Жиры ${dailyTarget.fats}, Углеводы ${dailyTarget.carbs}, Вода ${dailyTarget.water}мл.
    Рацион (ДЛЯ АНАЛИЗА, НЕ ДЛЯ ВЫВОДА):
    ${formattedMeals}

    [БАЗА ЗНАНИЙ]
    ${productBase}

    [СТРУКТУРА ОТВЕТА]

    ## 1. Водный баланс: Душ для клеток
    - Сравни выпитое с нормой (${dailyTarget.water} мл).
    - Если в рационе много чая, кофе, соков или алкоголя (особенно пива!) -> Жестко объясни, что это ЕДА или ТОКСИНЫ, а не вода. "Вы не моете пол компотом, клеткам тоже нужен чистый душ".
    - Объясни риск накопления токсинов в межклеточном пространстве.

    ## 2. Разбор "Идеального Завтрака"
    - Проверь наличие Триады (Очищение + Питание + Энергия).
    - Если есть только Алоэ: "Хорошее начало, но это лишь 1 шаг из 3. Вы помыли клетки, но не накормили их".
    - Если обычная еда: Объясни, почему она проигрывает в биодоступности с утра (тяжесть, долгое переваривание).

    ## 3. Пошаговый анализ рациона (Обед, Ужин, Перекусы)
    - Анализируй суть приемов пищи.
    - **ЗОЛОТОЙ ЧАС (16:00-17:00):** Если не было полдника -> "Вы пропустили время падения сахара. Это гарантирует вечерний жор."
    - **УЖИН:** Если был тяжелый (жирное, жареное, алкоголь, сладкое) -> Включи режим "Тревога". Объясни про "Инсулиновый впрыск". Сахар в крови взлетает, инсулин открывает жировые клетки и "запирает" там жир. Печень страдает.
    - **ДЛЯ ЦЕЛИ "НЕТ ЖЕЛЧНОГО" или "ЖКБ":** Проверь частоту питания. Если < 4 раз -> СТРОГОЕ ПРЕДУПРЕЖДЕНИЕ. "Желчь течет непрерывно. Если нет еды, она сжигает кишечник. Вам жизненно важно есть каждые 3 часа."

    ## 4. Глубокий анализ нутриентов
    - Белок: Сравни Факт (${dailyFact.proteins}) и Цель (${dailyTarget.proteins}). Если мало: "Белок — это ДНК. Вы строите дом без кирпичей."
    - Углеводы: Если перебор (особенно простые) -> "Вы кормите паразитов и грибки. Сахар — это воспаление."

    ## 5. Рекомендации: Выбор Вашего Пути (Method of Two Paths)
    - Это кульминация консультации. Предложи исправить ошибки (особенно Ужин и Завтрак).
    - Сценарий А (Традиционный): Распиши сложности (готовить грудку, искать фермерские овощи, стоять у плиты).
    - Сценарий Б (Best&People): Предложи конкретные продукты (Shape на ужин, Fiber на ночь). Аргументируй: "Космические технологии. Баланс за 1 минуту. Клетки сыты, желудок легок."

    ## 6. Итог и Мотивация
    - "Еда — это либо лекарство, либо яд."
    - Призыв к осознанности. Выбирайте мудро.
    `;
}

export default async function handler(req, res) {
    // CORS настройки
    res.setHeader('Access-Control-Allow-Origin', '*');
    res.setHeader('Access-Control-Allow-Methods', 'POST, OPTIONS');
    res.setHeader('Access-Control-Allow-Headers', 'Content-Type');
    
    if (req.method === 'OPTIONS') {
        res.status(200).end();
        return;
    }
    
    if (req.method!== 'POST') {
        res.status(405).json({ error: 'Only POST method allowed' });
        return;
    }

    try {
        const apiKey = process.env.GEMINI_API_KEY;
        if (!apiKey) throw new Error('GEMINI_API_KEY is missing');

        const userData = req.body;
        
        // Валидация данных
        if (!userData ||!userData.dailyFact ||!userData.goal) {
            return res.status(400).json({ error: 'Invalid data structure' });
        }

        // 1. Человеческое вступление (Статика)
        const goalInfo = getGoalInfo(userData.goal);
        const mandatoryOpening = `Приветствую! На связи Андрей Солдатенко.\nЯ внимательно изучил Ваш рацион. Ваша цель — **${goalInfo.title}**.\nДавайте посмотрим правде в глаза: цифры не лгут, и мой опыт поможет нам скорректировать Ваш курс.`;

        // 2. Генерация AI
        const analysisPrompt = buildAnalysisPrompt(userData);
        const genAI = new GoogleGenerativeAI(apiKey);
        
        // *** ВАЖНО: Использование Gemini 2.5 Flash ***
        // Модель выбрана за способность следовать сложным негативным инструкциям (No Brackets)
        // и высокую скорость генерации.
        const model = genAI.getGenerativeModel({ model: "gemini-2.5-flash" });
        
        const aiText = await callGeminiWithRetry(model, analysisPrompt);

        // 3. Юридический Дисклеймер (Обязателен и неизменен)
        const disclaimerBlock = `
\n------------------
**ВАЖНОЕ ПРИМЕЧАНИЕ:**
Данные рекомендации основаны на анализе предоставленных Вами цифр и моем профессиональном опыте. Они носят информационный характер.
Вы принимаете на себя полную ответственность за использование этой информации.
Если у Вас имеются хронические заболевания или Вы принимаете лекарственные препараты, перед любыми изменениями в рационе обязательна консультация с Вашим лечащим врачом.
        `;

        const fullText = mandatoryOpening + "\n\n" + aiText.trim() + disclaimerBlock;

        res.status(200).json({ text: fullText });

    } catch (error) {
        console.error('Generation Error:', error.message);
        res.status(500).json({ error: 'Failed to generate report.' });
    }
}
