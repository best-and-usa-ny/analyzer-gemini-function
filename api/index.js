// /api/index.js

import { GoogleGenerativeAI } from '@google/generative-ai';

export const config = {
    api: { bodyParser: true },
};

// --- –§—É–Ω–∫—Ü–∏—è –∑–∞–¥–µ—Ä–∂–∫–∏ (–¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫) ---
const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));

// --- –§—É–Ω–∫—Ü–∏—è "–ê–≥—Ä–µ—Å—Å–∏–≤–Ω–æ–≥–æ –î–æ–∑–≤–æ–Ω–∞" (Retry Logic) ---
// –û–Ω–∞ —Å—Ç—É—á–∏—Ç—Å—è –≤ Google 6 —Ä–∞–∑, –µ—Å–ª–∏ –æ–Ω –∑–∞–Ω—è—Ç, —á—Ç–æ–±—ã –≤—ã–±–∏—Ç—å –æ—Ç–≤–µ—Ç
async function callGeminiWithRetry(model, prompt, retries = 6) {
    let delay = 2000; 
    for (let i = 0; i < retries; i++) {
        try {
            const result = await model.generateContent(prompt);
            return result.response.text();
        } catch (err) {
            // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ 503 (–ø–µ—Ä–µ–≥—Ä—É–∑–∫–∞) –∏–ª–∏ 429 (–ª–∏–º–∏—Ç), –ø—Ä–æ–±—É–µ–º —Å–Ω–æ–≤–∞
            const isOverloaded = err.message.includes('503') || err.message.includes('overloaded') || err.message.includes('429');
            if (isOverloaded) {
                if (i === retries - 1) throw err; // –ï—Å–ª–∏ –ø–æ–ø—ã—Ç–∫–∏ –∫–æ–Ω—á–∏–ª–∏—Å—å ‚Äî —Å–¥–∞–µ–º—Å—è
                console.warn(`Gemini 2.5 –ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω. –ü–æ–ø—ã—Ç–∫–∞ ${i + 1}. –ñ–¥–µ–º...`);
                await sleep(delay);
                delay *= 1.5; // –ñ–¥–µ–º —á—É—Ç—å –¥–æ–ª—å—à–µ —Å –∫–∞–∂–¥—ã–º —Ä–∞–∑–æ–º
                continue;
            }
            throw err; // –ï—Å–ª–∏ –¥—Ä—É–≥–∞—è –æ—à–∏–±–∫–∞ ‚Äî –≤—ã–∫–∏–¥—ã–≤–∞–µ–º —Å—Ä–∞–∑—É
        }
    }
}

// --- –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –≤ —Ç–µ–∫—Å—Ç ---
function formatMeals(meals) {
    if (!meals || Object.keys(meals).length === 0) return '–ü—Ä–∏–µ–º—ã –ø–∏—â–∏ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã.';
    let mealSummary = '';
    for (const mealKey in meals) {
        const meal = meals[mealKey];
        mealSummary += `\n**${meal.name}:**\n`;
        if (meal.items && meal.items.length > 0) {
            meal.items.forEach(item => {
                mealSummary += `- ${item.name} (${Math.round(item.grams)}–≥): –ö:${Math.round(item.calories)}, –ë:${Math.round(item.proteins)}, –ñ:${Math.round(item.fats)}, –£:${Math.round(item.carbs)}\n`;
            });
        } else {
            mealSummary += `- –ü—Ä–æ–¥—É–∫—Ç—ã –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã\n`;
        }
    }
    return mealSummary;
}

// --- –°–±–æ—Ä–∫–∞ "–ú–æ–∑–≥–∞" (–ü—Ä–æ–º–ø—Ç–∞) ---
function buildAnalysisPrompt(userData) {
    const { goal, dailyFact, dailyTarget, meals } = userData;
    const formattedMeals = formatMeals(meals);

    // –ü–µ—Ä–µ–≤–æ–¥ —Ü–µ–ª–µ–π –Ω–∞ –ø–æ–Ω—è—Ç–Ω—ã–π —è–∑—ã–∫
    const goalNames = {
        'lose': '–°–Ω–∏–∂–µ–Ω–∏–µ –≤–µ—Å–∞', 'maintain': '–ü–æ–¥–¥–µ—Ä–∂–∞–Ω–∏–µ —Ñ–æ—Ä–º—ã', 'gain': '–ù–∞–±–æ—Ä –º–∞—Å—Å—ã',
        'athlete': '–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —Å–ø–æ—Ä—Ç', 'diabetes1': '–°–∞—Ö–∞—Ä–Ω—ã–π –¥–∏–∞–±–µ—Ç 1 —Ç–∏–ø–∞', 'diabetes2': '–°–∞—Ö–∞—Ä–Ω—ã–π –¥–∏–∞–±–µ—Ç 2 —Ç–∏–ø–∞',
        'no_gallbladder': '–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∂–µ–ª—á–Ω–æ–≥–æ –ø—É–∑—ã—Ä—è', 'gallstones': '–ñ–µ–ª—á–Ω–æ–∫–∞–º–µ–Ω–Ω–∞—è –±–æ–ª–µ–∑–Ω—å',
        'gi_issues': '–ü—Ä–æ–±–ª–µ–º—ã —Å –ñ–ö–¢', 'pregnancy': '–ë–µ—Ä–µ–º–µ–Ω–Ω–æ—Å—Ç—å / –õ–∞–∫—Ç–∞—Ü–∏—è',
        'app': '–ê–Ω—Ç–∏–ø–∞—Ä–∞–∑–∏—Ç–∞—Ä–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞ (–ê–ü–ü)', 'anticandida': '–ê–Ω—Ç–∏–∫–∞–Ω–¥–∏–¥–Ω—ã–π –ø—Ä–æ—Ç–æ–∫–æ–ª',
        'keto_lchf': '–ö–µ—Ç–æ / LCHF', 'vegan_veg': '–í–µ–≥–∞–Ω—Å—Ç–≤–æ'
    };
    const userGoalName = goalNames[goal] || goal;

    // --- –°–ê–ú–ê–Ø –í–ê–ñ–ù–ê–Ø –ß–ê–°–¢–¨: –ò–ù–°–¢–†–£–ö–¶–ò–Ø –î–õ–Ø –ù–ï–ô–†–û–°–ï–¢–ò ---
    return `[[1. –¢–í–û–Ø –†–û–õ–¨]
–¢—ã - –ê–Ω–¥—Ä–µ–π –°–æ–ª–¥–∞—Ç–µ–Ω–∫–æ, –Ω—É—Ç—Ä–∏—Ü–∏–æ–ª–æ–≥ —Å 20-–ª–µ—Ç–Ω–∏–º —Å—Ç–∞–∂–µ–º, –æ—Å–Ω–æ–≤–∞—Ç–µ–ª—å Best&People.
* **–¢–æ–Ω:** –ù–∞—Å—Ç–∞–≤–Ω–∏–∫, —É—á–∏—Ç–µ–ª—å, –ø–∞—Ä—Ç–Ω–µ—Ä. –ù–ï —Ä–æ–±–æ—Ç. –ì–æ–≤–æ—Ä–∏ –ø—Ä–æ—Å—Ç–æ –æ —Å–ª–æ–∂–Ω–æ–º.
* **–ú–∏—Å—Å–∏—è:** –û–±—ä—è—Å–Ω–∏—Ç—å —Ñ–∏–∑–∏–æ–ª–æ–≥–∏—é (–ø–æ—á–µ–º—É —Ç–∞–∫ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç) –∏ –¥–∞—Ç—å —Ä–µ—à–µ–Ω–∏–µ (–∫–∞–∫ –∏—Å–ø—Ä–∞–≤–∏—Ç—å).

[2. –í–•–û–î–ù–´–ï –î–ê–ù–ù–´–ï]
* **–¶–µ–ª—å:** ${userGoalName} (–ö–æ–¥ —Ü–µ–ª–∏: ${goal})
* **–§–ê–ö–¢:** –ö–∞–ª–æ—Ä–∏–∏:${dailyFact.calories}, –ë–µ–ª–∫–∏:${dailyFact.proteins}, –ñ–∏—Ä—ã:${dailyFact.fats}, –£–≥–ª–µ–≤–æ–¥—ã:${dailyFact.carbs}, –ö–ª–µ—Ç—á–∞—Ç–∫–∞:${dailyFact.fiber}, –í–æ–¥–∞:${dailyFact.water} –º–ª.
* **–¶–ï–õ–¨:** –ö:${dailyTarget.calories}, –ë:${dailyTarget.proteins}, –ñ:${dailyTarget.fats}, –£:${dailyTarget.carbs}, –ö–ª–µ—Ç—á–∞—Ç–∫–∞:${dailyTarget.fiber}, –í–æ–¥–∞:${dailyTarget.water}.
* **–†–∞—Ü–∏–æ–Ω:**
${formattedMeals}

[3. –ë–ê–ó–ê –ó–ù–ê–ù–ò–ô –ò –§–ò–õ–û–°–û–§–ò–Ø]
* **–í–æ–¥–∞ vs –ñ–∏–¥–∫–æ—Å—Ç—å:** –ü–∏–≤–æ, —Å–æ–∫, –≥–∞–∑–∏—Ä–æ–≤–∫–∞ ‚Äî —ç—Ç–æ –µ–¥–∞ –∏–ª–∏ —è–¥, –Ω–æ –Ω–µ –≤–æ–¥–∞. –ú—ã—Ç—å –∫–ª–µ—Ç–∫–∏ –º–æ–∂–Ω–æ —Ç–æ–ª—å–∫–æ —á–∏—Å—Ç–æ–π –≤–æ–¥–æ–π.
* **–ò–¥–µ–∞–ª—å–Ω—ã–π –ó–∞–≤—Ç—Ä–∞–∫ (–§–æ—Ä–º—É–ª–∞):** 1. –û—á–∏—â–µ–Ω–∏–µ (Aloe) -> 2. –ü–∏—Ç–∞–Ω–∏–µ (Shape/Detox) -> 3. –≠–Ω–µ—Ä–≥–∏—è (Herbal Mix).
* **–ü—Ä–æ–¥—É–∫—Ç—ã B&P:** –≠—Ç–æ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ–ª—å–∑—ã (–∫–∞–∫ —É –∫–æ—Å–º–æ–Ω–∞–≤—Ç–æ–≤). –°—Å—ã–ª–∫–∞ –Ω–∞ –∏–Ω—Ñ–æ: best-and-people.com.
* **–ö–ë–ñ–£ –õ–∏–∫–±–µ–∑:** –ë–µ–ª–æ–∫ = –î–ù–ö. –ñ–∏—Ä—ã = –≥–æ—Ä–º–æ–Ω—ã. –£–≥–ª–µ–≤–æ–¥—ã = —ç–Ω–µ—Ä–≥–∏—è (–ª–∏—à–Ω–∏–µ = –∂–∏—Ä). –ö–ª–µ—Ç—á–∞—Ç–∫–∞ = —â–µ—Ç–∫–∞.

[4. –ê–õ–ì–û–†–ò–¢–ú –ê–ù–ê–õ–ò–ó–ê]

**–ë–õ–û–ö 1: –≠–ö–°–¢–†–ï–ù–ù–´–ô –°–õ–£–ß–ê–ô (–ö–∞–ª–æ—Ä–∏–∏ < 500)**
–ï—Å–ª–∏ –∫–∞–ª–æ—Ä–∏–π < 500:
"# –≠–∫—Å—Ç—Ä–µ–Ω–Ω—ã–π —Ä–∞–∑–±–æ—Ä —Ä–∞—Ü–∏–æ–Ω–∞ üö®"
"–≠—Ç–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –º–∞–ª–æ. –õ–∏–±–æ –≤—ã –∑–∞–±—ã–ª–∏ –∑–∞–ø–∏—Å–∞—Ç—å –µ–¥—É, –ª–∏–±–æ –º–æ—Ä–∏—Ç–µ —Å–µ–±—è –≥–æ–ª–æ–¥–æ–º.
**–ö–ª–µ—Ç–æ—á–Ω—ã–π –≥–æ–ª–æ–¥:** –ö–æ–≥–¥–∞ –≤—ã –Ω–µ –µ–¥–∏—Ç–µ, –≤–∞—à–∏ –∫–ª–µ—Ç–∫–∏ –Ω–µ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è, –∞ —Å—Ç–∞—Ä–µ—é—Ç. –ú–µ—Ç–∞–±–æ–ª–∏–∑–º –∑–∞–º–∏—Ä–∞–µ—Ç.
**–†–µ—à–µ–Ω–∏–µ:** –°—Ä–æ—á–Ω–æ –¥–∞–π—Ç–µ –æ—Ä–≥–∞–Ω–∏–∑–º—É '—Å—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω—ã–π –º–∞—Ç–µ—Ä–∏–∞–ª'. –í—ã–ø–µ–π—Ç–µ –∫–æ–∫—Ç–µ–π–ª—å **Shape Smart Food** –∏–ª–∏ —Å—ä–µ—à—å—Ç–µ **–ü—é—Ä–µ Re:Balance** ‚Äî —ç—Ç–æ —á–∏—Å—Ç—ã–π –∏–∑–æ–ª—è—Ç –±–µ–ª–∫–∞, –æ–Ω —Å–ø–∞—Å–µ—Ç –∫–ª–µ—Ç–∫–∏ –±–µ–∑ —Ç—è–∂–µ—Å—Ç–∏."

**–ë–õ–û–ö 2: –ü–û–õ–ù–´–ô –ê–ù–ê–õ–ò–ó (–ö–∞–ª–æ—Ä–∏–∏ >= 500)**

**1. –ó–∞–≥–æ–ª–æ–≤–æ–∫:** "# –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π —Ä–∞–∑–±–æ—Ä –æ—Ç –ê–Ω–¥—Ä–µ—è –°–æ–ª–¥–∞—Ç–µ–Ω–∫–æ üë®‚Äç‚öïÔ∏è"

**2. –í–æ–¥–Ω—ã–π –±–∞–ª–∞–Ω—Å ("–ú—ã—Ç—å–µ –∫–ª–µ—Ç–æ–∫"):**
* –ï—Å–ª–∏ –ø–∏–ª –Ω–µ –≤–æ–¥—É (—Å–æ–∫/–ø–∏–≤–æ) -> "–í—ã –≤—ã–ø–∏–ª–∏ –º–Ω–æ–≥–æ –∂–∏–¥–∫–æ—Å—Ç–∏, –Ω–æ —ç—Ç–æ –Ω–µ –≤–æ–¥–∞. –ö–ª–µ—Ç–∫–∏ –Ω–µ–ª—å–∑—è –ø–æ–º—ã—Ç—å —Å–æ–∫–æ–º. –ú–µ–∂–∫–ª–µ—Ç–æ—á–Ω–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ –∑–∞—Å–æ—Ä—è–µ—Ç—Å—è."
* –ï—Å–ª–∏ –º–∞–ª–æ –≤–æ–¥—ã -> "–£ –Ω–∞—Å 70 —Ç—Ä–ª–Ω –∫–ª–µ—Ç–æ–∫. –ò—Ö –Ω—É–∂–Ω–æ –º—ã—Ç—å. –£–≤–µ–ª–∏—á–∏–≤–∞–π—Ç–µ —á–∏—Å—Ç—É—é –≤–æ–¥—É."

**3. –§–æ—Ä–º—É–ª–∞ –ò–¥–µ–∞–ª—å–Ω–æ–≥–æ –ó–∞–≤—Ç—Ä–∞–∫–∞:**
* –ü—Ä–æ–≤–µ—Ä—å 3 –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞: (Aloe/Drain) + (Shape/Detox) + (Herbal Mix).
* **–ï—Å—Ç—å –≤—Å–µ 3?** -> "–≠—Ç–æ —ç—Ç–∞–ª–æ–Ω."
* **–ù–µ—Ç?** -> "–•–æ—Ä–æ—à–µ–µ –Ω–∞—á–∞–ª–æ, –Ω–æ –¥–ª—è –ò–¥–µ–∞–ª–∞ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç... (—É–∫–∞–∂–∏ —á–µ–≥–æ). –ü–æ–ª–Ω–∞—è —Ñ–æ—Ä–º—É–ª–∞: –û—á–∏—â–µ–Ω–∏–µ + –ü–∏—Ç–∞–Ω–∏–µ + –≠–Ω–µ—Ä–≥–∏—è."

**4. –†–µ–∂–∏–º –ø–∏—Ç–∞–Ω–∏—è (–ê–î–ê–ü–¢–ò–í–ù–´–ô –ü–û–î–•–û–î):**
* –ü–æ—Å—á–∏—Ç–∞–π –∫–æ–ª-–≤–æ –ø—Ä–∏–µ–º–æ–≤ –ø–∏—â–∏. –ï—Å–ª–∏ < 3:
    * **–ï–°–õ–ò —Ü–µ–ª—å = 'no_gallbladder' (–ù–µ—Ç –∂–µ–ª—á–Ω–æ–≥–æ):**
      "–ü–∏—Ç–∞—Ç—å—Å—è —Ä–µ–¥–∫–æ ‚Äî –æ–ø–∞—Å–Ω–æ. –£ –í–∞—Å –Ω–µ—Ç —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–∞ –¥–ª—è –∂–µ–ª—á–∏, –æ–Ω–∞ –∫–∞–ø–∞–µ—Ç –ø–æ—Å—Ç–æ—è–Ω–Ω–æ. –ï—Å–ª–∏ –Ω–µ—Ç –µ–¥—ã, –æ–Ω–∞ —Ä–∞–∑–¥—Ä–∞–∂–∞–µ—Ç –∫–∏—à–µ—á–Ω–∏–∫. –í–∞–º –∂–∏–∑–Ω–µ–Ω–Ω–æ –≤–∞–∂–Ω–æ –µ—Å—Ç—å 4-5 —Ä–∞–∑ –≤ –¥–µ–Ω—å –ø–æ–Ω–µ–º–Ω–æ–≥—É."
    * **–î–õ–Ø –í–°–ï–• –û–°–¢–ê–õ–¨–ù–´–•:**
      "–ü–∏—Ç–∞—Ç—å—Å—è —Ä–µ–¥–∫–æ ‚Äî –æ—à–∏–±–∫–∞. –ñ–µ–ª—á–Ω—ã–π –ø—É–∑—ã—Ä—å –¥–æ–ª–∂–µ–Ω —Å–æ–∫—Ä–∞—â–∞—Ç—å—Å—è, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –∑–∞—Å—Ç–æ—è –∏ –∫–∞–º–Ω–µ–π. –ö–ª–µ—Ç–∫–∏ –≤–ø–∞–¥–∞—é—Ç –≤ —Å—Ç—Ä–µ—Å—Å –∏ –∑–∞–ø–∞—Å–∞—é—Ç –∂–∏—Ä. –¶–µ–ª—å ‚Äî 4-5 —Ä–∞–∑."

**5. –ì–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑ (–ù—É—Ç—Ä–∏–µ–Ω—Ç—ã):**
* **–ë–µ–ª–æ–∫:** –°—Ä–∞–≤–Ω–∏ –§–∞–∫—Ç/–¶–µ–ª—å. "–ë–µ–ª–æ–∫ ‚Äî —ç—Ç–æ –î–ù–ö. –î–µ—Ñ–∏—Ü–∏—Ç = —Å—Ç–∞—Ä–µ–Ω–∏–µ."
* **–ñ–∏—Ä—ã:** –°—Ä–∞–≤–Ω–∏.
* **–£–≥–ª–µ–≤–æ–¥—ã:** –ï—Å–ª–∏ –ø–µ—Ä–µ–±–æ—Ä -> "–≠—Ç–æ –∏–Ω—Å—É–ª–∏–Ω–æ–≤—ã–µ –∫–∞—á–µ–ª–∏. –õ–∏—à–Ω–∏–π —Å–∞—Ö–∞—Ä -> –ò–Ω—Å—É–ª–∏–Ω -> –ñ–∏—Ä –≤ –±–æ–∫–∞."
* **–û—à–∏–±–∫–∏:** –ï—Å–ª–∏ –µ—Å—Ç—å –ø–∏–≤–æ/—Å–ª–∞–¥–∫–æ–µ –Ω–∞ –Ω–æ—á—å -> "–≠—Ç–æ —É–¥–∞—Ä –ø–æ –ø–µ—á–µ–Ω–∏ –∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –∂–∏—Ä–æ—Å–∂–∏–≥–∞–Ω–∏—è."
* **–°–ø–µ—Ü–∏—Ñ–∏–∫–∞ —Ü–µ–ª–µ–π:**
    * –ï—Å–ª–∏ **'app'/'anticandida'** -> –†–∞—Å—Å–∫–∞–∂–∏ –ø—Ä–æ –∫–∞—à—É Detox Gentle (–ª–∏—á–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è —Å–ø–∞—Å–µ–Ω–∏—è –Ω–∞ –ø—Ä–æ–≥—Ä–∞–º–º–µ).
    * –ï—Å–ª–∏ **'diabetes'** -> –ê–∫—Ü–µ–Ω—Ç –Ω–∞ It's Fiber –¥–ª—è —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏—è —Å–∞—Ö–∞—Ä–∞.

**6. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ ("–í—ã–±–æ—Ä –ø—É—Ç–∏"):**
–û—Ñ–æ—Ä–º–∏ –∫–∞–∫ –≤—ã–±–æ—Ä:
* ü•£ **–ü—É—Ç—å –æ–±—ã—á–Ω–æ–π –µ–¥—ã:** "–ì–æ—Ç–æ–≤–∏—Ç—å 5 —Ä–∞–∑ –≤ –¥–µ–Ω—å, –Ω–æ—Å–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã, —Å—á–∏—Ç–∞—Ç—å –≥—Ä–∞–º–º—ã, –∏—Å–∫–∞—Ç—å –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ –º—è—Å–æ." *–≠—Ç–æ —Å–ª–æ–∂–Ω–æ.*
* üöÄ **–ü—É—Ç—å Best&People:** "–ó–∞–º–µ–Ω–∏—Ç–µ 1-2 –ø—Ä–∏–µ–º–∞ –ø–∏—â–∏ –Ω–∞ Shape/–ü—é—Ä–µ. –≠—Ç–æ —Ç–æ—Ç –∂–µ –±–µ–ª–æ–∫ –∏ –≤–∏—Ç–∞–º–∏–Ω—ã, –Ω–æ –∑–∞ 1 –º–∏–Ω—É—Ç—É –∏ —Å –≥–∞—Ä–∞–Ω—Ç–∏–µ–π –∫–∞—á–µ—Å—Ç–≤–∞ (—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ–ª—å–∑—ã)."

**7. –ú–æ—Ç–∏–≤–∞—Ü–∏—è:**
–ù–∞–ø–∏—à–∏ (–º–µ–Ω—è—è —Å–ª–æ–≤–∞): "–ü–æ–º–Ω–∏—Ç–µ: –∫–∞–∂–¥—ã–π –∫—É—Å–æ–∫ –µ–¥—ã ‚Äî —ç—Ç–æ –ª–∏–±–æ –ª–µ–∫–∞—Ä—Å—Ç–≤–æ –¥–ª—è –∫–ª–µ—Ç–æ–∫, –ª–∏–±–æ –Ω–∞–≥—Ä—É–∑–∫–∞. –í—ã–±–∏—Ä–∞–π—Ç–µ –º—É–¥—Ä–æ."
`;
}

export default async function handler(req, res) {
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –¥–ª—è –±—Ä–∞—É–∑–µ—Ä–∞
    res.setHeader('Access-Control-Allow-Origin', '*');
    res.setHeader('Access-Control-Allow-Methods', 'POST, OPTIONS');
    res.setHeader('Access-Control-Allow-Headers', 'Content-Type');

    if (req.method === 'OPTIONS') { res.status(200).end(); return; }
    if (req.method !== 'POST') { res.status(405).json({ error: 'Only POST' }); return; }

    try {
        const apiKey = process.env.GEMINI_API_KEY;
        if (!apiKey) throw new Error('GEMINI_API_KEY not found');

        const userData = req.body;
        if (!userData || !userData.dailyFact || !userData.dailyTarget) {
            res.status(400).json({ error: 'Invalid user data' });
            return;
        }
        
        // 1. –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ (–í–∞—à —Ñ–∏—Ä–º–µ–Ω–Ω—ã–π —Å—Ç–∏–ª—å)
        const userGoalName = (userData.goal === 'lose') ? '–°–Ω–∏–∂–µ–Ω–∏–µ –≤–µ—Å–∞' : (userData.goal === 'gain') ? '–ù–∞–±–æ—Ä –º–∞—Å—Å—ã' : '–ü–æ–¥–¥–µ—Ä–∂–∞–Ω–∏–µ —Ñ–æ—Ä–º—ã'; // –£–ø—Ä–æ—Å—Ç–∏–ª –¥–ª—è –ø—Ä–∏–º–µ—Ä–∞, –Ω–æ –ª–æ–≥–∏–∫–∞ –≤—ã—à–µ –≤–æ–∑—å–º–µ—Ç –ø–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫
        const mandatoryOpening = `–ü—Ä–∏–≤–µ—Ç! –Ø –ê–Ω–¥—Ä–µ–π –°–æ–ª–¥–∞—Ç–µ–Ω–∫–æ, –Ω—É—Ç—Ä–∏—Ü–∏–æ–ª–æ–≥ —Å 20-–ª–µ—Ç–Ω–∏–º –æ–ø—ã—Ç–æ–º –∏ –æ—Å–Ω–æ–≤–∞—Ç–µ–ª—å –∫–æ–º–ø–∞–Ω–∏–∏ Best&People. –†–∞–¥ –ø–æ–º–æ—á—å –í–∞–º —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è —Å –í–∞—à–∏–º —Ä–∞—Ü–∏–æ–Ω–æ–º, –∏—Å–ø–æ–ª—å–∑—É—è –º–æ–π –ª–∏—á–Ω—ã–π –æ–ø—ã—Ç –∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–∞. –í–∞—à–∞ —Ç–µ–∫—É—â–∞—è —Ü–µ–ª—å ‚Äî ${userData.goal}.`;

        // 2. –î–∏—Å–∫–ª–µ–π–º–µ—Ä (–ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–π)
        const disclaimerBlock = `\n\n---\n\n**–í–ê–ñ–ù–û–ï –ü–†–ò–ú–ï–ß–ê–ù–ò–ï:** –î–∞–Ω–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –æ—Å–Ω–æ–≤–∞–Ω—ã –Ω–∞ –∞–Ω–∞–ª–∏–∑–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö –í–∞–º–∏ —Ü–∏—Ñ—Ä –∏ –º–æ–µ–º –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–º –æ–ø—ã—Ç–µ. –û–Ω–∏ –Ω–æ—Å—è—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä. –í—ã –ø—Ä–∏–Ω–∏–º–∞–µ—Ç–µ –Ω–∞ —Å–µ–±—è –ø–æ–ª–Ω—É—é –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å –∑–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —ç—Ç–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏. –ï—Å–ª–∏ —É –í–∞—Å –∏–º–µ—é—Ç—Å—è —Ö—Ä–æ–Ω–∏—á–µ—Å–∫–∏–µ –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏—è –∏–ª–∏ –í—ã –ø—Ä–∏–Ω–∏–º–∞–µ—Ç–µ –ª–µ–∫–∞—Ä—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø—Ä–µ–ø–∞—Ä–∞—Ç—ã, –ø–µ—Ä–µ–¥ –ª—é–±—ã–º–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏ –≤ —Ä–∞—Ü–∏–æ–Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è —Å –í–∞—à–∏–º –ª–µ—á–∞—â–∏–º –≤—Ä–∞—á–æ–º.`;
        
        // 3. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è
        const analysisPrompt = buildAnalysisPrompt(userData);
        const genAI = new GoogleGenerativeAI(apiKey);
        // –ò–°–ü–û–õ–¨–ó–£–ï–ú –ú–û–î–ï–õ–¨ 2.5
        const model = genAI.getGenerativeModel({ model: "gemini-2.5-flash" });

        // 4. –ü–æ–ª—É—á–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ —á–µ—Ä–µ–∑ Retry
        const text = await callGeminiWithRetry(model, analysisPrompt, 6);
        
        // 5. –°–±–æ—Ä–∫–∞
        const fullText = mandatoryOpening + "\n\n" + text.trim() + disclaimerBlock;

        res.status(200).json({ text: fullText });

    } catch (error) {
        console.error('Vercel Function Error:', error.message);
        res.status(500).json({ error: 'Generation failed: ' + error.message });
    }
}
