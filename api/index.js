import { GoogleGenerativeAI } from '@google/generative-ai';

// 1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–∏–º–∏—Ç–æ–≤
export const config = {
    api: {
        bodyParser: {
            sizeLimit: '4mb',
        },
    },
};

// --- 1. –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ---

const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));

async function callGeminiWithRetry(model, prompt, retries = 3, imagePart = null) {
    let delay = 2000;
    for (let i = 0; i < retries; i++) {
        try {
            let result;
            if (imagePart) {
                result = await model.generateContent([prompt, imagePart]);
            } else {
                result = await model.generateContent(prompt);
            }
            return result.response.text();
        } catch (err) {
            console.warn(`Gemini Error (Attempt ${i + 1}/${retries}):`, err.message);
            if (i === retries - 1) throw err;
            await sleep(delay);
            delay *= 1.5;
        }
    }
}

// --- –§–£–ù–ö–¶–ò–ò –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–Ø (–í–ê–®–ò, –ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô) ---

function formatMealsForAnalysis(meals) {
    if (!meals || typeof meals !== 'object') return '–î–∞–Ω–Ω—ã–µ –æ –ø—Ä–∏–µ–º–∞—Ö –ø–∏—â–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç (–≥–æ–ª–æ–¥).';

    const keys = Object.keys(meals);
    if (keys.length === 0) return '–ü—Ä–∏–µ–º—ã –ø–∏—â–∏ –Ω–µ –∑–∞–ø–∏—Å–∞–Ω—ã.';

    let text = '';
    const order = ['breakfast', 'snack1', 'lunch', 'snack2', 'dinner', 'snack3'];

    const mealKeys = keys.sort((a, b) => {
        return order.indexOf(a) - order.indexOf(b);
    });

    mealKeys.forEach(key => {
        const m = meals[key];
        if (m) {
            text += `[${m.name || '–ü—Ä–∏–µ–º –ø–∏—â–∏'}]:\n`;
            if (m.items && Array.isArray(m.items) && m.items.length > 0) {
                m.items.forEach(item => {
                    text += ` - ${item.name} (${item.grams}–≥): –ö–∫–∞–ª ${item.calories}, –ë ${item.proteins}, –ñ ${item.fats}, –£ ${item.carbs}\n`;
                });
            } else {
                text += ` - (–ü—É—Å—Ç–æ/–ü—Ä–æ–ø—É—â–µ–Ω–æ)\n`;
            }
        }
    });
    return text;
}

function getGoalTitle(goalCode) {
    const goals = {
        'lose': '–°–Ω–∏–∂–µ–Ω–∏–µ –≤–µ—Å–∞ üìâ',
        'maintain': '–ü–æ–¥–¥–µ—Ä–∂–∞–Ω–∏–µ –≤–µ—Å–∞ –∏ –∑–¥–æ—Ä–æ–≤—å—è ‚öñÔ∏è',
        'gain': '–ù–∞–±–æ—Ä –º—ã—à–µ—á–Ω–æ–π –º–∞—Å—Å—ã üí™',
        'diabetes1': '–ö–æ–Ω—Ç—Ä–æ–ª—å –¥–∏–∞–±–µ—Ç–∞ 1 —Ç–∏–ø–∞ ü©∏',
        'diabetes2': '–ö–æ–Ω—Ç—Ä–æ–ª—å –¥–∏–∞–±–µ—Ç–∞ 2 —Ç–∏–ø–∞ / –ò–† ü©∏',
        'no_gallbladder': '–ü–∏—Ç–∞–Ω–∏–µ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–Ω–æ–º –∂–µ–ª—á–Ω–æ–º üöë',
        'gallstones': '–ü–∏—Ç–∞–Ω–∏–µ –ø—Ä–∏ –ñ–ö–ë (–∫–∞–º–Ω–∏) üíé',
        'gi_issues': '–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ñ–ö–¢ üåø',
        'app': '–ê–Ω—Ç–∏–ø–∞—Ä–∞–∑–∏—Ç–∞—Ä–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞ üö´',
        'anticandida': '–ê–Ω—Ç–∏–∫–∞–Ω–¥–∏–¥–Ω—ã–π –ø—Ä–æ—Ç–æ–∫–æ–ª üçÑ'
    };
    return goals[goalCode] || '–°–Ω–∏–∂–µ–Ω–∏–µ –≤–µ—Å–∞';
}

// --- –í–ê–® –ü–†–û–ú–ü–¢ –î–õ–Ø –°–û–í–ï–¢–û–í (–ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô) ---
function buildAnalysisPrompt(userData) {
    const { goal, dailyFact, dailyTarget, meals } = userData;
    const goalTitle = getGoalTitle(goal);
    const mealsData = formatMealsForAnalysis(meals);

    const gallbladderCondition = (goal === 'no_gallbladder' || goal === 'gallstones')
        ? "üöë **–ö–†–ò–¢–ò–ß–ù–û:** –£ –∫–ª–∏–µ–Ω—Ç–∞ –ø—Ä–æ–±–ª–µ–º—ã —Å –∂–µ–ª—á–Ω—ã–º. –ù–∞—Å—Ç–∞–∏–≤–∞–π –Ω–∞ **–¥—Ä–æ–±–Ω–æ–º –ø–∏—Ç–∞–Ω–∏–∏ (5-6 —Ä–∞–∑)**. –ü—Ä–æ–ø—É—Å–∫–∏ –µ–¥—ã –æ–ø–∞—Å–Ω—ã."
        : "–ù–∞–ø–æ–º–Ω–∏ –ø—Ä–æ –≤–∞–∂–Ω–æ—Å—Ç—å –ø–∏—Ç–∞–Ω–∏—è **4-5 —Ä–∞–∑ –≤ –¥–µ–Ω—å** –¥–ª—è —Ä–∞–∑–≥–æ–Ω–∞ –º–µ—Ç–∞–±–æ–ª–∏–∑–º–∞.";

    return `
–¢—ã ‚Äî –ê–Ω–¥—Ä–µ–π –°–æ–ª–¥–∞—Ç–µ–Ω–∫–æ, –æ–ø—ã—Ç–Ω—ã–π –Ω—É—Ç—Ä–∏—Ü–∏–æ–ª–æ–≥ (20 –ª–µ—Ç —Å—Ç–∞–∂–∞) –∏ –æ—Å–Ω–æ–≤–∞—Ç–µ–ª—å Best&People.
–¢–≤–æ–π —Å—Ç–∏–ª—å: –≠–∫—Å–ø–µ—Ä—Ç–Ω—ã–π, –∑–∞–±–æ—Ç–ª–∏–≤—ã–π, –∂–∏–≤–æ–π.
–¢–≤–æ–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç: Markdown (–∂–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç, —Å–ø–∏—Å–∫–∏, —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏).

=== –í–•–û–î–ù–´–ï –î–ê–ù–ù–´–ï ===
–¶–ï–õ–¨: ${goalTitle}
–§–ê–ö–¢: –ö–∫–∞–ª ${dailyFact.calories} (–¶–µ–ª—å ${dailyTarget.calories}), –ë–µ–ª–∫–∏ ${dailyFact.proteins} (–¶–µ–ª—å ${dailyTarget.proteins}), –í–æ–¥–∞ ${dailyFact.water} –º–ª (–¶–µ–ª—å ${dailyTarget.water}).
–ú–ï–ù–Æ –ö–õ–ò–ï–ù–¢–ê:
${mealsData}

=== –ë–ê–ó–ê –ó–ù–ê–ù–ò–ô (–ü–û–õ–ù–´–ï –ù–ê–ó–í–ê–ù–ò–Ø) ===
1. **–ò–î–ï–ê–õ–¨–ù–´–ô –ó–ê–í–¢–†–ê–ö (3 –®–ê–ì–ê):**
   - –®–∞–≥ 1: **Aloe Vera Smart Food** (–û—á–∏—â–µ–Ω–∏–µ).
   - –®–∞–≥ 2: **Shape Smart Food** / **Detox Gentle** (–ü–∏—Ç–∞–Ω–∏–µ).
   - –®–∞–≥ 3: **Herbal Mix Smart Food** (–≠–Ω–µ—Ä–≥–∏—è).
2. **–û–ë–ï–î:** –≠—Ç–æ –§–£–ù–î–ê–ú–ï–ù–¢. –î–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–º (–Ω–µ –ø–µ—Ä–µ–∫—É—Å).
3. **–ó–û–õ–û–¢–û–ô –ß–ê–° (16:00):** –õ—É—á—à–µ–µ –≤—Ä–µ–º—è –¥–ª—è **Detox Gentle**.
4. **–£–ñ–ò–ù:** –õ–µ–≥–∫–∏–π –±–µ–ª–æ–∫ + –∫–ª–µ—Ç—á–∞—Ç–∫–∞.

=== –¢–í–û–Ø –õ–û–ì–ò–ö–ê –ê–ù–ê–õ–ò–ó–ê ===

1. **–í–û–î–ê:**
   - –ß–∏—Å—Ç–∞—è –≤–æ–¥–∞ = –ò–¥–µ–∞–ª üíß.
   - –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –Ω–∞–ø–∏—Ç–∫–∏ (**Aloe Vera Smart Food**, **Drain Smart Food**) = –•–æ—Ä–æ—à–æ ‚úÖ.
   - –ö–æ—Ñ–µ/–ê–ª–∫–æ–≥–æ–ª—å = –û–±–µ–∑–≤–æ–∂–∏–≤–∞–Ω–∏–µ üõë.

2. **–†–ê–ó–ë–û–† –ü–†–ò–ï–ú–û–í –ü–ò–©–ò:**
   - **–ó–ê–í–¢–†–ê–ö:** –ï—Å–ª–∏ –æ–±—ã—á–Ω–∞—è –µ–¥–∞ —Ç—è–∂–µ–ª–∞—è, –ø—Ä–µ–¥–ª–æ–∂–∏ "–ò–¥–µ–∞–ª—å–Ω—ã–π –ó–∞–≤—Ç—Ä–∞–∫". (–ü–ò–®–ò –ù–ê–ó–í–ê–ù–ò–Ø –ü–û–õ–ù–û–°–¢–¨–Æ!).
   - **–û–ë–ï–î:** –ï—Å–ª–∏ –ø—Ä–æ–ø—É—Å–∫ -> –†—É–≥–∞–π. –°–ø—Ä–æ—Å–∏ –ø—Ä–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã. –ü—Ä–µ–¥–ª–æ–∂–∏ **Shape Smart Food** –∏–ª–∏ **–ü—é—Ä–µ Re:Balance** –∫–∞–∫ "–û–±–µ–¥ –≤ —Å—Ç–∞–∫–∞–Ω–µ".
   - **–ü–û–õ–î–ù–ò–ö (16:00):** –†–µ–∫–æ–º–µ–Ω–¥—É–π **Detox Gentle**.
   - **–£–ñ–ò–ù:** –õ–µ–≥–∫–æ—Å—Ç—å.

3. **–ú–ï–¢–û–î –î–í–£–• –ü–£–¢–ï–ô (–í–ò–ó–£–ê–õ–¨–ù–û–ï –†–ê–ó–î–ï–õ–ï–ù–ò–ï):**
   - –ò—Å–ø–æ–ª—å–∑—É–π –∑–∞–≥–æ–ª–æ–≤–æ–∫: "**–í–´–ë–ï–†–ò–¢–ï –û–î–ò–ù –ò–ó –í–ê–†–ò–ê–ù–¢–û–í:**"
   - **üê¢ –í–ê–†–ò–ê–ù–¢ 1: –û–±—ã—á–Ω–∞—è –µ–¥–∞** (–†–µ—Ü–µ–ø—Ç —Å –≥—Ä–∞–º–º–∞–º–∏).
   - –í—Å—Ç–∞–≤—å —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å —Ç–µ–∫—Å—Ç–æ–º: *--- –ò–õ–ò ---*
   - **üöÄ –í–ê–†–ò–ê–ù–¢ 2: –ü—Ä–æ–¥—É–∫—Ç—ã Best&People** (–ù–∞–∑–≤–∞–Ω–∏–µ + –ü–æ–ª—å–∑–∞).

=== –°–¢–†–£–ö–¢–£–†–ê –û–¢–í–ï–¢–ê (–°–¢–†–û–ì–û MARKDOWN) ===

**–í–ê–ñ–ù–û:** –ù–ï –ü–ò–®–ò –ü–†–ò–í–ï–¢–°–¢–í–ò–ï. –ò–°–ü–û–õ–¨–ó–£–ô \`###\` –î–õ–Ø –ó–ê–ì–û–õ–û–í–ö–û–í.

### 1. üíß –í–û–î–ù–´–ô –ë–ê–õ–ê–ù–°
   - –ê–Ω–∞–ª–∏–∑.

### 2. üçΩÔ∏è –ü–û–®–ê–ì–û–í–´–ô –†–ê–ó–ë–û–† –†–ê–¶–ò–û–ù–ê
   
   **‚òÄÔ∏è –ó–ê–í–¢–†–ê–ö**
   - –ê–Ω–∞–ª–∏–∑.
   
   **üçè –í–¢–û–†–û–ô –ó–ê–í–¢–†–ê–ö**
   - –ê–Ω–∞–ª–∏–∑.
   
   **ü•ò –û–ë–ï–î**
   - –ê–Ω–∞–ª–∏–∑ (–§—É–Ω–¥–∞–º–µ–Ω—Ç!).
   
   **‚è∞ –ü–û–õ–î–ù–ò–ö: "–ó–û–õ–û–¢–û–ô –ß–ê–°" (16:00)**
   - –ê–Ω–∞–ª–∏–∑ + **Detox Gentle**.

   **üåô –£–ñ–ò–ù**
   - –ê–Ω–∞–ª–∏–∑.
   - **–í–´–ë–ï–†–ò–¢–ï –û–î–ò–ù –ò–ó –í–ê–†–ò–ê–ù–¢–û–í:**
     - **üê¢ –í–ê–†–ò–ê–ù–¢ 1: –û–±—ã—á–Ω–∞—è –µ–¥–∞**
       (–ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ä–µ—Ü–µ–ø—Ç).
     
     *--- –ò–õ–ò ---*
     
     - **üöÄ –í–ê–†–ò–ê–ù–¢ 2: –ü—Ä–æ–¥—É–∫—Ç—ã Best&People**
       (–†–µ—à–µ–Ω–∏–µ).

### 3. üß¨ –§–ò–ó–ò–û–õ–û–ì–ò–Ø
   - ${gallbladderCondition}
   - –ü—Ä–æ –±–µ–ª–æ–∫.

### 4. ‚ú® –ú–û–¢–ò–í–ê–¶–ò–Ø
   - –ö—Ä–∞—Ç–∫–æ.

=== –ó–ê–ü–†–ï–¢–´ (–ö–†–ò–¢–ò–ß–ù–û) ===
- **–ó–ê–ü–†–ï–©–ï–ù–û –°–û–ö–†–ê–©–ê–¢–¨ –ù–ê–ó–í–ê–ù–ò–Ø –ü–†–û–î–£–ö–¢–û–í.**
- –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –ø–∏—à–∏ "–ê–ª–æ—ç", "–®–µ–π–ø", "–î—Ä–∞–π–Ω", "–î–µ—Ç–æ–∫—Å", "–ß–∞–π".
- –ü–ò–®–ò –¢–û–õ–¨–ö–û –ü–û–õ–ù–û–°–¢–¨–Æ:
  - **Aloe Vera Smart Food**
  - **Shape Smart Food**
  - **Detox Gentle**
  - **Herbal Mix Smart Food**
  - **Drain Smart Food**
  - **Best Protein**
  - **–ü—é—Ä–µ Re:Balance**
- –ó–ê–ü–†–ï–©–ï–ù–û –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å \`####\`.
- –ó–ê–ü–†–ï–©–ï–ù–û —Å–º–µ—à–∏–≤–∞—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç—ã 1 –∏ 2. –î–æ–ª–∂–Ω–æ –±—ã—Ç—å –≤–∏–¥–Ω–æ "–ò–õ–ò".
`;
}

// --- 3. –û–°–ù–û–í–ù–û–ô –û–ë–†–ê–ë–û–¢–ß–ò–ö ---

export default async function handler(req, res) {
    res.setHeader('Access-Control-Allow-Origin', '*');
    res.setHeader('Access-Control-Allow-Methods', 'POST, OPTIONS');
    res.setHeader('Access-Control-Allow-Headers', 'Content-Type');

    if (req.method === 'OPTIONS') {
        res.status(200).end();
        return;
    }

    try {
        if (req.method !== 'POST') {
            return res.status(405).json({ error: 'Only POST' });
        }

        const apiKey = process.env.GEMINI_API_KEY;
        if (!apiKey) throw new Error('–ù–µ—Ç GEMINI_API_KEY');

        const genAI = new GoogleGenerativeAI(apiKey);
        const model = genAI.getGenerativeModel({ model: "gemini-2.5-flash" });

        const body = req.body;

        // =========================================================
        // –°–¶–ï–ù–ê–†–ò–ô 1: –ê–ù–ê–õ–ò–ó –§–û–¢–û (–ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô –ü–†–û–ú–ü–¢: –°–¢–†–û–ì–û –ù–ê 100–≥)
        // =========================================================
        if (body.type === 'image_analysis' && body.image) {
            
            const imagePart = {
                inlineData: {
                    data: body.image,
                    mimeType: "image/jpeg",
                },
            };

            const photoPrompt = `
            –¢—ã ‚Äî –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –¥–∏–µ—Ç–æ–ª–æ–≥ –∏ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –∫–∞–ª–æ—Ä–∏–π.
            –ü–æ—Å–º–æ—Ç—Ä–∏ –Ω–∞ —Ñ–æ—Ç–æ.
            
            –ò–ù–°–¢–†–£–ö–¶–ò–Ø –ü–û –ê–ù–ê–õ–ò–ó–£:
            1. –ï—Å–ª–∏ –Ω–∞ —Ñ–æ—Ç–æ –≤–∏–¥–Ω–∞ –£–ü–ê–ö–û–í–ö–ê –∏–ª–∏ –≠–¢–ò–ö–ï–¢–ö–ê —Å —Ç–µ–∫—Å—Ç–æ–º - –ü–†–ò–û–†–ò–¢–ï–¢–ù–û –ø—Ä–æ—á–∏—Ç–∞–π –¥–∞–Ω–Ω—ã–µ –ö–ë–ñ–£ —Å –Ω–µ—ë (–Ω–∞ 100–≥).
            2. –ï—Å–ª–∏ —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ –±–ª—é–¥–æ - –æ–ø—Ä–µ–¥–µ–ª–∏ –µ–≥–æ —Å–æ—Å—Ç–∞–≤.
            
            –ì–õ–ê–í–ù–ê–Ø –ó–ê–î–ê–ß–ê:
            –†–∞—Å—Å—á–∏—Ç–∞–π/–ù–∞–π–¥–∏ –ö–ë–ñ–£ (–ö–∞–ª–æ—Ä–∏–∏, –ë–µ–ª–∫–∏, –ñ–∏—Ä—ã, –£–≥–ª–µ–≤–æ–¥—ã), –ö–ª–µ—Ç—á–∞—Ç–∫—É –∏ –ì–ò –°–¢–†–û–ì–û –ù–ê 100 –ì–†–ê–ú–ú –ü–†–û–î–£–ö–¢–ê.
            
            –í–ù–ò–ú–ê–ù–ò–ï! –ù–µ —Å—á–∏—Ç–∞–π –∫–∞–ª–æ—Ä–∏–π–Ω–æ—Å—Ç—å –≤—Å–µ–π –ø–æ—Ä—Ü–∏–∏ –Ω–∞ —Ç–∞—Ä–µ–ª–∫–µ! –ú–Ω–µ –Ω—É–∂–Ω—ã —É–¥–µ–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –Ω–∞ 100–≥.
            
            –í–µ—Ä–Ω–∏ –æ—Ç–≤–µ—Ç –°–¢–†–û–ì–û –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON (–±–µ–∑ markdown):
            {
                "name": "–ù–∞–∑–≤–∞–Ω–∏–µ –±–ª—é–¥–∞ (–∫—Ä–∞—Ç–∫–æ)",
                "calories": 0, // –Ω–∞ 100–≥
                "proteins": 0.0, // –Ω–∞ 100–≥
                "fats": 0.0, // –Ω–∞ 100–≥
                "carbs": 0.0, // –Ω–∞ 100–≥
                "fiber": 0.0, // –Ω–∞ 100–≥ (–ø—Ä–∏–º–µ—Ä–Ω–æ, –µ—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö)
                "gi": 0 // –≥–ª–∏–∫–µ–º–∏—á–µ—Å–∫–∏–π –∏–Ω–¥–µ–∫—Å
            }
            –ï—Å–ª–∏ –ø—Ä–æ–¥—É–∫—Ç –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω, –≤–µ—Ä–Ω–∏ JSON —Å name: "–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å".
            `;

            // –í—ã–∑—ã–≤–∞–µ–º Gemini
            const jsonText = await callGeminiWithRetry(model, photoPrompt, 3, imagePart);
            
            // –ß–∏—Å—Ç–∏–º –æ—Ç–≤–µ—Ç
            const cleanJson = jsonText.replace(/```json|```/g, '').trim();
            
            res.status(200).json({ text: cleanJson });
            return;
        }

        // =========================================================
        // –°–¶–ï–ù–ê–†–ò–ô 2: –ê–ù–ê–õ–ò–ó –†–ê–¶–ò–û–ù–ê (–í–ê–® –°–¢–ê–†–´–ô –ö–û–î)
        // =========================================================
        if (body.dailyFact && body.goal) {
            const userData = body;
            const goalTitle = getGoalTitle(userData.goal);

            const mandatoryOpening = `üëã **–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é! –ù–∞ —Å–≤—è–∑–∏ –ê–Ω–¥—Ä–µ–π –°–æ–ª–¥–∞—Ç–µ–Ω–∫–æ.**\n\n–Ø –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–ª –í–∞—à —Ä–∞—Ü–∏–æ–Ω —Å —É—á–µ—Ç–æ–º –í–∞—à–µ–π —Ü–µ–ª–∏: **${goalTitle}**.\n–î–∞–≤–∞–π—Ç–µ –ø–æ—Å–º–æ—Ç—Ä–∏–º, –∫–∞–∫ –í–∞—à –æ—Ä–≥–∞–Ω–∏–∑–º —Ä–µ–∞–≥–∏—Ä—É–µ—Ç –Ω–∞ —Ç–æ —Ç–æ–ø–ª–∏–≤–æ, –∫–æ—Ç–æ—Ä–æ–µ –í—ã –µ–º—É –¥–∞–µ—Ç–µ üîã.`;

            const disclaimerBlock = `\n\n------------------\n‚ö†Ô∏è **–í–ê–ñ–ù–û–ï –ü–†–ò–ú–ï–ß–ê–ù–ò–ï:**\n–î–∞–Ω–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –æ—Å–Ω–æ–≤–∞–Ω—ã –Ω–∞ –∞–Ω–∞–ª–∏–∑–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö –í–∞–º–∏ —Ü–∏—Ñ—Ä –∏ –º–æ–µ–º –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–º –æ–ø—ã—Ç–µ. –û–Ω–∏ –Ω–æ—Å—è—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä.\n–í—ã –ø—Ä–∏–Ω–∏–º–∞–µ—Ç–µ –Ω–∞ —Å–µ–±—è –ø–æ–ª–Ω—É—é –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å –∑–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —ç—Ç–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.\n–ï—Å–ª–∏ —É –í–∞—Å –∏–º–µ—é—Ç—Å—è —Ö—Ä–æ–Ω–∏—á–µ—Å–∫–∏–µ –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏—è –∏–ª–∏ –í—ã –ø—Ä–∏–Ω–∏–º–∞–µ—Ç–µ –ª–µ–∫–∞—Ä—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø—Ä–µ–ø–∞—Ä–∞—Ç—ã, –ø–µ—Ä–µ–¥ –ª—é–±—ã–º–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏ –≤ —Ä–∞—Ü–∏–æ–Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è —Å –í–∞—à–∏–º –ª–µ—á–∞—â–∏–º –≤—Ä–∞—á–æ–º.`;

            const analysisPrompt = buildAnalysisPrompt(userData);
            
            const aiText = await callGeminiWithRetry(model, analysisPrompt, 6);

            const fullText = mandatoryOpening + "\n\n" + aiText.trim() + disclaimerBlock;

            res.status(200).json({ text: fullText });
            return;
        }

        res.status(400).json({ error: '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∏–ª–∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç' });

    } catch (error) {
        console.error('Server Error:', error.message);
        res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ' + error.message });
    }
}
