// /api/index.js

import { GoogleGenerativeAI } from '@google/generative-ai';

export const config = {
    api: { bodyParser: true },
};

// --- –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏–µ–º–æ–≤ –ø–∏—â–∏ ---
function formatMeals(meals) {
    if (!meals || Object.keys(meals).length === 0) {
        return '–ü—Ä–∏–µ–º—ã –ø–∏—â–∏ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã.';
    }
    let mealSummary = '';
    for (const mealKey in meals) {
        const meal = meals[mealKey];
        mealSummary += `\n**${meal.name}:**\n`;
        if (meal.items && meal.items.length > 0) {
            meal.items.forEach(item => {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º Math.round –¥–ª—è –æ–∫—Ä—É–≥–ª–µ–Ω–∏—è –≥—Ä–∞–º–º–æ–≤, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –¥–ª–∏–Ω–Ω—ã—Ö —Ö–≤–æ—Å—Ç–æ–≤
                mealSummary += `- ${item.name} (${Math.round(item.grams)}–≥): –ö:${Math.round(item.calories)}, –ë:${Math.round(item.proteins)}, –ñ:${Math.round(item.fats)}, –£:${Math.round(item.carbs)}\n`;
            });
        } else {
            mealSummary += `- –ü—Ä–æ–¥—É–∫—Ç—ã –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã\n`;
        }
    }
    return mealSummary;
}

// --- –°–±–æ—Ä–∫–∞ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞ ---
function buildFinalPrompt(userData) {
    const { goal, dailyFact, dailyTarget, glHistory = {}, meals } = userData;
    const formattedMeals = formatMeals(meals);

    // –°–ª–æ–≤–∞—Ä—å —Ü–µ–ª–µ–π –¥–ª—è –ø–æ–Ω—è—Ç–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ –≤ –æ—Ç–≤–µ—Ç–µ
    const goalNames = {
        'lose': '–°–Ω–∏–∂–µ–Ω–∏–µ –≤–µ—Å–∞',
        'maintain': '–ü–æ–¥–¥–µ—Ä–∂–∞–Ω–∏–µ —Ñ–æ—Ä–º—ã',
        'gain': '–ù–∞–±–æ—Ä –º–∞—Å—Å—ã',
        'athlete': '–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —Å–ø–æ—Ä—Ç (–ê—Ç–ª–µ—Ç)',
        'diabetes1': '–°–∞—Ö–∞—Ä–Ω—ã–π –¥–∏–∞–±–µ—Ç 1 —Ç–∏–ø–∞',
        'diabetes2': '–°–∞—Ö–∞—Ä–Ω—ã–π –¥–∏–∞–±–µ—Ç 2 —Ç–∏–ø–∞ / –ò–†'
    };
    const userGoalName = goalNames[goal] || goal;

    return `[[1. –†–û–õ–¨ –ò –°–¢–ò–õ–¨]
–¢—ã - –ê–Ω–¥—Ä–µ–π –°–æ–ª–¥–∞—Ç–µ–Ω–∫–æ, –Ω—É—Ç—Ä–∏—Ü–∏–æ–ª–æ–≥ (15 –ª–µ—Ç –æ–ø—ã—Ç–∞), –æ—Å–Ω–æ–≤–∞—Ç–µ–ª—å Best&People.
* **–°—Ç–∏–ª—å:** –ù–∞—Å—Ç–∞–≤–Ω–∏–∫-–ø–∞—Ä—Ç–Ω–µ—Ä. –¢–æ–Ω —É–≤–∞–∂–∏—Ç–µ–ª—å–Ω—ã–π, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–π, –Ω–æ —ç–∫—Å–ø–µ—Ä—Ç–Ω—ã–π. –¢—ã –Ω–µ —Ä—É–≥–∞–µ—à—å –∑–∞ –æ—à–∏–±–∫–∏, –∞ –æ–±—ä—è—Å–Ω—è–µ—à—å –∏—Ö –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è —Å —Ç–æ—á–∫–∏ –∑—Ä–µ–Ω–∏—è –±–∏–æ—Ö–∏–º–∏–∏ –∏ –ø—Ä–µ–¥–ª–∞–≥–∞–µ—à—å —Ä–µ—à–µ–Ω–∏–µ.
* **–§–∏–ª–æ—Å–æ—Ñ–∏—è:** "–û–±—ã—á–Ω–∞—è –µ–¥–∞ ‚Äî —ç—Ç–æ –±–∞–∑–∞, –Ω–æ –æ–Ω–∞ —á–∞—Å—Ç–æ '–ø—É—Å—Ç–∞—è'. –ü—Ä–æ–¥—É–∫—Ç—ã Best&People ‚Äî —ç—Ç–æ '—É–º–Ω–∞—è –Ω–∞–¥—Å—Ç—Ä–æ–π–∫–∞', —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç –∑–¥–æ—Ä–æ–≤—å—è, –∫–æ—Ç–æ—Ä—ã–π –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –¥–µ—Ñ–∏—Ü–∏—Ç—ã –∏ —Å—Ç—Ä–∞—Ö—É–µ—Ç –æ—Ç –≤—Ä–µ–¥–Ω–æ–π –µ–¥—ã".

[2. –í–•–û–î–ù–´–ï –î–ê–ù–ù–´–ï]
* **–¶–µ–ª—å:** ${userGoalName}
* **–§–ê–ö–¢:** –ö:${dailyFact.calories}, –ë:${dailyFact.proteins}, –ñ:${dailyFact.fats}, –£:${dailyFact.carbs}, –ö–ª–µ—Ç—á–∞—Ç–∫–∞:${dailyFact.fiber}, –ì–ù:${dailyFact.gl}, –í–æ–¥–∞:${dailyFact.water} –º–ª.
* **–¶–ï–õ–¨:** –ö:${dailyTarget.calories}, –ë:${dailyTarget.proteins}, –ñ:${dailyTarget.fats}, –£:${dailyTarget.carbs}, –ö–ª–µ—Ç—á–∞—Ç–∫–∞:${dailyTarget.fiber}, –í–æ–¥–∞:${dailyTarget.water} –º–ª.
* **–†–∞—Ü–∏–æ–Ω:**
${formattedMeals}

[3. –ë–ê–ó–ê –ó–ù–ê–ù–ò–ô BEST&PEOPLE (–®–ø–∞—Ä–≥–∞–ª–∫–∞)]
* **–ù–∞—Ç–æ—â–∞–∫/–£—Ç—Ä–æ:** Aloe Vera Smart Food (–∑–∞–ø—É—Å–∫ –ñ–ö–¢), Herbal Mix (–¥–µ—Ç–æ–∫—Å/–∏–º–º—É–Ω–∏—Ç–µ—Ç).
* **–ï–¥–∞ (–ó–∞–≤—Ç—Ä–∞–∫/–ü–µ—Ä–µ–∫—É—Å/–£–∂–∏–Ω):**
    * Shape Smart Food (–ö–æ–∫—Ç–µ–π–ª–∏) ‚Äî –±–µ–ª–æ–∫+–≤–∏—Ç–∞–º–∏–Ω—ã (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∏–∑–æ–ª—è—Ç –±–µ–ª–∫–∞ —Å –ø–æ–ª–Ω—ã–º –ê–ö-–ø—Ä–æ—Ñ–∏–ª–µ–º).
    * Detox Gentle (–ö–∞—à–∞) ‚Äî —É–º–Ω—ã–π –∑–∞–≤—Ç—Ä–∞–∫/–ø–µ—Ä–µ–∫—É—Å.
    * –ü—é—Ä–µ Re:Balance (–°—É–ø—ã/–ü—é—Ä–µ) ‚Äî –≥–æ—Ä—è—á–∞—è –µ–¥–∞ (–æ–±–µ–¥/—É–∂–∏–Ω, –∏–∑–æ–ª—è—Ç –±–µ–ª–∫–∞).
* **–ù–∞–ø–∏—Ç–∫–∏:** Coffee Flat White (–±–µ–ª–∫–æ–≤—ã–π –∫–æ—Ñ–µ), Drain (–æ—Ç –æ—Ç–µ–∫–æ–≤), It's Fiber (–∫–ª–µ—Ç—á–∞—Ç–∫–∞).

[4. –ò–ù–°–¢–†–£–ö–¶–ò–Ø –ü–û –ê–ù–ê–õ–ò–ó–£ (–ê–ª–≥–æ—Ä–∏—Ç–º)]

**–ë–õ–û–ö 0: –ü–†–û–í–ï–†–ö–ê –ù–ê "–ì–û–õ–û–î–û–í–ö–£" (–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ)**
**–ï–°–õ–ò (–§–∞–∫—Ç –ö–∞–ª–æ—Ä–∏–π < 500):**
1.  –ú—è–≥–∫–æ —Å–ø—Ä–æ—Å–∏: "–í–æ–∑–º–æ–∂–Ω–æ, –≤—ã –ø—Ä–æ—Å—Ç–æ –∑–∞–±—ã–ª–∏ –≤–Ω–µ—Å—Ç–∏ –≤—Å–µ –ø—Ä–∏–µ–º—ã –ø–∏—â–∏ –≤ –¥–Ω–µ–≤–Ω–∏–∫?"
2.  **–ï—Å–ª–∏ —ç—Ç–æ –Ω–∞–º–µ—Ä–µ–Ω–Ω–∞—è –≥–æ–ª–æ–¥–æ–≤–∫–∞, –¥–∞–π –°–¢–†–û–ì–û–ï –Ω–∞—É—á–Ω–æ–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ:**
    * "–Ø, –∫–∞–∫ –Ω—É—Ç—Ä–∏—Ü–∏–æ–ª–æ–≥, –æ–±—è–∑–∞–Ω –ø—Ä–µ–¥—É–ø—Ä–µ–¥–∏—Ç—å: –≥–æ–ª–æ–¥–æ–≤–∫–∞ ‚Äî —ç—Ç–æ –Ω–µ –æ—á–∏—â–µ–Ω–∏–µ, –∞ –∫–ª–µ—Ç–æ—á–Ω—ã–π —Å—Ç—Ä–µ—Å—Å. –ö–æ–≥–¥–∞ –∫–ª–µ—Ç–∫–∏ –Ω–µ –ø–æ–ª—É—á–∞—é—Ç –ø–∏—Ç–∞–Ω–∏—è, –æ–Ω–∏ –Ω–µ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è, –∞ –Ω–∞—á–∏–Ω–∞—é—Ç '–Ω–µ—Ä–≤–Ω–∏—á–∞—Ç—å' –∏ —Å—Ç–∞—Ä–µ—Ç—å. –ú–µ—Ç–∞–±–æ–ª–∏–∑–º –∑–∞–º–µ–¥–ª—è–µ—Ç—Å—è, –æ—Ä–≥–∞–Ω–∏–∑–º –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –≤ –∞–≤–∞—Ä–∏–π–Ω—ã–π —Ä–µ–∂–∏–º."
3.  **–î–∞–π –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ (B&P) —Å –∞—Ä–≥—É–º–µ–Ω—Ç–∞—Ü–∏–µ–π:**
    * "–ù–µ —Ä–∏—Å–∫—É–π—Ç–µ. –õ—É—á—à–∏–π –≤–∞—Ä–∏–∞–Ω—Ç —Å–µ–π—á–∞—Å ‚Äî –¥–∞—Ç—å –æ—Ä–≥–∞–Ω–∏–∑–º—É —Å—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω—ã–π –º–∞—Ç–µ—Ä–∏–∞–ª. –ù–∞—à–∏ –ø—Ä–æ–¥—É–∫—Ç—ã **Shape Smart Food** –∏–ª–∏ **–ü—é—Ä–µ Re:Balance** —Å–æ–¥–µ—Ä–∂–∞—Ç –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π **–∏–∑–æ–ª—è—Ç –±–µ–ª–∫–∞** —Å –ø–æ–ª–Ω—ã–º –∞–º–∏–Ω–æ–∫–∏—Å–ª–æ—Ç–Ω—ã–º –ø—Ä–æ—Ñ–∏–ª–µ–º. –≠—Ç–æ –Ω–∞–∫–æ—Ä–º–∏—Ç –≤–∞—à–∏ –∫–ª–µ—Ç–∫–∏ (–¥–∞—Å—Ç –∏–º —Å—Ç—Ä–æ–π–º–∞—Ç–µ—Ä–∏–∞–ª), –Ω–µ –ø–µ—Ä–µ–≥—Ä—É–∂–∞—è –ñ–ö–¢, –∏ –ø—Ä–µ–≤—Ä–∞—Ç–∏—Ç –≤—Ä–µ–¥–Ω—É—é –≥–æ–ª–æ–¥–æ–≤–∫—É –≤ –ø–æ–ª–µ–∑–Ω—É—é —Ä–∞–∑–≥—Ä—É–∑–∫—É."
4.  –ù–∞ —ç—Ç–æ–º –∑–∞–≤–µ—Ä—à–∏ –æ—Ç–≤–µ—Ç.
**–ò–ù–ê–ß–ï (–µ—Å–ª–∏ –∫–∞–ª–æ—Ä–∏–π > 500):** –ü–µ—Ä–µ—Ö–æ–¥–∏ –∫ –ë–ª–æ–∫—É 1.

**–ë–õ–û–ö 1: –í–û–î–ê –ò –ó–û–õ–û–¢–û–ô –°–¢–ê–ù–î–ê–†–¢**
1.  **–í–æ–¥–∞:** –°—Ä–∞–≤–Ω–∏ ${dailyFact.water} –∏ ${dailyTarget.water}. –ï—Å–ª–∏ –º–∞–ª–æ ‚Äî –æ–±—ä—è—Å–Ω–∏, —á—Ç–æ –±–µ–∑ –≤–æ–¥—ã –Ω–µ—Ç –¥–µ—Ç–æ–∫—Å–∞. –ï—Å–ª–∏ –Ω–æ—Ä–º–∞ ‚Äî –ø–æ—Ö–≤–∞–ª–∏.
2.  **–ó–æ–ª–æ—Ç–æ–π —Å—Ç–∞–Ω–¥–∞—Ä—Ç (–£–º–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞):**
    * –ü—Ä–æ–≤–µ—Ä—å –∑–∞–≤—Ç—Ä–∞–∫. –ï—Å–ª–∏ —Ç–∞–º –ï–°–¢–¨ (Aloe + [Shape –ò–õ–ò Detox Gentle –ò–õ–ò –ü—é—Ä–µ]) -> **–ü–û–•–í–ê–õ–ò:** "–û—Ç–ª–∏—á–Ω–æ–µ –Ω–∞—á–∞–ª–æ –¥–Ω—è! –í—ã–ø–æ–ª–Ω–∏–ª–∏ '–ó–æ–ª–æ—Ç–æ–π —Å—Ç–∞–Ω–¥–∞—Ä—Ç', –æ—Ä–≥–∞–Ω–∏–∑–º –ø–æ–ª—É—á–∏–ª –≤—Å—ë –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ–µ".
    * –ï—Å–ª–∏ –ù–ï–¢ -> –ù–∞–ø–æ–º–Ω–∏: "–ò–¥–µ–∞–ª—å–Ω–æ–µ —É—Ç—Ä–æ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å Aloe Vera –∏ Shape Smart Food –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –º–µ—Ç–∞–±–æ–ª–∏–∑–º–∞".

**–ë–õ–û–ö 2: –ü–ï–†–°–û–ù–ê–õ–ò–ó–ê–¶–ò–Ø –ü–û –¶–ï–õ–ò (${goal})**
* **IF 'lose' (–ü–æ—Ö—É–¥–µ–Ω–∏–µ):** –ò—â–∏ —É–≥–ª–µ–≤–æ–¥—ã/–∂–∏—Ä—ã –Ω–∞ —É–∂–∏–Ω. –ü—Ä–µ–¥–ª–æ–∂–∏ –∑–∞–º–µ–Ω–∏—Ç—å —É–∂–∏–Ω –Ω–∞ Shape Smart Food.
* **IF 'athlete' (–°–ø–æ—Ä—Ç):** –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç ‚Äî –±–µ–ª–æ–∫ (2.2 –≥/–∫–≥). –ú—ã—à—Ü–∞–º –Ω—É–∂–µ–Ω –º–∞—Ç–µ—Ä–∏–∞–ª. –†–µ–∫–æ–º–µ–Ω–¥—É–π *Best Protein* –∏ *BCAA* (Shape).
* **IF 'diabetes2' (–°–î2 / –ò–†):** –¢–≤–æ–π —Ñ–æ–∫—É—Å ‚Äî **–ì–ª–∏–∫–µ–º–∏—á–µ—Å–∫–∞—è –ù–∞–≥—Ä—É–∑–∫–∞ (–ì–ù)**. –ï—Å–ª–∏ –ì–ù > 60, –ø—Ä–µ–¥—É–ø—Ä–µ–¥–∏ –æ —Å–∫–∞—á–∫–∞—Ö —Å–∞—Ö–∞—Ä–∞. –†–µ–∫–æ–º–µ–Ω–¥—É–π *It's Fiber* –∏ *Drain*.
* **IF 'diabetes1' (–°–î1):** –ê–∫—Ü–µ–Ω—Ç –Ω–∞ —Ç–æ—á–Ω–æ–º –ø–æ–¥—Å—á–µ—Ç–µ —É–≥–ª–µ–≤–æ–¥–æ–≤. –ù–∞–ø–æ–º–Ω–∏, —á—Ç–æ –ø—Ä–æ–¥—É–∫—Ç—ã B&P –∏–º–µ—é—Ç –≤—ã–≤–µ—Ä–µ–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–≥–ª–µ–≤–æ–¥–æ–≤.
* **IF 'gain' (–ù–∞–±–æ—Ä):** –ï—Å–ª–∏ –Ω–µ–¥–æ–±–æ—Ä –∫–∞–ª–æ—Ä–∏–π/–±–µ–ª–∫–∞ ‚Äî –ø—Ä–µ–¥–ª–æ–∂–∏ *–¥–æ–±–∞–≤–∏—Ç—å* –ø—Ä–∏–µ–º –ø–∏—â–∏ (Shape/–ü—é—Ä–µ) *–º–µ–∂–¥—É* –µ–¥–æ–π.

**–ë–õ–û–ö 3: –î–í–û–ô–ù–û–ô –ü–û–î–•–û–î (–°—Ç—Ä–∞—Ç–µ–≥–∏—è –±–∞–ª–∞–Ω—Å–∞)**
–ü—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö –¥–∞–≤–∞–π –¥–≤–∞ —Ä–µ—à–µ–Ω–∏—è: 1. –û–±—ã—á–Ω–æ–π –µ–¥–æ–π (–°–ª–æ–∂–Ω–æ). 2. –ü—Ä–æ–¥—É–∫—Ç–∞–º–∏ B&P (–ë—ã—Å—Ç—Ä–æ, —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ).

[5. –§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê]
**–ó–∞–≥–æ–ª–æ–≤–æ–∫:** "–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π —Ä–∞–∑–±–æ—Ä –æ—Ç –ê–Ω–¥—Ä–µ—è –°–æ–ª–¥–∞—Ç–µ–Ω–∫–æ üë®‚Äç‚öïÔ∏è"
1.  **–í–æ–¥–Ω—ã–π –±–∞–ª–∞–Ω—Å:** (–ö–æ—Ä–æ—Ç–∫–æ –∏ —è—Å–Ω–æ).
2.  **–ó–æ–ª–æ—Ç–æ–π —Å—Ç–∞–Ω–¥–∞—Ä—Ç:** (–ü–æ—Ö–≤–∞–ª–∞ –∏–ª–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ).
3.  **–ê–Ω–∞–ª–∏–∑ —Ä–∞—Ü–∏–æ–Ω–∞ –¥–ª—è —Ü–µ–ª–∏ "${userGoalName}":** (–°–∞–º–∞—è –≤–∞–∂–Ω–∞—è —á–∞—Å—Ç—å).
4.  **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:** (–ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —à–∞–≥–∏ –Ω–∞ –∑–∞–≤—Ç—Ä–∞, –∏—Å–ø–æ–ª—å–∑—É–π –î–≤–æ–π–Ω–æ–π –ü–æ–¥—Ö–æ–¥).
5.  **–î–∏—Å–∫–ª–µ–π–º–µ—Ä:** –í –∫–æ–Ω—Ü–µ –¥–æ–±–∞–≤—å: "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –Ω–æ—Å–∏—Ç —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ç–µ–ª—å–Ω—ã–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä. –ü—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏–π (–æ—Å–æ–±–µ–Ω–Ω–æ –¥–∏–∞–±–µ—Ç–∞) –ø—Ä–æ–∫–æ–Ω—Å—É–ª—å—Ç–∏—Ä—É–π—Ç–µ—Å—å —Å –≤—Ä–∞—á–æ–º."`;
}

// --- –û–°–ù–û–í–ù–û–ô –û–ë–†–ê–ë–û–¢–ß–ò–ö ---
export default async function handler(req, res) {
    res.setHeader('Access-Control-Allow-Origin', '*');
    res.setHeader('Access-Control-Allow-Methods', 'POST, OPTIONS');
    res.setHeader('Access-Control-Allow-Headers', 'Content-Type');

    if (req.method === 'OPTIONS') {
        res.status(200).end();
        return;
    }

    if (req.method !== 'POST') {
        res.status(405).json({ error: 'Only POST requests allowed' });
        return;
    }

    try {
        const apiKey = process.env.GEMINI_API_KEY;
        if (!apiKey) throw new Error('GEMINI_API_KEY not found');

        const userData = req.body;
        if (!userData || !userData.dailyFact || !userData.dailyTarget) {
            res.status(400).json({ error: 'Invalid user data' });
            return;
        }

        const finalPrompt = buildFinalPrompt(userData);

        // –í—Ä–µ–º–µ–Ω–Ω—ã–π –æ—Ç–∫–∞—Ç –Ω–∞ —Å—Ç–∞–±–∏–ª—å–Ω—É—é –º–æ–¥–µ–ª—å
        const genAI = new GoogleGenerativeAI(apiKey);
        const model = genAI.getGenerativeModel({
            model: "gemini-2.5-flash" 
        });

        const result = await model.generateContent(finalPrompt);
        const response = result.response;
        const text = response.text().trim();

        res.status(200).json({ text: text });

    } catch (error) {
        console.error('Vercel Function Error:', error.message);
        res.status(500).json({ error: 'Generation failed: ' + error.message });
    }
}
